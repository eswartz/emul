*** nforth.tsm
90                            	incl	general.i
*** general.i
25                                #if ENHANCED_MEMORY
26    >FF80                   VDPRD   equ >FF80
27    >FF82                   VDPST   equ >FF82
28    >FF88                   VDPWD   equ >FF88
29    >FF8A                   VDPWA   equ >FF8A
30    >FF8C                   VDPCL   equ >FF8C
31    >FF8E                   VDPWI   equ >FF8E
32    >FF90                   GPLRD   equ >FF90
33    >FF92                   GPLRA   equ >FF92
34    >FF94                   GPLWD   equ >FF94
35    >FF96                   GPLWA   equ >FF96
36    >FF98                   SPCHRD  equ >FF98
37    >FF9A                   SPCHWT  equ >FF9A
38    >FFA0                   SOUND   equ >FFA0   ; 0x20!
39    >FFC0                   ROMBANK equ >FFC0
40    >FFC2                   FTHBANK equ >FFC2
41                                #else
61    >0001                   SR0	equ	1
62    >0002                   SR1	equ	2
63    >0004                   SR2	equ	4
64    >0008                   SR3	equ	8
65    >0010                   SR4	equ	16
66    >0020                   SR5	equ	32
67    >0040                   SR6	equ	64
68    >0080                   SR7	equ	128
69    >0100                   SR8	equ	256
70    >0200                   SR9	equ	512
71    >0400                   SR10	equ	1024
72    >0800                   SR11	equ	2048
73    >1000                   SR12	equ	4096
74    >2000                   SR13	equ	8192
75    >4000                   SR14	equ	16384
76    >8000                   SR15	equ	32768
82    >0001                   ST_L	equ	1
83    >0002                   ST_A	equ	2
84    >0004                   ST_E	equ	4
85    >0008                   ST_C	equ	8
86    >0010                   ST_OV	equ	16
87    >0020                   ST_OP	equ	32
88    >0040                   ST_X	equ	64
95    >0000                   grom_kbdlist		equ	>0000
96    >0130                   grom_font8x8		equ	>0130
97    >0930                   grom_font5x6		equ >0930
100   >000A                   SP	equ		10
102                            define Push SP, ... [
108                            define Pop SP, ... [
114                            define Vector label, ws [
*** nforth.tsm
91                            	incl	ram.i
*** ram.i
25                            	incl	cpuram.i
*** cpuram.i
28                             #if ENHANCED_MEMORY
30    >FC00                   mainws  equ >FC00       ; main FORTH/system workspace
31    >FC20                   dskws   equ >FC20       ; disk workspace
32    >FC40                   intws   equ >FC40       ; interrupt workspace
33    >FC40                   xopws   equ >FC40       ; XOP workspace (shared, ints off)
34    >FC60                   vidws   equ >FC60       ; video & term workspace   ; shared by interrupts!
36    >FB00                   cpurambase equ >FB00    ; CPU RAM base for DSRs
37    >FF60                   sharedvarbase equ >FF60 ; where vars shared with FORTH are seen
38    >F700                   privvarbase equ >F700   ; where ROM private vars are stored
40                             #else
60    >FB70                       aorg    cpurambase + >70
61    >FB70                   vdplimit    bss 2       ; VDP memory size (this points to a location offset from V9938 bank 3 (>C000))
66    >FB40                       aorg    cpurambase + >40
68    >0001                   int1flag    equ >1
69    >0002                   int2flag    equ >2
70    >0004                   xop1flag    equ >4
72    >FB40                   intsfromA   bss 2
77    >FF60                       aorg    sharedvarbase
78                             
81    >FF60                   vintflags   bss 1       ; VDP interrupt flags
82    >0080                   nvblnk      equ >80     ;       1: suppress blink cursor and blank screen
83    >0040                   nvkeyscan   equ >40     ;       1: suppress scan keyboard
84    >0020                   nvsprmot    equ >20     ;       1: suppress sprite motion
85    >0010                   nsoundlist  equ >10     ;       1: suppress sound list
87    >FF61                   vstatus     bss 1       ; VDP status last read during interrupt
89    >FF62                   userint     bss 2       ; user VDP interrupt handler (called when VDP interrupts)
90    >FF64                   timerisr    bss 2       ; user timer handler (called when clock ticks)
92    >FF66                   nsprmot     bss 1       ; number of sprites in motion (00 = none)
94    >FF67                   sndflags    bss 1       ; sound list flags
95                                                    ;       $00: CPU RAM, $80: VDP 
96                                                    ;       $0f: tempo adjust (signed: -4 to 3) 
97    >FF68                   sndlist     bss 2       ; address of classic sound list (0 = none), incremented on tick
98    >FF6A                   snddur      bss 1       ; duration of current group
100   >FF6C                           even
101                                   
103   >FF6C                   _CPURAMSTART equ $
105   >FF6C                   vpob        bss 1       ; VDP "page offset" bank (added to V9938 bank to select the page outside 64k)
106   >FF6D                   vblinkflag  bss 1       ; flag to set blink bit in text2 
107   >FF6E                   vpgrow      bss 2       ; VDP "page row offset" (added to V9938 commands to select the page)
108   >FF70                   vtextpage   bss 2       ; VDP text-ish page offset (screen, patterns, colors) (in addition to vpob)
110   >FF72                   vidvarstart bss 2       ; start addr of important video variables
111   >FF74                   vidvarsize  bss 2       ; size of important video variables
113   >000A                   _CPURAMSIZE  equ $ - _CPURAMSTART
*** ram.i
30                             #if ENHANCED_MEMORY
31    >F700                       aorg    privvarbase      
32                             #else
35                                 
36    >0040                   vstacksize equ  >40
37    >F700                   vstack  bss vstacksize      ; video stack is stored here for speed in slow-mode
39                             #if ENHANCED_MEMORY
40                                ; keep going
41                             #else
44                             
45    >F740                   sysstack bss    >40         ; system stack
46    >0040                   sysstacksize equ $ - sysstack
48    >F780                   _RAMSTART equ $ 
50    >F780                   uptime	bss	4			; time in 1/60 seconds
51    >F784                   timeout	bss	2			; timeout counter
53    >F786                   _VIDVARSTART equ $
55    >F786                   vscreen	bss	2			; VDP addr of screen
56    >F788                   vscreensz	bss	2			; VDP size of screen table
57    >F78A                   vpatts	bss	2			; VDP addr of patterns
58    >F78C                   vpattsz	bss	2			; VDP size of pattern table
59    >F78E                   vcolors bss	2			; VDP addr of colors
60    >F790                   vcolorsz bss	2			; VDP size of color table
61    >F792                   vsprites bss	2			; VDP addr of sprites
62    >F794                   vsprcol bss 2           ; VDP addr of sprite color table (0 if not sprite 2 mode)
63    >F796                   vsprpat bss	2			; VDP addr of sprite patterns
64    >F798                   vsprmot	bss	2			; VDP addr of sprite motion
65    >F79A                   vfree	bss	2			; usable space
67    >F79C                   vdrawchar bss	2			; draw char in window (BLWP @)
68    >F79E                   vscroll	bss	2			; scroll window up a line (BLWP @)
69    >F7A0                   vclearline	bss	2			; clear line (BL @)  [R0=window coord, R2=length; preserve 0, 3]
71    >F7A2                   vbsize	bss	2			; bitmapped font size (x/y)
73    >F7A4                   vcoordaddr bss	2			; get SIT addr of R0 coord   [R0=window coord => R0=addr, R1=shift; 
74                                                        ;                               preserve R2]
76    >F7A6                   vcrstimer bss	1			; timer for blink
77    >F7A7                   vcrsblink bss	1			; limit in 1/60 s
78    >F7A8                   vcursor	bss	2			; cursor blinker (BLWP @)
79    >F7AA                   vcurs	bss	1			; cursor blink state (0 or >80)
81    >F7AB                   vcursunder bss	8	   	; char or bits under cursor
83    >F7B3                   vheight bss 1           ; phys screen height in chars
84    >F7B4                   vwidth  bss 2           ; phys screen width in chars
85    >F7B6                       even
86                                
87    >F7B6                   vbit4stride bss 2        ; row stride  
88    >F7B8                   vbit4shift bss 2        ; shift for column # to byte
89    >F7BA                   vbit4mask bss 2        ;  mask for column # to byte portion
91    >F7BC                   vfont	bss	2			; GROM font addr
95    >F7BE                   vfgbg	bss	2			; foreground|background color
96    >F7C0                   vch	bss	1			; current char
98    >F7C1                   vcurschar bss	1			; char of cursor
100   >F7C2                   vwx	bss	1			; window left
101   >F7C3                   vwy	bss	1			; window right
102   >F7C4                   vwxs	bss	1			; width of window
103   >F7C5                   vwys	bss	1			; height of window
104   >F7C6                   vwcy	bss	1			; last cleared row
106   >F7C7                   vmode	bss	1         ; last set video mode (not M_xxx)
108   >F7C8                       even
109   >F7C8                   vtermptr bss 2          ; pointer to standard term stuff for mode
110                               
111   >F7CA                   vx	bss	1			; x-coord of cursor in window
112   >F7CB                   vy	bss	1			; y-coord of cursor in window
114   >F7CC                   vmono	bss	1
115   >F7CD                   vidmode	bss	1			; what mode are we in?  (M_xxxx)
117   >0000                   M_text	equ	0
118   >0001                   M_graph	equ	1
119   >0002                   M_multi equ 2
120   >0003                   M_bit	equ	3			; both mono and color
121   >0004                   M_bit4	equ	4			; new bitmap modes
122   >0005                   M_text2 equ 5           ; 80-column
124   >F7CE                   vscrnx  bss 2           ; res x
125   >F7D0                   vscrny  bss 2           ; res y
127   >F7D2                   vlinex	bss	2
128   >F7D4                   vliney	bss	2
130   >F7D6                   savedvregs bss 16       ; first 16 VRs set via vwreg
131   >F7D7                   vregr1    equ savedvregs + 1           ; VDP register 1
133   >0060                   _VIDVARSIZE  equ $ - _VIDVARSTART
135   >F7E6                   vbitbuf bss 256         ; buffer for bitmap font manip
139   >F8E6                   kbdlast bss 1           ; last char pressed (or 0)
140   >F8E7                   kbdtimer bss    1           ; timer (1/60 s) since last repeat
142   >F8E8                   kbdscan bss 1           ; most recent scancode     (0-47)
143   >F8E9                   kbdshft bss 1           ; most recent shift status (>70)
145   >F8EA                   kbdhead bss 1           ; head of kbd buffer
146   >F8EB                   kbdtail bss 1           ; tail of kbd buffer  
147                                               ; head==tail => empty
149   >0020                   kbdbufsize equ  32
150   >F8EC                   kbdbuf  bss kbdbufsize          
152   >F90C                   kbdlimit bss    1           ; 1/60s before repeating
153   >F90D                   kbddelay bss    1           ; delay between keyscans
155   >F90E                   kbdflag bss 1           ; keyboard state
156                                                   ; | >80 = currently repeating bit
157                                                   
158   >F910                       even
160   >F910                   randnoise bss 2			; random noise
161   >F912                   randseed1 bss 2			; random seed (lfsr)
162   >F914                   randseed2 bss 2			; random seed
166   >0020                   dskstacksize 	equ	>20
167   >F916                   dskstack bss	dskstacksize
169   >F936                   forthdsk bss	10			; filename for FORTH disk
175   >0000                   pv_clock    equ 0           ; the clock for the voice (done when > 64k)
176   >0002                   pv_incr     equ 2           ; the increment per clock (0 = owned by other voice)
177   >0004                   pv_hertz    equ 4           ; the frequency of the voice
178   >0006                   pv_track    equ 6           ; the global track owning this voice (addr)
179   >0008                   pv_port     equ 8           ; the sound port
180   >000A                   pv_freqmask equ 10          ; sound command frequency mask for the voice
181   >000B                   pv_volmask  equ 11          ; sound command volume mask for the voice
182   >000C                   pv_size     equ 12
186   >0010                   NUMVOICES   equ 16
187   >F940                   voices      bss pv_size * NUMVOICES   ; 4 sets of 3 tones + 1 noise
188   >FA00                   VOICES_END equ $
192   >0000                   lt_cmdptr   equ 0           ; pointer to next command (start of lump)
193   >0002                   lt_clock    equ 2           ; accumulator timing til next lump (when > 64k)
194   >0004                   lt_incr     equ 4           ; clock increment for lump length
195   >0006                   lt_tempoincr equ 6          ; increment for current tempo
196   >0008                   lt_a_d      equ 8           ; attack, decay (byte)
197   >0009                   lt_h_r      equ 9           ; hold, release (byte)
198   >000A                   lt_volume   equ 10          ; current volume (byte)
199   >000B                   lt_sustain  equ 11          ; sustain ratio (when adhr != 0)
200   >000C                   lt_vibrato  equ 12          ; vibrato 
201   >000D                   lt_tremolo  equ 13          ; tremolo 
202   >000E                   lt_waveform equ 14          ; waveform 
203   >000F                   lt_balance  equ 15          ; balance
204   >0010                   lt_size     equ 16
208   >0008                   NUMTRACKS   equ 8
209   >FA00                   tracks      bss lt_size * NUMTRACKS
210   >FA80                   TRACKS_END  equ $
214   >0004                   MAXTRACKSPERSONG equ 4 
216   >0000                   ls_phrase   equ 0          ; pointer to current phrase
217   >0002                   ls_phrases  equ 2           ; ptr in zero-terminated array of phrases 
218   >0004                   ls_tracks   equ 4           ; map of logical tracks to global tracks
219   >0008                   ls_size     equ 4 + MAXTRACKSPERSONG
223   >0004                   NUMSONGS    equ 4
224   >FA80                   songs       bss ls_size * NUMSONGS
225   >FAA0                   SONGS_END   equ $
227   >FAA0                   _RAMEND     equ   $
229                            
*** nforth.tsm
97    >0000                   	aorg	>0
99    >0000                   resetv	dw	mainws,INT0PC		; vector for RESET
      >0000=>FC00 >000E       
100   >0004                   int1v	dw	intws,INT1PC		; vector for INTERRUPTS
      >0004=>FC40 >0018       
104   >000C                   	aorg	>c
106   >000C=>30AA             	db		>30,>AA				; flag bytes for normal ROM
108   >000E                   INT0PC:
109   >000E=>06A0 >004A       	bl		@bankA
110   >0012=>0000             	data	0
111   >0014=>0460 >292C       	b		@reset
113   >0018                   INT1PC:	
114   >0018=>0300 >0000       	limi	0
115   >001C=>06A0 >004A       	bl		@bankA
116   >0020=>0001             	data	int1flag
117   >0022=>0460 >0276       	b		@int1
119   >0026                   XOP1PC:
120   >0026=>0300 >0000       	limi	0
121   >002A=>C07E             	mov		*14+,1				; code
122   >002C=>C00B             	mov		11,0
123   >002E=>06A0 >004A       	bl		@bankA
124   >0032=>0004             	data	xop1flag
125   >0034=>C2C0             	mov		0,11
126   >0036=>0460 >00CA       	b		@xop1_real
128   >0040                   	aorg 	>40
130   >0040                   xop0v	dw 0,0
      >0040=>0000 >0000       
131   >0044                   xop1v	dw	xopws,XOP1PC			; vector for XOP 1
      >0044=>FC40 >0026       
133   >0048=>0000             	data	0					; forth_start
136   >004A                   bankA:
137   >004A=>E83B >FB40       	soc		*11+,@intsfromA
138   >004E=>0720 >FFC0       	seto	@ROMBANK
139   >0052=>045B             	rt
140   >0054                   bankB:
141   >0054=>0720 >FFC2       	seto	@FTHBANK
142   >0058=>045B             	rt
144   >005A                   bankBrtwp:
145   >005A=>06A0 >0054       	bl		@bankB
146   >005E=>0380             	rtwp
148   >0060                   FORTH_COLD:
149   >0060=>06A0 >0054       	bl		@bankB
150   >0064=>1000             	nop
151   >0066=>1000             	nop
153   >0068                   FORTH_QUIT:
154   >0068=>06A0 >0054       	bl		@bankB
155   >006C=>1000             	nop
156   >006E=>1000             	nop
159   >0070                   ABORT:
160   >0070=>0300 >0000           limi    0
161   >0074=>0720 >FB40           seto    @intsfromA
163   >0078=>02E0 >FC00           lwpi    mainws
164   >007C=>10F5                 jmp     FORTH_QUIT         ; ctrl+fctn+shift+space breaks
165                               
166   >007E                   COMMON_END:
168   >007E                   bankrtwp:
169   >007E=>C020 >FB40       	mov		@intsfromA,0
170   >0082=>203B             	coc		*11+,0
171   >0084=>16EA             	jne		bankBrtwp
172   >0086=>0380             	rtwp
209   >0088                   xop1list dw	xop1_restore_mode,xop1_key_avail,xop1_read_key,xop1_emit,xop1_emit_raw
      >0088=>00EA >00F0 >0108 
      >008E=>0110 >011A       
210   >0092=>0122 >012A >0130 	dw		xop1_gotoxy,xop1_clear_window,xop1_set_window,xop1_get_window,xop1_set_mode
      >0098=>013C >0146       
211   >009C=>014E >0156 >015C 	dw		xop1_set_fgbg,xop1_get_fgbg,xop1_draw_line,xop1_draw_pixel,xop1_reset_screen
      >00A2=>0162 >0168       
212   >00A6=>0172 >017E >0186 	dw		xop1_set_vintflags,xop1_set_font,xop1_fill_rect,xop1_random,xop1_dsrlnk
      >00AC=>018C >0194       
213   >00B0=>019E >01A8 >01B4 	dw      xop1_get_vtab,xop1_set_vdpreg,xop1_get_vdpreg,xop1_set_vrwpage,xop1_set_vpage
      >00B6=>01BE >01C6       
214   >00BA=>01CE >01D4 >01E2 	dw      xop1_reset_palette,xop1_video_state,xop1_get_text_addr,xop1_get_xy,xop1_type
      >00C0=>01F2 >01F8       
215   >00C4=>0202 >0208 >0210 	dw      xop1_rw_block,xop1_qtrack,xop1_draw_circle
216   >00CA                   xop1last equ $
222   >00CA                   xop1_real:
223   >00CA=>C2AD >0014       	mov @SP+SP(13), SP			; stack ptr
224   >00CE=>064A             	dect SP
225   >00D0=>C68C             	mov 12 , *SP
226   >00D2=>C30B             	mov 11 , 12				; copy op ptr
228   >00D4=>0281 >0021       	ci	1,(xop1last - xop1list) / 2
229   >00D8=>1204             	jle	xop1_pick
230   >00DA                   xop1_out
231   >00DA=>C33A             	mov *SP+, 12
232   >00DC=>06A0 >007E       	bl	@bankrtwp
233   >00E0=>0004             	data	xop1flag
235   >00E2                   xop1_pick
236   >00E2=>A041             	a	1,1
237   >00E4=>C061 >0088       	mov	@xop1list(1),1
238   >00E8=>0451             	b	*1
240                               ;   0 = restore video mode (minimal)
241   >00EA                   xop1_restore_mode
242   >00EA=>06A0 >04A4       	bl @vrestoremode
243   >00EE=>10F5             	jmp xop1_out
244                           	
245                           	;	1 = keyavail?
246   >00F0                   xop1_key_avail 
247   >00F0=>02E0 >FC60           lwpi    vidws
248   >00F4=>06A0 >18BA           bl  @scankbd
249   >00F8=>02E0 >FC40           lwpi    xopws
250   >00FC=>06A0 >1A12       	bl	@kbdavail
251   >0100=>04DC             	clr	*12
252   >0102=>1301             	jeq xop1_1_out
253   >0104=>071C             	seto *12
254   >0106                   xop1_1_out
255   >0106=>10E9             	jmp xop1_out
257                           	;	2 = readkey
258   >0108                   xop1_read_key	
259   >0108=>06A0 >1A1A       	bl	@kbdread
261   >010C=>C700             	mov	0,*12
262   >010E=>10E5             	jmp xop1_out
264                           	;	3 = emit (interpreted)
265   >0110                   xop1_emit
266   >0110=>D06C >0001       	movb   @1(12),1
267   >0114=>06A0 >1C54       	bl     @emit
268   >0118=>10E0             	jmp    xop1_out
270                           	;	4 = emit, not interpreted
271   >011A                   xop1_emit_raw
272   >011A=>C05C             	mov    *12,1
273   >011C=>06A0 >1AA8       	bl	    @printchar
274   >0120=>10DC             	jmp    xop1_out
276                           	; 	5 = gotoxy
277   >0122                   xop1_gotoxy
278   >0122=>C01C             	mov *12,0		; hi=x, lo=y
279   >0124=>06A0 >1AD2       	bl @gotoxy
280   >0128=>10D8             	jmp xop1_out
282                           	;	6 = cls (window)
283   >012A                   xop1_clear_window
284   >012A=>06A0 >1B32           bl @termclear
285   >012E=>10D5             	jmp xop1_out
287                           	;	7 = text window
288                           	;	
289   >0130                   xop1_set_window
290   >0130=>C01C             	mov *12, 0
291   >0132=>C06C >0002       	mov @2(12), 1
292   >0136=>06A0 >1A54       	bl @window
293   >013A=>10CF             	jmp xop1_out
295                           	;	8 = report text window
296   >013C                   xop1_get_window
297   >013C=>CF20 >F7C2       	mov @vwx, *12+
298   >0140=>CF20 >F7C4       	mov @vwxs, *12+
299   >0144=>10CA             	jmp xop1_out
301                           	;	9 = graphics mode (ONLY)
302   >0146                   xop1_set_mode
303   >0146=>C05C             	mov *12, 1
304   >0148=>0420 >0750       	blwp @vsetmode
305   >014C=>10C6             	jmp xop1_out
307                           	;	10 = set colors
308   >014E                   xop1_set_fgbg:
309   >014E=>C01C             	mov *12, 0
310   >0150=>06A0 >036C       	bl @vsetcolor
311   >0154=>10C2             	jmp xop1_out
313                           	;	11 = get colors
314   >0156                   xop1_get_fgbg:
315   >0156=>C720 >F7BE       	mov @vfgbg, *12
316   >015A=>10BF             	jmp xop1_out
318                           	;	12 = draw line
319   >015C                   xop1_draw_line:
320   >015C=>0420 >0B70       	blwp @line
321   >0160=>10BC             	jmp xop1_out
323                           	;	13 = draw pixel
324   >0162                   xop1_draw_pixel:
325   >0162=>0420 >0A72       	blwp @pixel
326   >0166=>10B9             	jmp xop1_out
328                           	;	14 = reset video screen
329   >0168                   xop1_reset_screen:
330   >0168=>06A0 >0898           bl  @vreset
331   >016C=>06A0 >04EC           bl  @vscreenon
332   >0170=>10B4             	jmp xop1_out
334                           	;	15 = set video int flags (see vintflags)
335   >0172                   xop1_set_vintflags:
336                               ; ensure cursor is erased (usually indicates we're drawing)
337   >0172=>06A0 >0A5C           bl     @vcursoroff
338   >0176=>D82C >0001 >FF60 	movb   @1(12), @vintflags
339   >017C=>10AE             	jmp    xop1_out
341                           	;	16 = set font
342   >017E                   xop1_set_font:
343   >017E=>C05C             	mov *12, 1
344   >0180=>06A0 >09DE       	bl @vsetfont
345   >0184=>10AA             	jmp xop1_out
347                           	;	17 = draw filled rect
348   >0186                   xop1_fill_rect:
349   >0186=>0420 >0AF6       	blwp @fillrect
350   >018A=>10A7             	jmp	xop1_out
352                           	;	18 = generate pseudorandom number
353   >018C                   xop1_random:
354   >018C=>06A0 >021A       	bl @random
355   >0190=>C700             	mov 0, *12
356   >0192=>10A3             	jmp xop1_out
358                           	;	19 = DSRLNK
359   >0194                   xop1_dsrlnk:
360   >0194=>C05C             	mov *12, 1
361   >0196=>0420 >1E04       	blwp @dsrlnk
362   >019A=>C700             	mov 0, *12
363   >019C=>109E             	jmp xop1_out
365                               ;   20 = get video table ( # -- addr )
366   >019E                   xop1_get_vtab:
367   >019E=>C05C                 mov *12, 1
368   >01A0=>06A0 >07B0           bl @vgettab
369   >01A4=>C700                 mov 0, *12
370   >01A6=>1037                 jmp xop1_out2
372                               ;   21 = set VDP reg ( newval index -- )
373   >01A8                   xop1_set_vdpreg:
374   >01A8=>C03C                 mov *12+, 0
375   >01AA=>0A80                 sla 0, 8
376   >01AC=>E01C                 soc *12, 0
377   >01AE=>06A0 >046E           bl @vwreg
378   >01B2=>1031                 jmp xop1_out2
380                               ;   22 = get VDP reg ( index -- val )
381   >01B4                   xop1_get_vdpreg:
382   >01B4=>C05C                 mov *12, 1
383   >01B6=>06A0 >049C           bl @vrreg    
384   >01BA=>C701                 mov 1, *12
385   >01BC=>102C                 jmp xop1_out2
387                               ;   23 = set r/w video page ( 0|1|2|3 -- val )
388   >01BE                   xop1_set_vrwpage:
389   >01BE=>C05C                 mov *12, 1
390   >01C0=>06A0 >03B4           bl @vrwpage
391   >01C4=>1028                 jmp xop1_out2
392                               
393                               ;   24 = set visible video page ( 0|1|2|3 -- val )
394   >01C6                   xop1_set_vpage:
395   >01C6=>C05C                 mov *12, 1
396   >01C8=>06A0 >03EC           bl @vpage
397   >01CC=>1024                 jmp xop1_out2
399                               ;   25 = reset palette
400   >01CE                   xop1_reset_palette:
401   >01CE=>06A0 >15F8           bl      @vsetpalette
402   >01D2=>1021                 jmp     xop1_out2
403                              
404                               ;   26 = save/restore/query video state   ( ... req -- ... )
405   >01D4                   xop1_video_state:
406   >01D4=>C05C                 mov     *12, 1
407   >01D6=>C0AC >0002           mov     @2(12), 2  ; if used
408   >01DA=>06A0 >097A           bl      @vsaverestore
409   >01DE=>C701                 mov     1, *12
410   >01E0=>101A                 jmp     xop1_out2
412                               ;   27 = get address of X/Y in window   ( x|y -- addr shift )
413   >01E2                   xop1_get_text_addr:
414   >01E2=>C01C                 mov     *12, 0
415   >01E4=>C060 >F7A4           mov     @vcoordaddr, 1
416   >01E8=>0691                 bl      *1
417   >01EA=>C700                 mov     0, *12
418   >01EC=>CB01 >0002           mov     1, @2(12)
419   >01F0=>1012                 jmp     xop1_out2
420                              
421                              ;    28 = get X/Y coords ( -- x|y )
422   >01F2                   xop1_get_xy:
423   >01F2=>C720 >F7CA           mov     @vx, *12
424   >01F6=>100F                 jmp     xop1_out2
425                              
426                              ;    29 = type (interpreted) ( caddr u -- )
427   >01F8                   xop1_type:
428   >01F8=>C0BC                 mov     *12+, 2
429   >01FA=>C0DC                 mov     *12, 3
430   >01FC=>06A0 >1C78           bl      @type
431   >0200=>100A                 jmp     xop1_out2
432                                  
433                               ;   30 = read/write disk block ( block# addr r/w -- err )
434   >0202                   xop1_rw_block:
435   >0202=>0420 >1F24           blwp @rwblock
436   >0206=>1007                 jmp xop1_out2
438                               ;   31 = queue sound track ( track -- )
439   >0208                   xop1_qtrack:
440   >0208=>C09C                 mov     *12, 2
441   >020A=>06A0 >2506           bl      @xsnd_queue_track
442   >020E=>1003                 jmp     xop1_out2
444                           	;	32 = draw circle
445   >0210                   xop1_draw_circle:
446   >0210=>0420 >0BC6       	blwp @circle
447   >0214=>1000             	jmp xop1_out2
449                               
450   >0216                   xop1_out2:
451   >0216=>0460 >00DA           b   @xop1_out
452   >021A                   random:
453   >021A=>C020 >F912       	mov    @randseed1, 0
454   >021E=>C040             	mov    0, 1
455   >0220=>0910             	srl    0, 1
456   >0222=>0241 >0001       	andi   1, 1
457   >0226=>0501             	neg    1
458   >0228=>0241 >B400       	andi   1, >B400
459   >022C=>2801             	xor    1, 0
460   >022E=>C800 >F912       	mov    0, @randseed1
462   >0232=>0202 >6FE5       	li     2, >6fe5
463   >0236=>38A0 >F914       	mpy    @randseed2, 2
464   >023A=>0225 >7AB9       	ai     5, >7ab9
465   >023E=>C805 >F914       	mov    5, @randseed2
467   >0242=>A020 >F780       	a	   @uptime, 0
468   >0246=>0B05             	src    5, 0
469   >0248=>2805             	xor    5, 0
470   >024A=>2820 >F910       	xor    @randnoise, 0
471   >024E=>045B             	rt
477   >0250                   clr mov     *11+, 0
      >0250=>C03B             
478   >0252=>C07B                 mov     *11+, 1
479   >0254                   $1: clr     *0+
      >0254=>04F0             
480   >0256=>0641                 dect    1
481   >0258=>15FD                 jgt     $1-
482   >025A=>045B                 rt
483                               
484   >025C                   sinit	
485   >025C=>020A >F780       	li SP,sysstack + sysstacksize
486                           	
487                           	; setup NMI interrupt
488   >0260=>C820 >29AC >FFFC 	mov    #intws, @>fffc
489   >0266=>C820 >29AE >FFFE 	mov    #abort, @>fffe
491   >026C=>0200 >ACE1       	li     0, >ACE1
492   >0270=>C800 >F912       	mov    0,@randseed1
493                           	
494                               ;   reset clears all memory
495                           	;clr	   @uptime
496                           	;clr	   @uptime + 2
497                           	;clr	   @timeout
498                           	;clr	   @userint
499                           	;clr    @randseed2
500                           	;clr    @randnoise
502   >0274=>045B             	rt
505                           	incl	int.i
*** int.i
31    >0276                   int1 limi	0			; disable interrupts 
      >0276=>0300 >0000       
33    >027A=>04CC             	clr		r12			; point to 9901
34    >027C=>1F02             	tb		2			; VDP interrupt?
35    >027E=>160D             	jne		intvdp		; yup.
37    >0280=>1F03                 tb      3           ; timer interrupt?
38    >0282=>1306                 jeq     $1+         ; nope, must be device
40    >0284=>1D03                 sbo     3           ; acknowledge
41                                
42    >0286=>C0E0 >FF64           mov     @timerisr, 3 ; does user hook the timer?
43    >028A=>1302                 jeq     $1+
44                                
45    >028C=>0693                 bl      *3          ; call user handler
46    >028E=>1046                 jmp     int1out
48    >0290                   $1:     
49                                ; device interrupt (some other bit)
50                                  	
51    >0290=>02E0 >83E0       	lwpi	>83e0		; they require this...
52    >0294=>02E0 >FC40       	lwpi	intws
53    >0298=>1041             	jmp		int1out		; don't handle device interrupts yet
55    >029A                   intvdp:
56    >029A=>1D02             	sbo	    2			; acknowledge VDP interrupt
57    >029C=>D0E0 >FF82           movb    @VDPST, 3   ; acknowledge #2
58                                
59    >02A0=>05A0 >F782       	inc		@uptime + 2	; time in 1/60 seconds
60    >02A4=>1702             	jnc		intv00		; overflow?
61    >02A6=>05A0 >F780          	inc		@uptime	 	; more time accuracy
63    >02AA                   intv00:	
64    >02AA=>D0E0 >FF60           movb    @vintflags,3    ; check our commands
65    >02AE=>0A13                 sla     3,1             ; suppress blinking/blanking?
66    >02B0=>1810                 joc     intv01
68                                ; ----------------------- blink/blank
69                                    
70    >02B2=>05E0 >F784       	inct	@timeout	    ; blank screen?
71    >02B6=>1602             	jne		intv00b
73    >02B8=>06A0 >04E4       	bl     	@vscreenoff 
75    >02BC                   intv00b:
76    >02BC=>0200 >F7A6       	li		0,vcrstimer
77    >02C0=>B420 >01BB       	ab		#1,*0			; cursor timer
78    >02C4=>9810 >F7A7       	cb		*0,@vcrsblink	; to blink or not to blink?
79    >02C8=>1A04             	jl		intv01
81    >02CA=>7410             	sb		*0,*0			; clear
82    >02CC=>C020 >F7A8       	mov		@vcursor,0		; get ptr
83    >02D0=>0410             	blwp	*0				; blink it
85    >02D2                   intv01:
86    >02D2=>0A13                 sla     3,1             ; suppress keyboard scan?
87    >02D4=>1805                 joc     intv02
89                                ; ----------------------- keyboard scan
90                                
91    >02D6=>B820 >01BB >F8E7     ab      #1,@kbdtimer    ; inc repeat delay
92    >02DC=>06A0 >18BA           bl      @scankbd        ; get keyboard, save char       TRASHES REGS
94    >02E0                   intv02:
95    >02E0=>D0E0 >FF60           movb    @vintflags, 3   ; kbd trashed, so reread
96    >02E4=>0A33                 sla     3,3
97    >02E6=>1808                 joc     intv03          ; suppress sprite motion?
98                                
99    >02E8=>C020 >F798           mov     @vsprmot, 0
100   >02EC=>1305                 jeq     intv03          ; skip if no sprite motion table
101                               
102   >02EE=>D020 >FF66           movb    @nsprmot, 0     ; or no sprites
103   >02F2=>1302                 jeq     intv03
104                               
105   >02F4=>0420 >0CA8           blwp    @vspritemotion
106                               
107   >02F8                   intv03:
108   >02F8=>0A13                 sla     3,1
109   >02FA=>1805                 joc     intv04          ; sound list?
111                               ; ------------------------ play sound list
112                               
113   >02FC=>C020 >FF68           mov     @sndlist, 0
114   >0300=>1302                 jeq     intv04
115                               
116   >0302=>0420 >208C           blwp    @soundlist
117                               
118   >0306                   intv04:    
119   >0306=>0420 >24F8          blwp    @sound_sequencer
120                               
121                               ; ----------------------- user interrupt?
122                               
123   >030A=>C020 >FF62       	mov		@userint,0		
124   >030E=>1303             	jeq		intv05
126   >0310=>0690             	bl		*0				; execute user interrupt routine
127   >0312=>02E0 >FC40       	lwpi	intws
129   >0316                   intv05:
130                               ;movb    #>00, @VDPWA    ; point to SR0     ; the client must guarantee this
131                               ;movb    #>8f, @VDPWA
132   >0316=>D820 >FF82 >FF61 	movb	@VDPST, @vstatus ; clear interrupt
134   >031C                   int1out:
136   >031C=>06A0 >007E       	bl		@bankrtwp
137   >0320=>0001             	data	int1flag
139   >0322                   int2
140   >0322=>06A0 >007E       	bl		@bankrtwp
141   >0326=>0002             	data	int2flag
*** nforth.tsm
507                           	incl	video.i
*** video.i
30    >0328                   h08	byte	8
      >0328=>08             
31    >0329                   hunder	byte	"_"
      >0329=>5F             
32    >032A                   h07	data	7
      >032A=>0007             
33    >032C                   	even
38    >032C                   vinit	  PUSH    SP, 0, 11
*** <expansion of push>
1     >032C=>022A >FFFC           ai SP, -2*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0330=>CA80 >0002               mov  0 , @(2-0-1)*2(SP)
2     >0334=>C68B                     mov  11, @(2-1-1)*2(SP)
*** video.i
39                            	
40    >0336=>C820 >29B0 >FF72 	mov    #_VIDVARSTART, @vidvarstart
41    >033C=>C820 >29B2 >FF74 	mov    #_VIDVARSIZE, @vidvarsize
43    >0342=>0200 >000F       	li	   0,15
44    >0346=>C800 >F7A6       	mov	   0,@vcrstimer			 ; set up standard blink
45                            	;sb	   @vcurs,@vcurs		 ; it's off
47    >034A=>0201 >0107       	li	   1,>0107
48    >034E=>C801 >F7BE       	mov	   1,@vfgbg
50    >0352=>C820 >29B4 >F7A2     mov    #>808, @vbsize          ; set in case we lazily switch to bitmap mode
52    >0358=>04C1                 clr     1
53    >035A=>0420 >0750       	blwp   @vsetmode
54    >035E=>06A0 >0898       	bl     @vreset
55                            	;bl    @vrestoremode
56    >0362=>06A0 >04EC       	bl     @vscreenon
58                            	POP    SP, 0, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0366=>C2FA                     mov *SP+,  11
2     >0368=>C03A                     mov *SP+,  0 
*** video.i
59    >036A=>045B             	rt
62    >036C                   vsetcolor
63    >036C=>064A             	dect   SP
64    >036E=>C68B             	mov    11, *SP
65    >0370=>C800 >F7BE       	mov    0, @vfgbg
66                            	
67    >0374=>9820 >0019 >F7CD 	cb     #M_text,@vidmode
68    >037A=>1304             	jeq    vsetcolor1
69    >037C=>9820 >0226 >F7CD 	cb     #M_text2,@vidmode
70    >0382=>1608             	jne    vsetcolor0
72    >0384                   vsetcolor1:
73    >0384=>06A0 >039C           bl     @vgetcolorbyte
74    >0388=>06C0                 swpb   0
75    >038A=>0260 >0700       	ori    0,>700
76    >038E=>06A0 >046E       	bl     @vwreg
78    >0392=>1002             	jmp    vsetcolor9
80    >0394                   vsetcolor0:
81    >0394=>06A0 >0830       	bl     @vcolorsetup
82    >0398                   vsetcolor9:
83    >0398=>C2FA             	mov    *SP+, 11
84    >039A=>045B             	rt
87    >039C                   vgetcolorbyte
88    >039C=>04C0                 clr     0
89    >039E=>D020 >F7BE           movb    @vfgbg,0
90    >03A2=>0A40                 sla     0,4
91    >03A4=>F020 >F7BF           socb    @vfgbg+1,0
92    >03A8=>045B                 rt
93                                
95    >03AA                   vgetfgcolorbyte
96    >03AA=>04C0                 clr     0
97    >03AC=>D020 >F7BE           movb    @vfgbg,0
98    >03B0=>0A40                 sla     0,4
99    >03B2=>045B                 rt
100                               
101                               
106   >03B4                   vrwpage PUSH SP,11
*** <expansion of push>
1     >03B4=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >03B6=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video.i
107   >03B8=>06A0 >0A5C           bl      @vcursoroff
108   >03BC=>C081                 mov     r1 , r2
109   >03BE=>9820 >0014 >F7CD     cb     #M_bit4, @vidmode
110   >03C4=>1309                 jeq     vrwpage0
111                               
112                               ; text/graphics mode allows page access on 0x2000 boundaries
113   >03C6=>0AD1                 sla     r1, 13
114   >03C8=>C801 >FF70           mov     r1, @vtextpage
115   >03CC=>0A72                 sla     r2, 7
116   >03CE=>0242 >0400           andi    r2, >400
117   >03D2=>D802 >FF6C           movb    r2, @vpob 
118   >03D6=>1008                 jmp     vrwpageout
119                                
120   >03D8                   vrwpage0:
121   >03D8=>0A81                 sla     r1 , 8
122   >03DA=>C801 >FF6E           mov     r1 , @vpgrow       ; page row offset is 256 * page
123                               ; the page bank offset is this page row offset times bytes-per-line divided by 16k
124   >03DE=>38A0 >F7B6           mpy     @vbit4stride , r2   ; e.g. 256 * 1 , 128 * 1 ...
125   >03E2=>0A23                 sla     r3 , 2
126   >03E4=>D803 >FF6C           movb    r3 , @vpob
127   >03E8                   vrwpageout:    
128                               POP SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >03E8=>C2FA                     mov *SP+,  11
*** video.i
129   >03EA=>045B                 rt
130                                   
134   >03EC                   vpage PUSH SP,11
*** <expansion of push>
1     >03EC=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >03EE=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video.i
135   >03F0=>C001                 mov     r1 , r0
136   >03F2=>D2E0 >F7CD           movb    @vidmode, 11
137   >03F6=>92E0 >0014           cb     #M_bit4, 11
138   >03FA=>1320                 jeq     vpage0
139                               
140                               ; text/graphics mode allows page access on 0x2000 boundaries
141   >03FC=>0A30                 sla     0, 3
142   >03FE=>7000                 sb      0, 0
143   >0400=>92E0 >0226           cb     #M_text2, 11
144   >0404=>1303                 jeq     vpage1
145   >0406=>0260 >0200           ori     0,>200
146   >040A=>101B                 jmp     vpageout
147                               
148   >040C                   vpage1:
149                               ; V9938 needs lower bits set
150   >040C=>0260 >0203           ori     0,>203
151   >0410=>06A0 >046E           bl      @vwreg
152                               
153                               ; move color table too (A00 away from screen)
154   >0414=>C001                 mov     1, 0
155   >0416=>0240 >0001           andi    0, 1
156   >041A=>0A70                 sla     0, 7
157   >041C=>0260 >032F           ori     0,>32f
158   >0420=>06A0 >046E           bl      @vwreg
159   >0424=>C001                 mov     1, 0
160   >0426=>0910                 srl     0, 1
161   >0428=>0260 >0A00           ori     0,>A00
162   >042C=>06A0 >046E           bl      @vwreg
163                               
164                               ; and move pattern table
165   >0430=>C001                 mov     1, 0
166   >0432=>0A20                 sla     0, 2
167   >0434=>05C0                 inct    0
168   >0436=>0260 >0400           ori     0,>400
169   >043A=>1003                 jmp     vpageout
170                                
171   >043C                   vpage0:    
172   >043C=>0A50                 sla     r0 , 5
173   >043E=>0260 >821F           ori     r0 , >821f
174   >0442                   vpageout:    
175   >0442=>06A0 >046E           bl      @vwreg
176                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0446=>C2FA                     mov *SP+,  11
*** video.i
177   >0448=>045B                 rt
189   >044A                   gwaddr	movb	0,@GPLWA
      >044A=>D800 >FF96       
190   >044E=>06C0             	swpb	0
191   >0450=>D800 >FF96       	movb	0,@GPLWA
192   >0454=>06C0             	swpb	0
193   >0456=>045B             	rt
201   >0458                   vwaddr	ori	0,>4000
      >0458=>0260 >4000       
202   >045C                   vraddr
203   >045C=>06C0             	swpb	0
204   >045E=>D800 >FF8A       	movb	0,@VDPWA
205   >0462=>06C0             	swpb	0
206   >0464=>D800 >FF8A       	movb	0,@VDPWA
207   >0468=>0240 >3FFF       	andi    0,>3fff
208   >046C=>045B             	rt
209                           	
212   >046E                   vwreg   
213   >046E=>064A                 dect    SP
214   >0470=>C681                 mov     1, *SP
215   >0472=>C040                 mov     0, 1
216   >0474=>0241 >7FFF           andi    1,>7FFF
217   >0478=>0260 >8000           ori     0,>8000
218   >047C=>06C0                 swpb    0
219   >047E=>0281 >0F00           ci      1,>0F00
220   >0482=>1403                 jhe     vwreg0
221   >0484=>0981                 srl     1,8
222   >0486=>D840 >F7D6           movb    0,@savedvregs(1)
223   >048A                   vwreg0:    
224   >048A=>D800 >FF8A           movb    0,@VDPWA
225   >048E=>06C0                 swpb    0
226   >0490=>D800 >FF8A           movb    0,@VDPWA
227   >0494=>C07A                 mov     *SP+,1
228   >0496=>045B                 rt
231   >0498                   vwregnext 
232   >0498=>C03B                 mov     *11+, 0
233   >049A=>10E9                 jmp     vwreg
234                               
240   >049C                   vrreg
241   >049C=>D061 >F7D6           movb    @savedvregs(1),1
242   >04A0=>0981                 srl     1,8
243   >04A2=>045B                 rt
244                               
248   >04A4                   vrestoremode
249   >04A4=>064A                 dect SP
250   >04A6=>C68B                 mov 11,*SP
251   >04A8=>020C >FF8A           li  12,VDPWA
252   >04AC=>0201 >F7D6           li  1, savedvregs
253   >04B0=>0200 >8000           li 0, >8000
254   >04B4                   vrm0 movb *1+, *12
      >04B4=>D731             
255   >04B6=>D700                 movb 0, *12
256   >04B8=>0220 >0100           ai 0, >100
257   >04BC=>0280 >8F00           ci 0, >8F00    
258   >04C0=>16F9                 jne  vrm0
259   >04C2=>06A0 >04EC           bl @vscreenon
260   >04C6=>C2FA                 mov *SP+,11
261   >04C8=>045B                 rt
269   >04CA                   vclr	dect SP
      >04CA=>064A             
270   >04CC=>C68B             	mov	11,*SP
271   >04CE=>064A             	dect SP
272   >04D0=>C682             	mov	2,*SP
275   >04D2=>06A0 >0458       	bl	@vwaddr
276   >04D6                   vclr0	movb	1,@VDPWD
      >04D6=>D801 >FF88       
277   >04DA=>0602             	dec	2
278   >04DC=>16FC             	jne	vclr0
279                           	
280   >04DE=>C0BA             	mov	*SP+,2
281   >04E0=>C2FA             	mov	*SP+,11
282   >04E2=>045B             	rt
302   >04E4                   vscreenoff
303   >04E4=>5820 >021F >F7D7 	szcb 	#>40,@vregr1
304   >04EA=>1003             	jmp	vreg1set
305   >04EC                   vscreenon
306   >04EC=>F820 >021F >F7D7 	socb	#>40,@vregr1
307   >04F2                   vreg1set:
308   >04F2=>D820 >F7D7 >FF8A 	movb	@vregr1,@VDPWA
309   >04F8=>D820 >00D5 >FF8A 	movb	#>81,@VDPWA
310   >04FE=>045B             	rt
314   >0500                   vtmap	dw	vscreen,vscreensz,vcolors,vcolorsz,vpatts,vpattsz,vsprpat,vsprites,vsprmot,vsprcol,vfree
      >0500=>F786 >F788 >F78E 
      >0506=>F790 >F78A >F78C 
      >050C=>F796 >F792 >F798 
      >0512=>F794 >F79A       
315   >0516=>F7CE >F7D0       	dw  vscrnx,vscrny
316   >001A                   vtmapsize equ $-vtmap
323   >051A                   vtxt db 0,>0,1,>B0,2,>0,4,>1,-1
      >051A=>0000 >01B0 >0200 
      >0520=>0401 >FF       
324   >0524=>0000 >03C0 >0000     dw  >0,960,>0,>0,>800,>800,0,0,0,0,>1000
      >052A=>0000 >0800 >0800 
      >0530=>0000 >0000 >0000 
      >0536=>0000 >1000       
325   >053A=>0100 >00C0           dw 256,192
326   >053E=>093E >2818 >0329     dw vtextterms, >2818, hunder
336   >0544                   vgfx 	db	0,>0,1,>A0,2,>0,3,>E,4,>1,5,>6,6,>0,-1
      >0544=>0000 >01A0 >0200 
      >054A=>030E >0401 >0506 
      >0550=>0600 >FF       
337   >0554=>0000 >0300 >0380 	dw	>0,768,>380,>20,>800,>800,>000,>300,>3A0,0,>1000
      >055A=>0020 >0800 >0800 
      >0560=>0000 >0300 >03A0 
      >0566=>0000 >1000       
338   >056A=>0100 >00C0       	dw 256,192
339   >056E=>093E >2018 >0329 	dw vtextterms, >2018, hunder
350   >0574                   vbit db	0,>2,1,>A0,2,>6,3,>ff,4,>03,5,>36,6,>3,-1
      >0574=>0002 >01A0 >0206 
      >057A=>03FF >0403 >0536 
      >0580=>0603 >FF       
351   >0584=>1800 >0300 >2000 	dw	>1800,>300,>2000,>1800,>0000,>1800,>1800,>1b00,>1B80,0,>3800
      >058A=>1800 >0000 >1800 
      >0590=>1800 >1B00 >1B80 
      >0596=>0000 >3800       
352   >059A=>0100 >00C0           dw 256,192
353   >059E=>0946 >2018 >0738     dw vbitterms, >2018,hff
366   >05A4                   vbit3  db  0,>4,1,>A0,2,>E,3,>ff,4,>03,5,>36,>B,0,6,>3,-1
      >05A4=>0004 >01A0 >020E 
      >05AA=>03FF >0403 >0536 
      >05B0=>0B00 >0603 >FF 
367   >05B6=>3800 >0300 >2000     dw  >3800,768,>2000,>1800,>0,>1800,>1800,>1b00,>1b80,>1900,>3B00
      >05BC=>1800 >0000 >1800 
      >05C2=>1800 >1B00 >1B80 
      >05C8=>1900 >3B00       
368   >05CC=>0100 >00C0           dw 256,192
369   >05D0=>0946 >2018 >0738     dw vbitterms, >2018, hff
370                               
371                               
380   >05D6                   vbit4  db  0,>6,1,>A0,2,>0,5,>F4,>B,0,6,>E,-1
      >05D6=>0006 >01A0 >0200 
      >05DC=>05F4 >0B00 >060E 
      >05E2=>FF             
381   >05E4=>0000 >0000 >0000     dw >0000,0,>0000,>0000,>0,>6400,>7000,>7A00,>7A80,>7800,>8000
      >05EA=>0000 >0000 >6400 
      >05F0=>7000 >7A00 >7A80 
      >05F6=>7800 >8000       
382   >05FA=>0100 >00D4           dw 256,212
383   >05FE=>0080 >0001 >FFFE     dw >80, 1, >FFFE
384   >0604=>094E >201B >0738     dw vbit4terms, >201B, hff
394   >060A                   vbit5  db  0,>8,1,>A0,2,>0,5,>F4,>B,0,6,>E,7,>FF,-1
      >060A=>0008 >01A0 >0200 
      >0610=>05F4 >0B00 >060E 
      >0616=>07FF >FF       
395   >061A=>0000 >0000 >0000     dw  >0000,0,>0000,>0000,>0,>6A00,>7000,>7A00,>7A80,>7800,>8000
      >0620=>0000 >0000 >6A00 
      >0626=>7000 >7A00 >7A80 
      >062C=>7800 >8000       
396   >0630=>0200 >00D4           dw 512,212
397   >0634=>0080 >0002 >FFFC     dw >80, 2, >FFFC
398   >063A=>0956 >401B >0738     dw vbit5terms, >401B, hff
408   >0640                   vbit6  db  0,>A,1,>A0,2,>0,5,>AC,>B,>1,6,>1B,-1
      >0640=>000A >01A0 >0200 
      >0646=>05AC >0B01 >061B 
      >064C=>FF             
409   >064E=>0000 >0000 >0000     dw  >0000,0,>0000,>0000,>0,>D400,>D800,>D600,>D680,>D400,>E000
      >0654=>0000 >0000 >D400 
      >065A=>D800 >D600 >D680 
      >0660=>D400 >E000       
410   >0664=>0200 >00D4           dw 512,212
411   >0668=>0100 >0001 >FFFE     dw >100, 1, >FFFE
412   >066E=>094E >401B >0738     dw vbit4terms, >401B, hff
422   >0674                   vbit7  db  0,>E,1,>A0,2,>0,5,>AC,>B,>1,6,>1B,-1
      >0674=>000E >01A0 >0200 
      >067A=>05AC >0B01 >061B 
      >0680=>FF             
423   >0682=>0000 >0000 >0000     dw  >0000,0,>0000,>0000,>0,>D400,>D800,>D600,>D680,>D400,>E000
      >0688=>0000 >0000 >D400 
      >068E=>D800 >D600 >D680 
      >0694=>D400 >E000       
424   >0698=>0100 >00D4           dw 256,212
425   >069C=>0100 >0000 >FFFF     dw >100, 0, >FFFF
426   >06A2=>095E >201B >0738     dw vbit7terms, >201B, hff
434   >06A8                   vtxt2  db  0,>4,1,>B0,2,>0,3,>2f,>A,0,4,>2,>D,>22,-1
      >06A8=>0004 >01B0 >0200 
      >06AE=>032F >0A00 >0402 
      >06B4=>0D22 >FF       
435   >06B8=>0000 >0870 >0A00     dw  >0,2160,>A00,2160/8,>1000,>800,0,0,0,0,>1800
      >06BE=>010E >1000 >0800 
      >06C4=>0000 >0000 >0000 
      >06CA=>0000 >1800       
436   >06CE=>0200 >00D4           dw  512, 212
437   >06D2=>093E >501B >0329     dw vtextterms, >501B, hunder
438                               
448   >06D8                   vmonobit db 0,>2,1,>B0,2,>6,3,>80,4,>03,5,>36,6,>3,-1
      >06D8=>0002 >01B0 >0206 
      >06DE=>0380 >0403 >0536 
      >06E4=>0603 >FF       
449   >06E8=>1800 >0300 >2000     dw  >1800,>300,>2000,>800,>0000,>1800,>1800,>1B00,>1B80,0,>2800
      >06EE=>0800 >0000 >1800 
      >06F4=>1800 >1B00 >1B80 
      >06FA=>0000 >2800       
450   >06FE=>0100 >00C0           dw 256,192
451   >0702=>0946 >2018 >0738     dw vbitterms, >2018, hff
460   >0708                   vmulti    db  0,>0,1,>8,2,>0,3,>0,4,>1,5,>6,6,>0,-1
      >0708=>0000 >0108 >0200 
      >070E=>0300 >0401 >0506 
      >0714=>0600 >FF       
461   >0718=>0000 >0300 >0000     dw  >0,768,0,0,>800,>800,>1000,>300,>380,0,>1800
      >071E=>0000 >0800 >0800 
      >0724=>1000 >0300 >0380 
      >072A=>0000 >1800       
462   >072E=>0100 >00C0           dw 256,192
463   >0732=>0966 >2018 >0329     dw vmultiterms, >2018, hunder
464                               
466   >0738                   hff db >ff
      >0738=>FF             
467   >073A                       even
468   >073A                   vmodesetups	
469   >073A=>0D5A                 dw vtextsetup       ; 0
470   >073C=>0DA6                 dw vgraphsetup      ; 1
471   >073E=>0F1E                 dw vbitmapsetup     ; 2
472   >0740=>0F52                 dw vbitmap3setup    ; 3
473   >0742=>161C                 dw vbitmap4setup    ; 4
474   >0744=>164E                 dw vbitmap5setup    ; 5
475   >0746=>1654                 dw vbitmap6setup    ; 6
476   >0748=>165A                 dw vbitmap7setup    ; 7
477   >074A=>0D7C                 dw vtext2setup      ; 8
478   >074C=>0F46                 dw vmonosetup       ; 9
479   >074E=>0DC8                 dw vmultisetup      ; 10
484                            Vector vsetmode, vidws
*** <expansion of vector>
1     >0750                   vsetmode  data vidws, vsetmode_entry
      >0750=>FC60 >0754       
2     >0754                   vsetmode_entry:    
*** video.i
485   >0754=>020A >F740           li     SP,vstack + vstacksize 
486   >0758=>D06D >0003           movb   @3(13), 1
487   >075C=>D801 >F7C7           movb   1, @vmode
488   >0760=>0971             	srl    1, 7
489   >0762=>C061 >073A       	mov    @vmodesetups(1), 1
490   >0766=>0691             	bl     *1
492   >0768=>0380             	rtwp
495   >076A                   vsetupregs:
496   >076A=>064A                 dect SP
497   >076C=>C68B                 mov 11,*SP
498                               
499   >076E                   vts0 cb #>ff,*1
      >076E=>9460 >046B       
500   >0772=>1304                 jeq  vts1
501   >0774=>C031                 mov   *1+, 0
502   >0776=>06A0 >046E           bl  @vwreg
503   >077A=>15F9             	jgt	vts0
505   >077C                   vts1:
506   >077C=>05C1                 inct 1
508   >077E=>06A0 >039C           bl  @vgetcolorbyte
509   >0782=>06C0                 swpb 0
510   >0784=>0260 >0700           ori 0,>700
511   >0788=>06A0 >046E           bl @vwreg
513   >078C=>7820 >FF6C >FF6C     sb      @vpob, @vpob
514   >0792=>04E0 >FF6E           clr     @vpgrow
515   >0796=>04E0 >FF70           clr     @vtextpage
516                           	
517   >079A=>C2FA             	mov *SP+,11
518   >079C=>045B             	rt
521   >079E                   vsetupaddrs:
522   >079E=>0200 >0500       	li	0,vtmap
523   >07A2                   vsa1 mov *1+,3
      >07A2=>C0F1             
524   >07A4=>C130             	mov	*0+,4
525   >07A6=>C503             	mov	3,*4
526   >07A8=>0280 >051A       	ci 0,vtmap + vtmapsize
527   >07AC=>11FA             	jlt	vsa1
528   >07AE=>045B             	rt
531   >07B0                   vgettab
532   >07B0=>A041                 a 1,1
533   >07B2=>C021 >0500           mov @vtmap(1), 0
534   >07B6=>045B                 rt
535                               
536   >07B8                   vcleartables:
537   >07B8=>064A             	dect SP	
538   >07BA=>C68B             	mov 11,*SP
540                               ; don't clear patterns... font routines and/or vtermclear does that
541                               ;mov @vpatts, 0
542                               ;bl @vsetbank
543                               ;clr 1
544                               ;mov @vpattsz, 2
545                               ;bl @vclr
546   >07BC=>1002                 jmp vct0
547                               
548   >07BE                   vcleartables4x:
549   >07BE=>064A                 dect SP 
550   >07C0=>C68B                 mov 11,*SP
551   >07C2                   vct0:
552   >07C2=>06A0 >0830           bl @vcolorsetup
554   >07C6=>06A0 >15F8           bl @vsetpalette
555                               
556   >07CA                   vclrtabscr:    
557   >07CA=>C0A0 >F788           mov @vscreensz, 2
558   >07CE=>1306                 jeq vclrtabspr
559   >07D0=>C020 >F786           mov @vscreen, 0
560   >07D4=>0201 >2000           li 1,>2000
561   >07D8=>06A0 >04CA           bl @vclr
562                               
563   >07DC                   vclrtabspr:
564   >07DC=>C020 >F792       	mov	@vsprites,0
565   >07E0=>1325             	jeq vclrtabout
566                           	
567                           	; delete the sprites; $d0 for mode 1 and $d8 for mode 2
568   >07E2=>C060 >F794           mov @vsprcol, 1
569   >07E6=>1603                 jne vclrtabspr2
570   >07E8=>D060 >0110       	movb #>d0,1
571   >07EC=>100C                 jmp vclrtabsprs
572   >07EE                   vclrtabspr2:
574                               ; clear sprite color table too
575   >07EE=>C001                 mov 1, 0
576   >07F0=>04C1                 clr 1
577   >07F2=>0202 >0200           li 2,>200
578   >07F6=>06A0 >1790           bl @vsetbank
579   >07FA=>06A0 >04CA           bl @vclr
580   >07FE=>C020 >F792           mov @vsprites, 0
581   >0802=>D060 >0176       	movb #>d8,1
582   >0806                   vclrtabsprs:
583   >0806=>06A0 >1790           bl @vsetbank
584   >080A=>06A0 >0458           bl  @vwaddr    
585   >080E=>D801 >FF8A           movb 1,@VDPWA
586   >0812=>0580             	inc 0
587   >0814=>04C1             	clr	1
588   >0816=>0202 >007F       	li	2,127
589   >081A=>06A0 >04CA       	bl	@vclr
591   >081E=>C020 >F798       	mov	@vsprmot,0
592                               ;bl @vsetbank       ; it'll be in the same page
593   >0822=>04C1             	clr	1
594   >0824=>0202 >0080       	li	2,128
595   >0828=>06A0 >04CA       	bl	@vclr
597   >082C                   vclrtabout:
598   >082C=>C2FA             	mov *SP+,11
599   >082E=>045B             	rt
604   >0830                   vcolorsetup
605   >0830=>C0A0 >F790           mov @vcolorsz, 2
606   >0834=>1313                 jeq vcolorsetup0
607   >0836=>064A                 dect SP
608   >0838=>C68B                 mov 11, *SP
609   >083A=>04C1                 clr 1
610   >083C=>9820 >0226 >F7CD     cb #M_text2, @vidmode
611   >0842=>1303                 jeq vcolorsetup1
612   >0844=>06A0 >039C           bl @vgetcolorbyte
613   >0848=>D040                 movb 0,1
614   >084A                   vcolorsetup1:    
615   >084A=>C020 >F78E           mov @vcolors,0
616   >084E=>A020 >FF70           a   @vtextpage, 0
617   >0852=>06A0 >1790           bl  @vsetbank
618   >0856=>06A0 >04CA           bl  @vclr
619   >085A=>C2FA                 mov *SP+, 11
620   >085C                   vcolorsetup0:   
621   >085C=>045B                 rt
627   >085E                   vtermsetup
628                               PUSH    SP,R11
*** <expansion of push>
1     >085E=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0860=>C68B                     mov  R11, @(1-0-1)*2(SP)
*** video.i
629                               
630   >0862=>C060 >F7C8           mov     @vtermptr,1
631   >0866=>0200 >0936           li      0,vtermptrs
632   >086A=>C0F1                 mov     *1+,3
633   >086C                   vtts0:
634   >086C=>C0B0                 mov     *0+,2
635   >086E=>C4B3                 mov     *3+,*2
636   >0870=>0280 >093E           ci      0,vtermptrsend
637   >0874=>16FB                 jne     vtts0
638                               
639                               ; force window to full screen
640   >0876=>C811 >F7C4           mov     *1, @vwxs
641                               
642   >087A=>D0B1                 movb    *1+, 2
643   >087C=>0982                 srl     2,8
644   >087E=>C802 >F7B4           mov     2,@vwidth
645   >0882=>D831 >F7B3           movb    *1+, @vheight
646                               
647   >0886=>04E0 >F7C2           clr     @vwx
648   >088A=>04E0 >F7CA           clr     @vx
650                               ; get cursor char
651   >088E=>C0B1                 mov     *1+,2
652   >0890=>D812 >F7C1           movb    *2,@vcurschar
653                               
654                               POP     SP,R11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0894=>C2FA                     mov *SP+,  R11
*** video.i
655   >0896=>045B                 rt
662   >0898                   vreset
663                               PUSH SP,1,2,11    
*** <expansion of push>
1     >0898=>022A >FFFA           ai SP, -3*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >089C=>CA81 >0004               mov  1 , @(3-0-1)*2(SP)
2     >08A0=>CA82 >0002               mov  2 , @(3-1-1)*2(SP)
3     >08A4=>C68B                     mov  11, @(3-2-1)*2(SP)
*** video.i
664                               
665   >08A6=>06A0 >085E           bl @vtermsetup
666   >08AA=>06A0 >07B8           bl  @vcleartables
667                               
668   >08AE=>D060 >F7CD           movb @vidmode,1
669   >08B2=>9060 >0019           cb   #M_text,1
670   >08B6=>1309                 jeq  vresettextish
671   >08B8=>9060 >0226           cb   #M_text2,1
672   >08BC=>1306                 jeq  vresettextish
673   >08BE=>9060 >0078           cb   #M_multi,1
674   >08C2=>1304                 jeq  vresetmulti
675   >08C4=>9060 >01BB           cb   #M_graph,1
676   >08C8=>1619                 jne  vreset0
678   >08CA                   vresettextish:    
679   >08CA=>102C                 jmp     vresetout
681   >08CC                   vresetmulti:
682                               ; setup standard SIT for multi mode
683                               ; 0 1 2 3 ... 30 31  x  4
684                               ; 32 33 ... 62 63    x 4
685                               ; ... 190 191
686   >08CC=>C020 >F786           mov     @vscreen,0      ; never banked
687   >08D0=>06A0 >0458           bl      @vwaddr
688   >08D4=>04C1                 clr     1
689   >08D6                   vbs4    li  2, 4 
      >08D6=>0202 >0004       
690   >08DA                   vbs3    movb 1,@VDPWD
      >08DA=>D801 >FF88       
691   >08DE=>0221 >0100           ai      1,>0100
692   >08E2=>2460 >29B6           czc     #>1f00, 1
693   >08E6=>16F9                 jne     vbs3
694   >08E8=>0221 >E000           ai      1,->2000
695   >08EC=>0602                 dec     2
696   >08EE=>15F5                 jgt     vbs3
697   >08F0=>0221 >2000           ai      1,>2000
698   >08F4=>0281 >C000           ci      1,>C000
699   >08F8=>1AEE                 jl      vbs4
700   >08FA=>1014                 jmp     vresetout
701                               
702   >08FC                   vreset0:    
703   >08FC=>9820 >0018 >F7CD     cb      #M_bit,@vidmode
704   >0902=>160E                 jne     vreset1
705                               
706                               ; setup standard SIT for bitmap mode
707   >0904=>C020 >F786           mov     @vscreen,0      ; never banked
708   >0908=>06A0 >0458           bl      @vwaddr
709   >090C=>04C1                 clr     1
710   >090E=>0202 >0300           li      2,768
711   >0912                   vbs2    movb    1,@VDPWD
      >0912=>D801 >FF88       
712   >0916=>0221 >0100           ai      1,>100
713   >091A=>0602                 dec     2
714   >091C=>15FA                 jgt     vbs2
715                               
716   >091E=>1002                 jmp     vresetbitcommon
718   >0920                   vreset1:
719                               ; must be M_bit4
720                               
721   >0920=>06A0 >07BE           bl      @vcleartables4x
722                               
723   >0924                   vresetbitcommon:
724                                   
725   >0924                   vresetout:
726   >0924=>04C1                 clr     1
727   >0926=>06A0 >09DE           bl      @vsetfont
728   >092A=>06A0 >1B32           bl      @termclear
729                               
730                               POP     SP,1,2,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >092E=>C2FA                     mov *SP+,  11
2     >0930=>C0BA                     mov *SP+,  2 
3     >0932=>C07A                     mov *SP+,  1 
*** video.i
731   >0934=>045B                 rt
733   >0936                   vtermptrs dw vdrawchar,vclearline,vcursor,vcoordaddr
      >0936=>F79C >F7A0 >F7A8 
      >093C=>F7A4             
734   >093E                   vtermptrsend equ $
736   >093E                   vtextterms dw vtextchar,vtextclearline,vtextcursor,vtextaddr
      >093E=>0E62 >0E1E >0ED4 
      >0944=>0DD4             
737   >0946                   vbitterms dw  vbitchar,vbitclearline,vbitcursor,vbitaddr
      >0946=>1014 >0F9E >108A 
      >094C=>0F6E             
738   >094E                   vbit4terms dw  vbit4xchar,vbit4xclearline,vbit4xcursor,vbit4xaddr
      >094E=>17BA >1762 >1810 
      >0954=>1660             
739   >0956                   vbit5terms dw  vbit4xchar,vbit4xclearline,vbit4xcursor,vbit4xaddr
      >0956=>17BA >1762 >1810 
      >095C=>1660             
740   >095E                   vbit7terms dw  vbit4xchar,vbit4xclearline,vbit4xcursor,vbit4xaddr
      >095E=>17BA >1762 >1810 
      >0964=>1660             
741   >0966                   vmultiterms dw vnopchar,vnopclearline,vnopcursor,vtextaddr
      >0966=>0F18 >0F1C >0F18 
      >096C=>0DD4             
744   >096E                   vstdmode
745                               ;clr     @vpob
746                               ;clr     @vpgrow
747                               ;clr     @vtextpage
748   >096E=>04E0 >F7B6           clr     @vbit4stride
749   >0972=>0200 >0900           li      0, >900      ; 192 rows
750   >0976=>0460 >046E           b       @vwreg       
760   >CCB1                   vsaverestore_s equ >ccb1    ; mov *1+, *2+
761   >CC72                   vsaverestore_r equ >cc72    ; mov *2+, *1+
763   >097A                   vsaverestore 
764   >097A=>C041                 mov     1, 1
765   >097C=>1322                 jeq     vsvrssz
767                               PUSH    SP,11,12  
*** <expansion of push>
1     >097E=>022A >FFFC           ai SP, -2*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0982=>CA8B >0002               mov  11 , @(2-0-1)*2(SP)
2     >0986=>C68C                     mov  12, @(2-1-1)*2(SP)
*** video.i
768   >0988=>0204 >CCB1           li      4, vsaverestore_s
769   >098C=>0281 >0001           ci      1, 1
770   >0990=>1302                 jeq     vsvrsrst
771   >0992=>0204 >CC72           li      4, vsaverestore_r
772   >0996                   vsvrsrst:    
773   >0996=>0201 >FF6C           li      1, _CPURAMSTART
774   >099A=>0203 >0005           li      3, (_CPURAMSIZE+1) / 2
775   >099E                   vsvrsrst0:  x 4
      >099E=>0484             
776   >09A0=>0603                 dec     3
777   >09A2=>15FD                 jgt     vsvrsrst0
778   >09A4=>0201 >F786           li      1, _VIDVARSTART
779   >09A8=>0203 >0030           li      3, (_VIDVARSIZE+1) / 2
780   >09AC                   vsvrsrst1:  x 4
      >09AC=>0484             
781   >09AE=>0603                 dec     3
782   >09B0=>15FD                 jgt     vsvrsrst1
783                               
784   >09B2=>0284 >CC72           ci      4, vsaverestore_r
785   >09B6=>1602                 jne     vsvrsrst2
787                               ;movb    @vmode, 1
788                               ;srl     1, 7
789                               ;mov     @vmodesetups(1), 1
790                               ;bl      *1
791                               
792   >09B8=>06A0 >04A4           bl      @vrestoremode
793                               
794   >09BC                   vsvrsrst2:    
795                               POP     SP,11,12
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >09BC=>C33A                     mov *SP+,  12
2     >09BE=>C2FA                     mov *SP+,  11 
*** video.i
796   >09C0=>045B                 rt
797                                       
798   >09C2                   vsvrssz:
799   >09C2=>0201 >000B           li      1, _CPURAMSIZE+1
800   >09C6=>0221 >0061           ai      1, _VIDVARSIZE+1
801   >09CA=>045B                 rt
802                               
804   >09CC                   vfonts dw vf_8x8, vf_6x8, vf_5x6
      >09CC=>09D2 >09D6 >09DA 
806   >09D2                   vf_8x8 dw >0808, grom_font8x8
      >09D2=>0808 >0130       
807   >09D6                   vf_6x8 dw >0608, grom_font8x8
      >09D6=>0608 >0130       
808   >09DA                   vf_5x6 dw >0506, grom_font5x6
      >09DA=>0506 >0930       
816   >09DE                   vsetfont PUSH SP,11
*** <expansion of push>
1     >09DE=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >09E0=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video.i
817   >09E2=>A041                 a      r1,r1
818   >09E4=>C061 >09CC           mov    @vfonts(r1), r1
819                               
820   >09E8=>C831 >F7A2           mov    *1+, @vbsize
821   >09EC=>C011                 mov    *1, 0
822   >09EE=>C800 >F7BC           mov    0,@vfont
824   >09F2=>9820 >0018 >F7CD     cb     #M_bit, @vidmode
825   >09F8=>1316                 jeq    vsetfont1
826   >09FA=>9820 >0014 >F7CD     cb     #M_bit4, @vidmode
827   >0A00=>1312                 jeq    vsetfont1
828                               
829   >0A02                   vsetfont0:
830   >0A02=>06A0 >044A           bl      @gwaddr
832   >0A06=>C020 >F78A           mov     @vpatts, 0
833   >0A0A=>A020 >FF70           a       @vtextpage, 0
834   >0A0E=>06A0 >1790           bl      @vsetbank
835   >0A12=>06A0 >0458           bl      @vwaddr
837   >0A16=>0202 >0800           li      2,>800
838   >0A1A                   vgf1 movb   @GPLRD,@VDPWD
      >0A1A=>D820 >FF90 >FF88 
839   >0A20=>0602                 dec     2
840   >0A22=>15FB                 jgt     vgf1
842   >0A24=>1019                 jmp     vsetfont2
844   >0A26                   vsetfont1:    
845                               ; reset the maximum vwidth/vheight
846   >0A26=>04C0                 clr    0
847   >0A28=>C060 >F7CE           mov    @vscrnx, 1
848   >0A2C=>D0A0 >F7A2           movb   @vbsize, 2
849   >0A30=>0982                 srl    2, 8
850   >0A32=>3C02                 div    2, 0
851   >0A34=>C800 >F7B4           mov    0, @vwidth
853   >0A38=>04C0                 clr    0
854   >0A3A=>C060 >F7D0           mov    @vscrny, 1
855   >0A3E=>D0A0 >F7A3           movb   @vbsize+1, 2
856   >0A42=>0982                 srl    2, 8
857   >0A44=>3C02                 div    2, 0
858                               
859                               ; add extra row if we can see at least half the character (slack for 212-line modes)
860   >0A46=>A041                 a      1, 1
861   >0A48=>8081                 c      1, 2
862   >0A4A=>1A01                 jl     vsetfont1b
863   >0A4C=>0580                 inc    0
864   >0A4E                   vsetfont1b    
865   >0A4E=>06C0                 swpb   0
866   >0A50=>D800 >F7B3           movb   0, @vheight
867                               
868   >0A54=>06A0 >1A3E           bl      @treset
870   >0A58                   vsetfont2:    
871                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0A58=>C2FA                     mov *SP+,  11
*** video.i
872   >0A5A=>045B                 rt
874                               
883   >0A5C                   vcursoroff
884   >0A5C=>9820 >F7AA >0019 	cb	   @vcurs,#00
885   >0A62=>1306             	jeq	   vcursisoff
886   >0A64=>064A             	dect   SP
887   >0A66=>C680             	mov	   0,*SP
888                           	;movb   #>80,@vcurs		; force an "off" next time
889   >0A68=>C020 >F7A8       	mov	   @vcursor,0
890   >0A6C=>0410             	blwp   *0
891   >0A6E=>C03A             	mov	   *SP+,0
892   >0A70                   vcursisoff	rt
      >0A70=>045B             
899                            Vector pixel, vidws
*** <expansion of vector>
1     >0A72                   pixel  data vidws, pixel_entry
      >0A72=>FC60 >0A76       
2     >0A76                   pixel_entry:    
*** video.i
900   >0A76=>0300 >0000           limi    0
901   >0A7A=>020A >F740           li      SP,vstack + vstacksize
903   >0A7E=>C32D >0018           mov     @24(13), 12
904                               
905   >0A82=>06A0 >0A88           bl      @vpixel
906                               
907   >0A86=>0380                 rtwp
908                               
910   >0A88                   vpixel:
911                               PUSH    SP,4,9,11
*** <expansion of push>
1     >0A88=>022A >FFFA           ai SP, -3*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0A8C=>CA84 >0004               mov  4 , @(3-0-1)*2(SP)
2     >0A90=>CA89 >0002               mov  9 , @(3-1-1)*2(SP)
3     >0A94=>C68B                     mov  11, @(3-2-1)*2(SP)
*** video.i
912                               
913   >0A96=>9820 >0014 >F7CD     cb      #M_bit4,@vidmode
914   >0A9C=>130F                 jeq     vbpcont4
915                               
916   >0A9E=>9820 >0018 >F7CD     cb      #M_bit,@vidmode
917   >0AA4=>1624                 jne     vbpout
919   >0AA6                   vbpcont:
920                               PUSH    SP, 12
*** <expansion of push>
1     >0AA6=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0AA8=>C68C                     mov  12, @(1-0-1)*2(SP)
*** video.i
921   >0AAA=>C0AC >0002           mov     @2(12), 2
922   >0AAE=>C06C >0004           mov     @4(12), 1
923   >0AB2=>C31C                 mov     *12, 12
924                               
925   >0AB4=>06A0 >126E           bl      @vbl_drawpixel
927                               POP     SP, 12
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0AB8=>C33A                     mov *SP+,  12
*** video.i
928   >0ABA=>1019                 jmp     vbpout
930   >0ABC                   vbpcont4:
931   >0ABC=>06A0 >16A6           bl      @vcmdsetup
932   >0AC0=>0024                 data    >24             ; -> DX
933                               
934   >0AC2=>C02C >0004           mov     @4(12), 0
935   >0AC6=>06A0 >169C           bl      @vcoordsend
936   >0ACA=>C02C >0002           mov     @2(12), 0
937   >0ACE=>06A0 >169C           bl      @vcoordsend
938                               
939   >0AD2=>06A0 >0498           bl      @vwregnext
940   >0AD6=>112C                 data    >112c        ; -> CLR
941   >0AD8=>D52C >0001           movb    @1(12), *4     ; CLR
943   >0ADC=>D520 >0019           movb    #00, *4         ; ARG 
945   >0AE0=>0209 >5000           li      9, >5000        ; PSET
946   >0AE4=>5720 >0255           szcb    #>f0, *12
947   >0AE8=>F25C                 socb    *12, 9           ; OP
948   >0AEA=>06A0 >1742           bl      @vbit4xsetupMMMcommand
950   >0AEE                   vbpout:    
951                               POP     SP,4,9,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0AEE=>C2FA                     mov *SP+,  11
2     >0AF0=>C27A                     mov *SP+,  9 
3     >0AF2=>C13A                     mov *SP+,  4 
*** video.i
952   >0AF4=>045B                 rt
953                               
958                            Vector fillrect, vidws
*** <expansion of vector>
1     >0AF6                   fillrect  data vidws, fillrect_entry
      >0AF6=>FC60 >0AFA       
2     >0AFA                   fillrect_entry:    
*** video.i
959   >0AFA=>0300 >0000           limi    0
960   >0AFE=>020A >F740           li      SP,vstack + vstacksize
962   >0B02=>C2AD >0018           mov     @24(13), 10
963                               
964   >0B06=>9820 >F7CD >0014     cb      @vidmode, #M_bit4
965   >0B0C=>131B                 jeq     fr4x
966                               
967   >0B0E=>9820 >F7CD >0018     cb      @vidmode, #M_bit
968   >0B14=>162C                 jne     frout
970   >0B16=>C0AA >0006           mov     @6(10), 2       ; Y
971   >0B1A=>C06A >0008           mov     @8(10), 1       ; X
972   >0B1E=>06A0 >1234           bl      @vbl_getaddr    ; R0= addr, R1=shift
973                               
974   >0B22=>C22A >0002           mov     @2(10), 8       ; H
975   >0B26=>C0AA >0004           mov     @4(10), 2       ; W
976                               
977                               ; only fg honored, not op
978   >0B2A=>C31A                 mov     *10, 12         ; op|c 
979   >0B2C=>0ACC                 sla     12, 12
980   >0B2E=>F320 >F7BF           socb    @vfgbg+1, 12
981                               
982   >0B32=>06CC                 swpb    12
983   >0B34=>D320 >046B           movb    #>FF,12
985   >0B38=>C100                 mov     0,4
986   >0B3A=>0241 >0007           andi    1,7
988   >0B3E=>06A0 >1486           bl      @vbitfillrect
989   >0B42=>0380                 rtwp
990                               
991   >0B44                   fr4x:
992   >0B44=>06A0 >16A6           bl      @vcmdsetup
993   >0B48=>0024                 data    >24
994                               
995   >0B4A=>C04A                 mov     10, 1
996   >0B4C=>05C1                 inct    1               ; skip color
997   >0B4E=>0611                 dec     *1              ; convert end-coord relative offset to real width/height
998   >0B50=>0621 >0002           dec     @2(1)           ; ... again
999   >0B54=>04C2                 clr     2
1000  >0B56=>06A0 >1854           bl      @vbitsetupDXDYNXNYsigned
1002  >0B5A=>D52A >0001           movb    @1(10), *4      ; CLR
1004  >0B5E=>D502                 movb    2, *4           ; ARG (dix=0, diy=0, mxc=0)
1006  >0B60=>0209 >8000           li      9, >8000        ; LMMV
1007  >0B64=>56A0 >0255           szcb    #>f0, *10
1008  >0B68=>F25A                 socb    *10, 9          ; OP
1009  >0B6A=>06A0 >1742           bl      @vbit4xsetupMMMcommand
1010                              
1011  >0B6E                   frout:    
1012  >0B6E=>0380                 rtwp
1019                           Vector line, vidws
*** <expansion of vector>
1     >0B70                   line  data vidws, line_entry
      >0B70=>FC60 >0B74       
2     >0B74                   line_entry:    
*** video.i
1020  >0B74=>0300 >0000           limi    0
1021  >0B78=>020A >F740           li      SP,vstack + vstacksize
1023  >0B7C=>C32D >0018           mov     @24(13), 12
1024                              
1025  >0B80=>9820 >F7CD >0014     cb     @vidmode, #M_bit4
1026  >0B86=>1306                 jeq     ln4x
1027                              
1028  >0B88=>9820 >F7CD >0018     cb     @vidmode, #M_bit
1029  >0B8E=>161A                 jne     lnout
1030                              
1031  >0B90=>0460 >10F6           b       @vbitline
1032                              
1033  >0B94                   ln4x:
1034  >0B94=>06A0 >16A6           bl      @vcmdsetup
1035  >0B98=>0024                 data    >24
1036                              
1037  >0B9A=>C04C                 mov     12, 1
1038  >0B9C=>05C1                 inct    1       ; skip color
1039  >0B9E=>0202 >8000           li      2, >8000    ; LINE mode
1040                              
1041                              ; convert X2,Y2 to X2-X1, Y2-Y1
1042  >0BA2=>6461 >0004           s       @4(1), *1
1043  >0BA6=>6861 >0006 >0002     s       @6(1), @2(1)
1044  >0BAC=>06A0 >1854           bl      @vbitsetupDXDYNXNYsigned
1046  >0BB0=>D52C >0001           movb    @1(12), *4     ; CLR
1048  >0BB4=>D502                 movb    2, *4           ; ARG (dix=0, diy=0, mxc=0)
1050  >0BB6=>0209 >7000           li      9, >7000        ; LINE
1051  >0BBA=>5720 >0255           szcb    #>f0, *12
1052  >0BBE=>F25C                 socb    *12, 9          ; OP
1053  >0BC0=>06A0 >1742           bl      @vbit4xsetupMMMcommand
1054                              
1055  >0BC4                   lnout:    
1056  >0BC4=>0380                 rtwp
1062                           Vector circle, vidws
*** <expansion of vector>
1     >0BC6                   circle  data vidws, circle_entry
      >0BC6=>FC60 >0BCA       
2     >0BCA                   circle_entry:    
*** video.i
1063  >0BCA=>0300 >0000           limi    0
1064  >0BCE=>020A >F740           li      SP,vstack + vstacksize
1066  >0BD2=>C32D >0018           mov     @24(13), 12
1067                              
1068  >0BD6=>C04C                 mov     12, 1
1069                              
1070  >0BD8=>C23C                 mov     *12+, 8     ; color
1071  >0BDA=>C1FC                 mov     *12+, 7     ; R / p / y
1072  >0BDC=>C17C                 mov     *12+, 5     ; cy
1073  >0BDE=>C13C                 mov     *12+, 4     ; cx
1074                              
1075  >0BE0=>0209 >0005           li      9, 5
1076  >0BE4=>0A27                 sla     7, 2
1077  >0BE6=>6247                 s       7, 9
1078  >0BE8=>0829                 sra     9, 2        ; P = (5/4) R
1079  >0BEA=>0827                 sra     7, 2
1080                              
1081  >0BEC=>04C6                 clr     6           ; x
1083  >0BEE=>06A0 >0C16           bl      @circlePoints
1084                              
1085  >0BF2                   ccloop:
1086  >0BF2=>81C6                 c       6, 7
1087  >0BF4=>140F                 jhe     ccout
1089  >0BF6=>0586                 inc     6
1090  >0BF8=>C249                 mov     9, 9
1091  >0BFA=>1106                 jlt     ccneg
1092                              
1093  >0BFC=>0607                 dec     7
1094                              
1095  >0BFE=>C006                 mov     6, 0
1096  >0C00=>6007                 s       7, 0
1097  >0C02=>A000                 a       0, 0
1098  >0C04=>A240                 a       0, 9
1099                              
1100  >0C06=>1002                 jmp     ccnext
1102  >0C08                   ccneg:
1103  >0C08=>A246                 a       6, 9
1104  >0C0A=>A246                 a       6, 9
1106  >0C0C                   ccnext:
1107  >0C0C=>0589                 inc     9
1108                              
1109  >0C0E=>06A0 >0C16           bl      @circlePoints
1110  >0C12=>10EF                 jmp     ccloop
1111                              
1112  >0C14                   ccout:
1113  >0C14=>0380                 rtwp    
1121  >0C16                   circlePoints 
1122                              PUSH    SP,11,12,13,14,15
*** <expansion of push>
1     >0C16=>022A >FFF6           ai SP, -5*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0C1A=>CA8B >0008               mov  11 , @(5-0-1)*2(SP)
2     >0C1E=>CA8C >0006               mov  12 , @(5-1-1)*2(SP)
3     >0C22=>CA8D >0004               mov  13 , @(5-2-1)*2(SP)
4     >0C26=>CA8E >0002               mov  14 , @(5-3-1)*2(SP)
5     >0C2A=>C68F                     mov  15, @(5-4-1)*2(SP)
*** video.i
1123                              
1124  >0C2C=>02AC                 STWP    12 
1125  >0C2E=>022C >001A           ai      12, 13*2
1127  >0C32=>C348                 mov     8, 13       ; R13=color, R14=Y, R15=X    
1134  >0C34=>C3C4                 mov     4, 15
1135  >0C36=>A3C6                 a       6, 15
1136  >0C38=>C385                 mov     5, 14
1137  >0C3A=>A387                 a       7, 14
1138  >0C3C=>06A0 >0A88           bl      @vpixel     ; cx+x, cy+y        ; 0 0
1140  >0C40=>C3C4                 mov     4, 15
1141  >0C42=>63C6                 s       6, 15
1142  >0C44=>C385                 mov     5, 14
1143  >0C46=>6387                 s       7, 14
1144  >0C48=>06A0 >0A88           bl      @vpixel     ; cx-x, cy-y        ; 1 1
1146  >0C4C=>81C6                 c       6, 7
1147  >0C4E=>131A                 jeq     cptseq     ; x == y    
1148                              
1149  >0C50=>C3C4                 mov     4, 15
1150  >0C52=>A3C7                 a       7, 15
1151  >0C54=>C385                 mov     5, 14
1152  >0C56=>A386                 a       6, 14
1153  >0C58=>06A0 >0A88           bl      @vpixel     ; cx+y, cy+x        ; 0 0
1154                              
1155  >0C5C=>C3C4                 mov     4, 15
1156  >0C5E=>63C7                 s       7, 15
1157  >0C60=>C385                 mov     5, 14
1158  >0C62=>6386                 s       6, 14
1159  >0C64=>06A0 >0A88           bl      @vpixel     ; cx-y, cy-x        ; 1 1
1160                              
1161  >0C68=>C186                 mov     6, 6
1162  >0C6A=>1318                 jeq     cptsout     ; x == 0
1163                              
1164  >0C6C=>C3C4                 mov     4, 15
1165  >0C6E=>A3C7                 a       7, 15
1166  >0C70=>C385                 mov     5, 14
1167  >0C72=>6386                 s       6, 14
1168  >0C74=>06A0 >0A88           bl      @vpixel     ; cx+y, cy-x        ; 0 1
1169                              
1170  >0C78=>C3C4                 mov     4, 15
1171  >0C7A=>63C7                 s       7, 15
1172  >0C7C=>C385                 mov     5, 14
1173  >0C7E=>A386                 a       6, 14
1174  >0C80=>06A0 >0A88           bl      @vpixel     ; cx-y, cy+x        ; 1 0
1176  >0C84                   cptseq:
1177                              
1178  >0C84=>C3C4                 mov     4, 15
1179  >0C86=>A3C6                 a       6, 15
1180  >0C88=>C385                 mov     5, 14
1181  >0C8A=>6387                 s       7, 14
1182  >0C8C=>06A0 >0A88           bl      @vpixel     ; cx+x, cy-y        ; 0 1
1184  >0C90=>C3C4                 mov     4, 15
1185  >0C92=>63C6                 s       6, 15
1186  >0C94=>C385                 mov     5, 14
1187  >0C96=>A387                 a       7, 14
1188  >0C98=>06A0 >0A88           bl      @vpixel     ; cx-x, cy+y        ; 1 0
1189                              
1190  >0C9C                   cptsout:    
1191                              POP     SP,11,12,13,14,15
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0C9C=>C3FA                     mov *SP+,  15
2     >0C9E=>C3BA                     mov *SP+,  14 
3     >0CA0=>C37A                     mov *SP+,  13 
4     >0CA2=>C33A                     mov *SP+,  12 
5     >0CA4=>C2FA                     mov *SP+,  11 
*** video.i
1192  >0CA6=>045B                 rt
1211                           Vector  vspritemotion, vidws
*** <expansion of vector>
1     >0CA8                   vspritemotion  data vidws, vspritemotion_entry
      >0CA8=>FC60 >0CAC       
2     >0CAC                   vspritemotion_entry:    
*** video.i
1212  >0CAC=>020A >F740           li     SP,vstack + vstacksize 
1214  >0CB0=>D160 >FF66           movb    @nsprmot, 5
1215  >0CB4=>1601                 jne     $1+
1216                              
1217  >0CB6=>0380                 rtwp
1219  >0CB8                   $1:    
1220  >0CB8=>0985                 srl     5, 8
1221                              
1222  >0CBA=>C020 >F798           mov     @vsprmot, 0
1223  >0CBE=>C180                 mov     0, 6
1224  >0CC0=>61A0 >F792           s       @vsprites, 6    ; R6 = delta to sprites
1225                              
1226  >0CC4=>06A0 >1790           bl      @vsetbank
1227                              
1228  >0CC8=>C100                 mov     0, 4
1229                              
1230  >0CCA=>020C >FF80           li      12, VDPRD
1231  >0CCE=>0209 >FF8A           li      9, VDPWA
1232  >0CD2=>0208 >D000           li      8, >D000        ; boundary Y coord
1233                              
1234  >0CD6=>C020 >F7B6           mov     @vbit4stride, 0
1235  >0CDA=>1302                 jeq     vsm_loop
1236                              
1237  >0CDC=>0208 >D800           li      8, >D800        ; ... for V9938 modes
1238                              
1239  >0CE0                   vsm_loop:
1240  >0CE0=>D660 >FC69           movb    @vidws+9, *9
1241  >0CE4=>D644                 movb    4, *9       ; get sprite motion entry
1242                              
1243  >0CE6=>D05C                 movb    *12, 1      ; Y-motion
1244  >0CE8=>06C1                 swpb    1
1245  >0CEA=>D05C                 movb    *12, 1      ; X-motion
1246                              
1247  >0CEC=>C041                 mov     1, 1        ; any motion?
1248  >0CEE=>1330                 jeq     vsm_next
1249                              
1250  >0CF0=>D0DC                 movb    *12, 3      ; Y-frac
1251  >0CF2=>D09C                 movb    *12, 2      ; X-frac
1253  >0CF4=>C004                 mov     4, 0
1254  >0CF6=>6006                 s       6, 0
1255  >0CF8=>D660 >FC61           movb    @vidws+1, *9
1256  >0CFC=>D640                 movb    0, *9       ; get sprite coords
1257                              
1258  >0CFE=>06C3                 swpb    3
1259  >0D00=>D0DC                 movb    *12, 3      ; Y|y
1260  >0D02=>06C2                 swpb    2
1261  >0D04=>D09C                 movb    *12, 2      ; X|x
1262                              
1263                              ; R2 = X|x coord, R3 = Y|y coord, R1 = x|y motion
1264                              
1265  >0D06=>D1C1                 movb    1, 7
1266  >0D08=>0887                 sra     7, 8        ; sign extend
1267  >0D0A=>0A47                 sla     7, 4        ; 1/16 pixel per 1/60 second        
1268  >0D0C=>A087                 a       7, 2        ; add motion for X
1270  >0D0E=>06C1                 swpb    1
1271  >0D10=>0881                 sra     1, 8        ; sign extend
1272  >0D12=>0A41                 sla     1, 4        ; 1/16 pixel per 1/60 second        
1273  >0D14=>A0C1                 a       1, 3        ; add motion for Y
1274                              
1275                              ; Check for Y coordinate in bad range.
1276                              ;
1277                              ; The original idea was:
1278                              ;
1279                              ;   If we moved down to $D0 (or more), then bump by $10.
1280                              ;   If we moved up to $DF (or less), then bump by -$10.
1281                              ;   
1282                              ; We need to apply consistent movement, though, so we
1283                              ; can't just notice when a sprite happens to be in the
1284                              ; range -- we may have a kind of movement that sometimes
1285                              ; hits this range and sometimes doesn't.  Moving a whole 16
1286                              ; pixels in some cases and not others would be too noticeable.
1287                              ;
1288                              ; Instead, just check for the same coordinate and 
1289                              ; bump one pixel in the intended direction.
1290                              ;
1291                              ; TODO: further tweaks with the fraction
1292                              
1293  >0D16=>90C8                 cb      8, 3     
1294  >0D18=>1607                 jne     $2+         ; at delete coordinate? 
1295                              
1296  >0D1A=>C041                 mov     1, 1        ; which direction?
1297  >0D1C=>1103                 jlt     $1+
1298                              
1299  >0D1E=>B0E0 >01BB           ab      #>1, 3      ; moved down, go further 
1300  >0D22=>1002                 jmp     $2+
1301                              
1302  >0D24                   $1:
1303  >0D24=>70E0 >01BB           sb      #>1, 3      ; moved up, go further
1304                              
1305  >0D28                   $2:
1306  >0D28=>0260 >4000           ori     0, >4000
1307  >0D2C=>D660 >FC61           movb    @vidws+1, *9
1308  >0D30=>D640                 movb    0, *9       ; update sprite coord 
1309                              
1310  >0D32=>DA43 >FFFE           movb    3, @-2(9)
1311  >0D36=>DA42 >FFFE           movb    2, @-2(9)
1312                              
1313  >0D3A=>A006                 a       6, 0
1314  >0D3C=>05C0                 inct    0
1315  >0D3E=>D660 >FC61           movb    @vidws+1, *9
1316  >0D42=>D640                 movb    0, *9        ; update motion fractions
1317                              
1318  >0D44=>06C3                 swpb    3
1319  >0D46=>DA43 >FFFE           movb    3, @-2(9)
1320  >0D4A=>06C2                 swpb    2
1321  >0D4C=>DA42 >FFFE           movb    2, @-2(9)
1322                              
1323  >0D50                   vsm_next:
1324  >0D50=>0224 >0004           ai      4, 4
1325  >0D54=>0605                 dec     5
1326  >0D56=>15C4                 jgt     vsm_loop
1328  >0D58=>0380                 rtwp
1329                              
*** nforth.tsm
508                           	incl	video_text.i
*** video_text.i
21                              
22    >0D5A                   vtextsetup
23                                PUSH    SP,11
*** <expansion of push>
1     >0D5A=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0D5C=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_text.i
24    >0D5E=>0201 >051A           li      1,vtxt
25    >0D62=>D820 >0019 >F7CD     movb    #M_text,@vidmode
26    >0D68=>06A0 >096E           bl      @vstdmode
27    >0D6C                   vtextsetup0:
28    >0D6C=>06A0 >076A       	bl	    @vsetupregs
29    >0D70=>06A0 >079E       	bl	    @vsetupaddrs
30    >0D74=>C801 >F7C8       	mov    1,@vtermptr
31                                
32                            	POP    SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0D78=>C2FA                     mov *SP+,  11
*** video_text.i
33    >0D7A=>045B             	rt
34                            	
35    >0D7C                   vtext2setup
36                                PUSH    SP,11
*** <expansion of push>
1     >0D7C=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0D7E=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_text.i
37    >0D80=>06A0 >15CC           bl      @venhmode
38    >0D84=>D820 >0226 >F7CD     movb    #M_text2,@vidmode
39                                
40                                ; set inverted bg/fg for blink color
41    >0D8A=>04C0                 clr     0
42    >0D8C=>D020 >F7BE           movb    @vfgbg,0
43    >0D90=>06C0                 swpb    0
44    >0D92=>D020 >F7BE           movb    @vfgbg,0
45    >0D96=>0B05                 src     5, 0
46    >0D98=>D020 >04A9           movb    #>C,0
47    >0D9C=>06A0 >046E           bl      @vwreg
48                                
49    >0DA0=>0201 >06A8           li      1,vtxt2
50    >0DA4=>10E3                 jmp     vtextsetup0
53    >0DA6                   vgraphsetup
54    >0DA6=>D820 >01BB >F7CD     movb    #M_graph,@vidmode
55    >0DAC=>0201 >0544       	li	1,vgfx
56    >0DB0                   vgraphsetup0:	
57                                PUSH    SP,11
*** <expansion of push>
1     >0DB0=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0DB2=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_text.i
58    >0DB4=>06A0 >076A       	bl	@vsetupregs
59    >0DB8=>06A0 >079E       	bl	@vsetupaddrs
60    >0DBC=>C801 >F7C8       	mov 1,@vtermptr
61                                ;bl  @vtermsetup
62    >0DC0=>06A0 >096E           bl  @vstdmode
63                                POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0DC4=>C2FA                     mov *SP+,  11
*** video_text.i
64    >0DC6=>045B             	rt
66    >0DC8                   vmultisetup
67    >0DC8=>D820 >0078 >F7CD     movb    #M_multi,@vidmode
68    >0DCE=>0201 >0708           li  1,vmulti
69    >0DD2=>10EE                 jmp vgraphsetup0
70                                
80    >0DD4                   vtextaddr PUSH SP, 2
*** <expansion of push>
1     >0DD4=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0DD6=>C682                     mov  2, @(1-0-1)*2(SP)
*** video_text.i
81                                
82    >0DD8=>C080                 mov     0,2              ; save X
83    >0DDA=>06C0                 swpb    0
85    >0DDC=>B020 >F7C3           ab      @vwy,0
86    >0DE0=>0980                 srl     0,8
87    >0DE2=>3820 >F7B4           mpy     @vwidth,0        ; get row offset in R1
88                                
89    >0DE6=>D002                 movb    2,0
90    >0DE8=>B020 >F7C2           ab      @vwx,0
91    >0DEC=>0980                 srl     0,8              ; get column offset
93    >0DEE=>A001                 a       1,0                ; column+row
94    >0DF0=>A020 >F786           a       @vscreen,0         ; R0=addr
95    >0DF4=>A020 >FF70           a       @vtextpage,0
97                                POP     SP, 2
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0DF8=>C0BA                     mov *SP+,  2
*** video_text.i
98    >0DFA=>045B                 rt
110   >0DFC                   vgraphaddr PUSH SP, 2
*** <expansion of push>
1     >0DFC=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0DFE=>C682                     mov  2, @(1-0-1)*2(SP)
*** video_text.i
111   >0E00=>C080                 mov     0,2             ; save X
112   >0E02=>06C0                 swpb    0
114   >0E04=>B020 >F7C3           ab      @vwy,0
115   >0E08=>0980                 srl     0,8
116   >0E0A=>0A50                 sla     0,5
118   >0E0C=>D042                 movb    2,1
119   >0E0E=>B060 >F7C2           ab      @vwx,1
120   >0E12=>0981                 srl     1,8                 ; get column offset
122   >0E14=>A001                 a       1,0             ; column+row
123   >0E16=>A020 >F786           a       @vscreen,0          ; R0=addr
125                               POP     SP, 2
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0E1A=>C0BA                     mov *SP+,  2
*** video_text.i
126   >0E1C=>045B                 rt
136   >0E1E                   vtextclearline
137                               PUSH    SP,0,3,11
*** <expansion of push>
1     >0E1E=>022A >FFFA           ai SP, -3*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0E22=>CA80 >0004               mov  0 , @(3-0-1)*2(SP)
2     >0E26=>CA83 >0002               mov  3 , @(3-1-1)*2(SP)
3     >0E2A=>C68B                     mov  11, @(3-2-1)*2(SP)
*** video_text.i
139   >0E2C=>C0E0 >F7A4           mov     @vcoordaddr,3
140   >0E30=>0693                 bl      *3
141   >0E32=>06A0 >1790           bl      @vsetbank
142   >0E36=>0201 >2000           li      1,>2000
143                               ;movb    @vwxs, 2
144                               ;srl     2,8 
145   >0E3A=>06A0 >04CA           bl      @vclr               ; clear out line
146                               
147   >0E3E=>9820 >0226 >F7CD     cb      #M_text2, @vidmode
148   >0E44=>160A                 jne     vtextclearlineout
149                               
150                               ; clear blinks
151   >0E46=>04C1                 clr     1
152   >0E48=>D0E0 >FF6D           movb    @vblinkflag, 3
153   >0E4C=>1301                 jeq     vtextclearline0
154   >0E4E=>0701                 seto    1    
155   >0E50                   vtextclearline0:
156   >0E50=>0932                 srl     2, 3                ; NOTE: only works on 8-char aligned windows
157   >0E52=>06A0 >0EBC           bl      @vtxt2blink
158   >0E56=>06A0 >04CA           bl      @vclr               ; set blink 
160   >0E5A                   vtextclearlineout:         
161                               POP     SP,0,3,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0E5A=>C2FA                     mov *SP+,  11
2     >0E5C=>C0FA                     mov *SP+,  3 
3     >0E5E=>C03A                     mov *SP+,  0 
*** video_text.i
162   >0E60=>045B                 rt
178                            Vector vtextchar, vidws
*** <expansion of vector>
1     >0E62                   vtextchar  data vidws, vtextchar_entry
      >0E62=>FC60 >0E66       
2     >0E66                   vtextchar_entry:    
*** video_text.i
179   >0E66=>0300 >0000       	limi   0
180   >0E6A=>020A >F740       	li	   SP,vstack + vstacksize
182   >0E6E=>C020 >F7CA       	mov	   @vx,0
183   >0E72=>C060 >F7A4       	mov	   @vcoordaddr,1
184   >0E76=>0691             	bl	   *1				; get address
185                               
186   >0E78=>06A0 >1790           bl     @vsetbank            ; set bank / page
187   >0E7C=>06A0 >0458       	bl	   @vwaddr				; set VDP addr
188   >0E80=>D820 >F7C0 >FF88 	movb   @vch,@VDPWD			; draw
190   >0E86=>9820 >0226 >F7CD     cb     #M_text2, @vidmode	
191   >0E8C=>1301             	jeq    vtextchar0
192   >0E8E=>0380             	rtwp
193                           	
194   >0E90                   vtextchar0:
195                               ; set blink flag
196   >0E90=>06A0 >0EBC           bl     @vtxt2blink
197   >0E94=>06A0 >045C       	bl     @vraddr
198   >0E98=>D0A0 >FF80       	movb   @VDPRD, 2
199   >0E9C=>06A0 >0458       	bl     @vwaddr
200   >0EA0=>0201 >8000       	li     1, >8000
201   >0EA4=>0240 >0007           andi   0, 7
202   >0EA8=>1301                 jeq    vtextchar1
203   >0EAA=>0901             	srl    1, 0
204   >0EAC                   vtextchar1:	
205   >0EAC=>5081             	szcb   1, 2
206   >0EAE=>D020 >FF6D       	movb   @vblinkflag, 0     
207   >0EB2=>1301             	jeq    vtextchar2
208   >0EB4=>F081             	socb   1, 2
209   >0EB6                   vtextchar2:	   
210   >0EB6=>D802 >FF88           movb   2, @VDPWD
211   >0EBA=>0380             	rtwp
213   >0EBC                   vtxt2blink
214   >0EBC=>6020 >F786           s      @vscreen, 0
215   >0EC0=>0930                 srl    0, 3
216   >0EC2=>0240 >01FF           andi   0, >1ff
217   >0EC6=>A020 >FF70           a       @vtextpage, 0
218   >0ECA=>A020 >F78E           a      @vcolors, 0
219   >0ECE=>0240 >3FFF           andi   0, >3fff
220   >0ED2=>045B                 rt
229                             Vector vtextcursor, vidws
*** <expansion of vector>
1     >0ED4                   vtextcursor  data vidws, vtextcursor_entry
      >0ED4=>FC60 >0ED8       
2     >0ED8                   vtextcursor_entry:    
*** video_text.i
230   >0ED8=>0300 >0000       	limi	0
231   >0EDC=>020A >F740       	li	    SP,vstack+  vstacksize
233   >0EE0=>C020 >F7CA       	mov	   @vx,0
234   >0EE4=>C060 >F7A4       	mov	   @vcoordaddr,1
235   >0EE8=>0691             	bl	    *1
236                           	
237   >0EEA=>06A0 >1790       	bl     @vsetbank
238   >0EEE=>B820 >005F >F7AA 	ab	    #>80,@vcurs
239   >0EF4=>130B             	jeq	   vtcoff
241   >0EF6=>06A0 >045C       	bl	    @vraddr			; read char under cursor
242   >0EFA=>D820 >FF80 >F7AB 	movb	@VDPRD,@vcursunder
244   >0F00=>06A0 >0458       	bl	    @vwaddr
245   >0F04=>D820 >F7C1 >FF88 	movb	@vcurschar,@VDPWD		; draw cursor
247   >0F0A=>1005             	jmp	vtcout
249   >0F0C                   vtcoff:
250   >0F0C=>06A0 >0458       	bl	    @vwaddr
251   >0F10=>D820 >F7AB >FF88 	movb	@vcursunder,@VDPWD		; restore char under cursor
253   >0F16                   vtcout:
254   >0F16=>0380             	rtwp
257   >0F18                   vnopchar:
258   >0F18                   vnopcursor:
259   >0F18=>FC60 >0F16           data vidws, vtcout
260   >0F1C                   vnopclearline:
261   >0F1C=>045B                 rt    
*** nforth.tsm
509                           	incl	video_bit.i
*** video_bit.i
23    >0F1E                   vbitmapsetup
24    >0F1E=>D820 >0019 >F7CC 	movb	#00,@vmono
25    >0F24=>0201 >0574       	li 	   1, vbit
26    >0F28                   vbitsentr:
27                                PUSH    SP,11
*** <expansion of push>
1     >0F28=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0F2A=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_bit.i
28    >0F2C=>D820 >0018 >F7CD     movb    #M_bit,@vidmode
30    >0F32=>06A0 >076A       	bl	    @vsetupregs
31    >0F36=>06A0 >079E       	bl	    @vsetupaddrs
32    >0F3A=>C801 >F7C8       	mov    1,@vtermptr
33    >0F3E=>06A0 >096E           bl      @vstdmode
34                                
35                                POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0F42=>C2FA                     mov *SP+,  11
*** video_bit.i
36    >0F44=>045B             	rt
38    >0F46                   vmonosetup
39    >0F46=>D820 >01BB >F7CC 	movb	#1,@vmono
40    >0F4C=>0201 >06D8       	li     1, vmonobit
41    >0F50=>10EB             	jmp	   vbitsentr
43    >0F52                   vbitmap3setup
44    >0F52=>0201 >05A4           li      1, vbit3
45    >0F56=>10E8                 jmp     vbitsentr
55    >0F58                   vbitpixeladdr
56    >0F58=>C040                 mov    0,1
57    >0F5A=>0A50                 sla    0,5              ; R0=Y offset (row8) ++
58    >0F5C=>E001                 soc    1,0              ; R0=Y offset (row) ++
59    >0F5E=>0240 >FF07           andi   0,>ff07          ; R0=complete Y offset
61    >0F62=>C042                 mov    2,1              ; copy of X
62    >0F64=>0241 >0007           andi   1,7              ; complete X bit offs
63    >0F68=>A002                 a      2,0              ; Y-X offset ++
64    >0F6A=>6001                 s      1,0              ; complete Y-X offset
65    >0F6C=>045B                 rt
66                                
77    >0F6E                   vbitaddr 
78                                PUSH    SP,2,11
*** <expansion of push>
1     >0F6E=>022A >FFFC           ai SP, -2*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0F72=>CA82 >0002               mov  2 , @(2-0-1)*2(SP)
2     >0F76=>C68B                     mov  11, @(2-1-1)*2(SP)
*** video_bit.i
80    >0F78=>A020 >F7C2           a       @vwx, 0
81                                
82                                ; scale by vbsize
83    >0F7C=>04C1                 clr     1
84    >0F7E=>D060 >F7A2           movb    @vbsize,1       ; X size (hi)
85    >0F82=>04C2                 clr     2
86    >0F84=>D080                 movb    0,2             ; X (hi)
87    >0F86=>3881                 mpy     1,2             ; R2=col #  (3 = 0)
88                                
89    >0F88=>0A80                 sla     0,8             ; Y
90    >0F8A=>D0E0 >F7A3           movb    @vbsize+1,3
91    >0F8E=>38C0                 mpy     0,3             ; 3=row#
92                                
93    >0F90=>C003                 mov     3,0
94    >0F92=>7000                 sb      0,0             ; R0=Y
96    >0F94=>06A0 >0F58           bl      @vbitpixeladdr
97                                
98                                POP     SP,2,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0F98=>C2FA                     mov *SP+,  11
2     >0F9A=>C0BA                     mov *SP+,  2 
*** video_bit.i
99    >0F9C=>045B                 rt
109   >0F9E                   vbitclearline
110                               PUSH    SP,0,3,11
*** <expansion of push>
1     >0F9E=>022A >FFFA           ai SP, -3*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0FA2=>CA80 >0004               mov  0 , @(3-0-1)*2(SP)
2     >0FA6=>CA83 >0002               mov  3 , @(3-1-1)*2(SP)
3     >0FAA=>C68B                     mov  11, @(3-2-1)*2(SP)
*** video_bit.i
112                               ; get start address and shift in R0/R1
113   >0FAC=>C0E0 >F7A4           mov     @vcoordaddr,3
114   >0FB0=>0693                 bl      *3
115   >0FB2=>C100                 mov     0,4
117                               ; scale width by vbsize
118   >0FB4=>C201                 mov     1,8
119                               
120   >0FB6=>04C1                 clr     1
121   >0FB8=>D060 >F7A2           movb    @vbsize,1       ; X size (hi)
122                               ;clr     2
123                               ;movb    @vwxs,2         ; X (hi)
124   >0FBC=>0A82                 sla     2,8
125   >0FBE=>3881                 mpy     1,2             ; 2=col #  (3 = 0)
126                               
127   >0FC0=>C048                 mov     8,1
128                               
129                               ; height is vbsize
130   >0FC2=>D220 >F7A3           movb    @vbsize+1,8
131   >0FC6=>0988                 srl     8,8      
133   >0FC8=>06A0 >039C           bl      @vgetcolorbyte
134   >0FCC=>D300                 movb    0,12
135   >0FCE=>098C                 srl     12,8
136                               
137   >0FD0=>06A0 >1486           bl      @vbitfillrect
139                               POP     SP,0,3,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >0FD4=>C2FA                     mov *SP+,  11
2     >0FD6=>C0FA                     mov *SP+,  3 
3     >0FD8=>C03A                     mov *SP+,  0 
*** video_bit.i
140   >0FDA=>045B                 rt
151   >0FDC                   vfetchfontchar
152                               PUSH    SP,11,0
*** <expansion of push>
1     >0FDC=>022A >FFFC           ai SP, -2*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >0FE0=>CA8B >0002               mov  11 , @(2-0-1)*2(SP)
2     >0FE4=>C680                     mov  0, @(2-1-1)*2(SP)
*** video_bit.i
153   >0FE6=>D020 >F7C0           movb    @vch,0
154   >0FEA=>0980                 srl     0,8
155   >0FEC=>0A30                 sla     0,3
156   >0FEE=>A020 >F7BC           a       @vfont,0
157   >0FF2=>06A0 >044A           bl      @gwaddr             ; set GROM addr
158                               
159   >0FF6=>D2E0 >F7A3           movb    @vbsize+1,11
160   >0FFA=>098B                 srl     11,8
161                               
162   >0FFC=>C04A                 mov     SP, 1
163   >0FFE=>604B                 s       11, 1               ; get space on stack for char
164   >1000=>C001                 mov     1, 0
165   >1002                   $1:
166   >1002=>DC20 >FF90           movb    @GPLRD, *0+
167   >1006=>DC20 >FF90           movb    @GPLRD, *0+
168   >100A=>064B                 dect    11
169   >100C=>15FA                 jgt     $1-
170                                    
171                               POP     SP,11,0
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >100E=>C03A                     mov *SP+,  0
2     >1010=>C2FA                     mov *SP+,  11 
*** video_bit.i
172   >1012=>045B                 rt
182                            Vector vbitchar, vidws
*** <expansion of vector>
1     >1014                   vbitchar  data vidws, vbitchar_entry
      >1014=>FC60 >1018       
2     >1018                   vbitchar_entry:    
*** video_bit.i
183   >1018=>0300 >0000       	limi	0
184   >101C=>020A >F740       	li		SP,vstack + vstacksize
186   >1020=>8820 >F7A2 >29B4 	c       @vbsize,#>0808
187   >1026=>1302             	jeq		vbitfast
188   >1028=>0460 >1300       	b		@vbitcharsmall+4
190   >102C                   vbitfast:
191   >102C=>C020 >F7CA           mov     @vx,0
192   >1030=>C060 >F7A4       	mov		@vcoordaddr,1
193   >1034=>0691             	bl		*1				; get address in 0, shift in 1
195   >1036=>C100             	mov		0,4              
196                           	
197   >1038=>06A0 >0FDC       	bl      @vfetchfontchar
198                           	
199   >103C=>A020 >F78A       	a		@vpatts,0
200   >1040=>06A0 >0458       	bl		@vwaddr				; set VDP addr for patt
202   >1044=>0203 >FF88       	li		3,VDPWD
203   >1048=>0202 >0008           li      2, 8
204   >104C                   $1: movb    *1+,*3
      >104C=>D4F1             
205   >104E=>0602                 dec     2
206   >1050=>15FD                 jgt     $1-
207                           	
208   >1052=>D820 >F7CC >F7CC 	movb	@vmono,@vmono
209   >1058=>160D             	jne		vbcnocol
211   >105A=>C004             	mov		4,0
212   >105C=>A020 >F78E       	a		@vcolors,0			; draw color
213   >1060=>06A0 >0458       	bl		@vwaddr
215   >1064=>06A0 >039C           bl      @vgetcolorbyte
216   >1068=>D040                 movb    0,1
218   >106A=>0202 >0008           li      2, 8
219   >106E                   $1: movb    1,*3
      >106E=>D4C1             
220   >1070=>0602                 dec     2
221   >1072=>15FD                 jgt     $1-    
223   >1074                   vbcnocol:
224   >1074=>0380             	rtwp
227   >1076                   vbitcursorset
228   >1076=>C28B                 mov     11,10 
229   >1078=>06A0 >045C           bl     @vraddr
230   >107C=>D060 >FF80           movb   @VDPRD, 1
231   >1080=>DD81                 movb    1,*6+
232   >1082=>F043                 socb   3,1
233   >1084=>045A                 b       *10
234                               
235   >1086                   vbitcursorreset 
236   >1086=>D076                 movb *6+,1
237   >1088=>045B                 rt
238                            
242                            Vector vbitcursor, vidws
*** <expansion of vector>
1     >108A                   vbitcursor  data vidws, vbitcursor_entry
      >108A=>FC60 >108E       
2     >108E                   vbitcursor_entry:    
*** video_bit.i
244   >108E=>0300 >0000       	limi   0
245   >1092=>020A >F740       	li	   SP,vstack + vstacksize
247   >1096=>C020 >F7CA       	mov    @vx,0
248   >109A=>C060 >F7A4       	mov	   @vcoordaddr,1
249   >109E=>0691             	bl	   *1
250                           	
251   >10A0=>A020 >F78A       	a	   @vpatts,0		; only change patt
252   >10A4=>06A0 >1790           bl     @vsetbank
253   >10A8=>C100             	mov    0,4
254                               
255   >10AA=>C001                 mov    1,0
256   >10AC=>0203 >C0C0           li     3,>c0c0
257   >10B0=>0B03                 src    3,0
258                               
259                               ; based on the cursor mode, we either save + modify or restore the bits under the cursor
260   >10B2=>0205 >1076           li      5,vbitcursorset
261   >10B6=>B820 >005F >F7AA     ab      #>80,@vcurs
262   >10BC=>1602                 jne     vbc1
263   >10BE=>0205 >1086           li      5,vbitcursorreset
264   >10C2                   vbc1:    
265   >10C2=>0206 >F7AB           li     6,vcursunder
266   >10C6=>D0A0 >F7A3           movb   @vbsize+1, 2
267   >10CA=>0982                 srl    2,8
268                               
269   >10CC=>0207 >0007           li      7, 7
270   >10D0=>020C >0001           li      12, 1
271   >10D4                   vbc0:
272   >10D4=>C004                 mov     4,0
273   >10D6=>0695                 bl      *5      ; read or write pixel
274   >10D8=>06A0 >0458           bl      @vwaddr
275   >10DC=>D801 >FF88           movb    1,@VDPWD
276                               
277   >10E0=>A10C                 a       12,4    ; next row
278   >10E2=>2507                 czc     7,4     ; end of block?
279   >10E4=>1604                 jne     vbc2
280   >10E6=>0224 >00FF           ai      4,>ff   
281   >10EA=>0244 >3FF8           andi    4,>3ff8
282   >10EE                   vbc2:
283   >10EE=>0602                 dec     2
284   >10F0=>15F1                 jgt     vbc0
285                               
286   >10F2=>0380             	rtwp
294   >10F4                   h14         data 14
      >10F4=>000E             
296   >10F6                   vbitline
297                               PUSH   SP, 13, 14
*** <expansion of push>
1     >10F6=>022A >FFFC           ai SP, -2*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >10FA=>CA8D >0002               mov  13 , @(2-0-1)*2(SP)
2     >10FE=>C68E                     mov  14, @(2-1-1)*2(SP)
*** video_bit.i
298                               
299   >1100=>C06C >0008           mov    @8(12), 1   ; X
300   >1104=>C0AC >0006           mov    @6(12), 2   ; Y
301   >1108=>C0EC >0004           mov    @4(12), 3   ; X2
302   >110C=>C12C >0002           mov    @2(12), 4   ; Y2
303                               
304   >1110=>60C1             	s	   1,3          ; X direction = R3-R1
305   >1112=>C1C3             	mov    3,7        
306   >1114=>0747             	abs	   7            ; X distance 
308   >1116=>6102             	s	   2,4          ; Y direction = R4-R2
309   >1118=>C204             	mov    4,8        
310   >111A=>0748             	abs	   8            ; Y distance
312   >111C=>8207             	c	   7,8			; which axis is longer?
313                           						; R6>=0 means Y is longer
314                           						; R6<0  means X is longer
315   >111E=>150A             	jgt	   vbl_x
321   >1120=>020E >11A6           li      14, vbl_ymajor
322                               
323   >1124=>C104                 mov     4, 4        ; going up?
324   >1126=>1505                 jgt     $1+
325                              
326   >1128=>A084                 a       4, 2
327   >112A=>0504                 neg     4           ; make it go the other way
328                               
329   >112C=>C06C >0004           mov     @4(12), 1
330   >1130=>0503                 neg     3           ; minor direction swapped too
331                                
332   >1132                   $1:    
333                               
334   >1132=>100C                 jmp     vbl_plotline
335                               
336   >1134                   vbl_x:
341   >1134=>020E >11D6           li      14, vbl_xmajor
343   >1138=>C0C3                 mov     3, 3        ; going up/left?
344   >113A=>1505                 jgt     $1+
345                              
346   >113C=>A043                 a       3, 1        ; make it go the other way
347   >113E=>0503                 neg     3           
348                               
349   >1140=>C0AC >0002           mov     @2(12), 2
350   >1144=>0504                 neg     4           ; minor direction swapped too
351                               
352                                
353   >1146                   $1:    
354                               
355                               ; Swap major and minor
356   >1146=>C2C3                 mov     3, 11
357   >1148=>C0C4                 mov     4, 3
358   >114A=>C10B                 mov     11, 4
359                               
360   >114C                   vbl_plotline:    
361   >114C=>0584                 inc     4
362                               
363   >114E=>C31C                 mov    *12, 12
364                               
365                               ; get op
366   >1150=>06A0 >1258           bl      @vbitgetdrawfuncandcolor
367                               
369   >1154=>06A0 >1234           bl      @vbl_getaddr       ; get start addr (R1, R2) -> (R0, R1)
370   >1158=>A020 >F78A           a       @vpatts, 0
371                               
372   >115C=>06A0 >1216           bl      @vbl_getfracmags
373                               
374                               ; R7=minor increment
375                               ; R6=minor fraction 
376                               ; R3=minor magnitude
378   >1160=>04C2                 clr    2                ; so we have a clean check for COC
379                               
380   >1162=>020D >2420           li     13, >2420        ; CZC <addr>, 0
381   >1166=>C243                 mov    3, 9
382                               
383   >1168=>1502                 jgt    $2+
384   >116A=>020D >2020           li     13, >2020        ; COC <addr>, 0
385   >116E                   $2:    
386   >116E=>028E >11A6           ci     14, vbl_ymajor
387   >1172=>1605                 jne    $3+
388                               
389   >1174=>022D >0040           ai     13, >40          ; COC|CZC ..., 1
390   >1178=>A0C3                 a      3, 3             ; X shift change is in increments of 2
391   >117A=>0A39                 sla    9, 3             ; adjust direction for X byte change (8 bytes)
392   >117C=>1004                 jmp    vbl_linepixel
394   >117E                   $3:
395   >117E=>C2C9                 mov    9, 11
396   >1180=>0A3B                 sla    11, 3
397   >1182=>0A89                 sla    9, 8
398   >1184=>624B                 s      11, 9             ; adjust direction for Y block change (256-8)    
399                               
400   >1186                   vbl_linepixel:    
412   >1186=>04C2                 clr     2
413   >1188=>0208 >FF8A           li      8, VDPWA
415   >118C=>06A0 >12A2           bl      @vbitreadpixel_
416                                   
417   >1190                   vbl_lineloop:
418   >1190=>0241 >000E           andi   1, >E            ; keep shift in range
419                              ;bl     @vbitdrawpixel_
420                               
421   >1194=>045E                 b      *14              ; next major 
423   >1196                   vbl_lineloopret:    
424   >1196=>0604                 dec    4                ; one pixel consumed
425   >1198=>15FB                 jgt    vbl_lineloop
427   >119A=>06A0 >12AE           bl     @vbitwritepixel_
428                                    
429   >119E=>04CF             	clr    15               ; clr out what we did
430                           	POP    SP, 13, 14
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >11A0=>C3BA                     mov *SP+,  14
2     >11A2=>C37A                     mov *SP+,  13 
*** video_bit.i
431   >11A4=>0380             	rtwp
436   >11A6                   vbl_ymajor:
437   >11A6=>0485                  x       5
438   >11A8=>12EC                  data    vbl_shifts
439                                
440   >11AA=>06A0 >12AE            bl     @vbitwritepixel_
441                               
442   >11AE=>0580                 inc    0                ; new Y
443   >11B0=>2420 >0B3C           czc    #7, 0            ; new block?
444   >11B4=>1604                 jne    $1+              ; nope
446   >11B6=>0220 >00F8           ai     0,256-8          ; next block
447   >11BA=>0240 >1FFF           andi   0, >1fff         ; keep in range
449   >11BE                   $1:    
450   >11BE=>A1C6                 a      6, 7
451   >11C0=>1707                 jnc    $1+              ; new X yet?
452                               
453   >11C2=>A043                 a      3, 1             ; yup, adjust shift
454   >11C4=>048D                 x      13               ; test for going left or right and crossing the byte
455   >11C6=>10F4                 data   h14
456                               
457   >11C8=>1603                 jne    $1+              ; not yet
458                               
459   >11CA=>C080                 mov    0, 2
460   >11CC=>A009                 a      9, 0             ; move across a row (8 bytes)
461   >11CE=>D002                 movb   2, 0             ; keep in range
462   >11D0                   $1:    
463   >11D0=>06A0 >12A2           bl     @vbitreadpixel_
464   >11D4=>10E0                 jmp     vbl_lineloopret
465                               
469   >11D6                   vbl_xmajor: 
470   >11D6=>0485                 x       5
471   >11D8=>12EC                 data    vbl_shifts
472                               
473   >11DA=>05C1                 inct   1                ; adjust shift
474   >11DC=>2460 >10F4           czc    @h14, 1          ; test for going right and crossing the byte
475                               
476   >11E0=>1607                 jne    $1+              ; not yet
477                               
478   >11E2=>06A0 >12AE           bl     @vbitwritepixel_
479                               
480   >11E6=>B820 >0A18 >FC61     ab     #8, @vidws+1     ; move across a row (8 bytes), keeping in range
481                               
482   >11EC=>06A0 >12A2           bl     @vbitreadpixel_
483                               
484   >11F0                   $1:
485                               
486   >11F0=>A1C6                 a      6, 7
487   >11F2=>17D1                 jnc    vbl_lineloopret   ; new Y yet?
489   >11F4=>06A0 >12AE           bl     @vbitwritepixel_
490                               
491   >11F8=>C080                 mov    0, 2             ; remember original address
492                               
493   >11FA=>A003                 a      3, 0             ; yup
494   >11FC=>048D                 x      13               ; new block?
495   >11FE=>032A                 data   h07
496   >1200=>1601                 jne    $2+              ; nope
498   >1202=>A009                 a      9, 0             ; next/previous block
500   >1204                   $2:    
501   >1204=>2880                 xor    0, 2             ; check if wrapped
502   >1206=>1504                 jgt    $3+
503                               
504   >1208=>0240 >1FFF           andi   0, >1fff         ; keep in range
505   >120C=>0220 >F800           ai     0, ->800
506   >1210                   $3:
507   >1210=>06A0 >12A2           bl     @vbitreadpixel_
508   >1214=>10C0                 jmp    vbl_lineloopret
512   >1216                   vbl_getfracmags:
513   >1216=>C183                 mov     3, 6       
514   >1218=>0746                 abs     6         
515   >121A=>04C7                 clr     7
516   >121C=>3D84                 div     4, 6            ; R6=minor increment
517   >121E=>04C7                 clr     7               ; R7=minor fraction 
518   >1220=>1902                 jno     $1+
519                               
520   >1222=>0706                 seto    6               ; close enough to straight
521   >1224=>0707                 seto    7               ; force immediate carry    
522   >1226                   $1:    
523                               
524                               ; Convert R3 to the magnitude for shift adjust (-2, 0, 2)
526   >1226=>C0C3                 mov     3, 3
527   >1228=>0703                 seto    3
528   >122A=>1103                 jlt     $1+
529   >122C=>04C3                 clr     3
530   >122E=>1301                 jeq     $1+
531   >1230=>0583                 inc     3
532                               
533   >1232                   $1:
534   >1232=>045B                 rt
543   >1234                   vbl_getaddr
544                               PUSH    SP, 2, 11
*** <expansion of push>
1     >1234=>022A >FFFC           ai SP, -2*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1238=>CA82 >0002               mov  2 , @(2-0-1)*2(SP)
2     >123C=>C68B                     mov  11, @(2-1-1)*2(SP)
*** video_bit.i
546   >123E=>7041             	sb      1,1    				; scale down X
547   >1240=>C2C1                 mov     1, 11
548                               
549   >1242=>04C1                 clr     1
550   >1244=>3C60 >29B8           div     #192, 1              ; scale down Y (R2=mod)
551   >1248=>C002                 mov     2, 0
553                               ; R0=Y R2=X
554   >124A=>C08B                 mov     11, 2
555   >124C=>06A0 >0F58           bl     @vbitpixeladdr
556                               
557   >1250=>A041                 a      1,1                ; shift in increments of 2 
558                           	
559                               POP    SP,2,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1252=>C2FA                     mov *SP+,  11
2     >1254=>C0BA                     mov *SP+,  2 
*** video_bit.i
560   >1256=>045B             	rt
569   >1258                   vbitgetdrawfuncandcolor
570                               
571   >1258=>04C5                 clr     5
572   >125A=>D14C                 movb    12, 5
573   >125C=>0245 >0F00           andi    5, >F00 
574   >1260=>0975                 srl     5, 7
575   >1262=>C165 >12DC           mov     @vdrawops(5), 5    ; R5 = pattern operation
577   >1266=>0ACC                 sla     12, 12
578   >1268=>F320 >F7BF           socb    @vfgbg+1, 12 ; R12 = color
579                               
580   >126C=>045B                 rt
581                               
587   >126E                   vbl_drawpixel PUSH SP, 5, 8, 11, 12
*** <expansion of push>
1     >126E=>022A >FFF8           ai SP, -4*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1272=>CA85 >0006               mov  5 , @(4-0-1)*2(SP)
2     >1276=>CA88 >0004               mov  8 , @(4-1-1)*2(SP)
3     >127A=>CA8B >0002               mov  11 , @(4-2-1)*2(SP)
4     >127E=>C68C                     mov  12, @(4-3-1)*2(SP)
*** video_bit.i
588   >1280=>06A0 >1258           bl     @vbitgetdrawfuncandcolor
590   >1284=>06A0 >1234           bl     @vbl_getaddr
592   >1288=>0208 >FF8A           li     8,VDPWA    
593   >128C=>06A0 >12A2           bl     @vbitreadpixel_
594                               
595   >1290=>0485                 x      5
596   >1292=>12EC                 data   vbl_shifts
597                            
598   >1294=>06A0 >12AE           bl     @vbitwritepixel_ 
599                               
600                               POP    SP, 5, 8, 11, 12
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1298=>C33A                     mov *SP+,  12
2     >129A=>C2FA                     mov *SP+,  11 
3     >129C=>C23A                     mov *SP+,  8 
4     >129E=>C17A                     mov *SP+,  5 
*** video_bit.i
601   >12A0=>045B                 rt
608   >12A2                   vbitreadpixel_ 
609   >12A2=>D620 >FC61           movb   @vidws+1, *8
610   >12A6=>D600                 movb   0, *8
611                               
612   >12A8=>D0A0 >FF80           movb   @VDPRD, 2            ; get patt byte
613   >12AC=>045B                 rt
621   >12AE                   vbitwritepixel_ 
622   >12AE=>0260 >4000           ori    0, >4000
623   >12B2=>D620 >FC61           movb   @vidws+1, *8
624   >12B6=>D600                 movb   0, *8
625                               
626   >12B8=>D802 >FF88           movb   2, @VDPWD            ; put patt byte
628   >12BC=>D820 >F7CC >F7CC     movb   @vmono,@vmono
629   >12C2=>1609                 jne    $1+
630                                   
631   >12C4=>2820 >07D6           xor    #>2000, 0            ; pattern -> color table
633   >12C8=>D620 >FC61           movb   @vidws+1, *8
634   >12CC=>D600                 movb   0, *8
635                               
636   >12CE=>D80C >FF88           movb   12, @VDPWD          ; put color byte
637                               
638   >12D2=>2820 >07D6           xor    #>2000, 0            ; pattern -> color table
639   >12D6                   $1:
640   >12D6=>0240 >3FFF           andi   0, >3fff            ; turn off write bit    
641   >12DA=>045B                 rt
642                               
644   >12DC                   vdrawops: 
645   >12DC=>F0A1 >F0A1           dw  >F0A1, >F0A1
646   >12E0=>50A1 >28A1           dw  >50A1, >28A1            ; nop is CB
647   >12E4=>90A1 >90A1 >90A1     dw  >90A1, >90A1, >90A1, >90A1
      >12EA=>90A1             
649   >12EC                   vbl_shifts byte >80,0,>40,0,>20,0,>10,0,>8,0,>4,0,>2,0,>1,0
      >12EC=>8000 >4000 >2000 
      >12F2=>1000 >0800 >0400 
      >12F8=>0200 >0100       
660                            Vector vbitcharsmall, vidws
*** <expansion of vector>
1     >12FC                   vbitcharsmall  data vidws, vbitcharsmall_entry
      >12FC=>FC60 >1300       
2     >1300                   vbitcharsmall_entry:    
*** video_bit.i
661   >1300=>0300 >0000       	limi	0
662   >1304=>020A >F740       	li		SP,vstack + vstacksize
664   >1308=>C020 >F7CA       	mov		@vx,0
665   >130C=>C060 >F7A4       	mov		@vcoordaddr,1
666   >1310=>0691             	bl		*1				; get address in 0, shift in 1
668   >1312=>C0C0             	mov		0,3
669   >1314=>0243 >0007       	andi	3,7
670   >1318=>0503             	neg		3
671   >131A=>0223 >0008       	ai		3,8				; R3=# pixels before row block
674   >131E=>C100             	mov		0, 4
676                           	; first, draw with R0 shift and the left 8-shift bit
677                           	
678   >1320=>0705             	seto	5
679   >1322=>D020 >F7A2       	movb	@vbsize, 0
680   >1326=>0980             	srl		0,8
681   >1328=>1301             	jeq		vbscs0				; avoid losing all bits (=16)
682   >132A=>0905             	srl		5, 0				; bitmask
683   >132C                   vbscs0:
684   >132C=>0545             	inv		5				; e.g. FF00 or FC00
686   >132E=>C001             	mov		1,0
687   >1330=>0B05             	src		5,0				; e.g. 03F0
688   >1332=>06A0 >134E       	bl		@vbitcharstrip
690                           	; then draw the next strip over one block
691   >1336=>0201 >0008       	li		1,8
692   >133A=>A001             	a		1,0
693   >133C=>0280 >0008       	ci		0,8
694   >1340=>1205             	jle		vbcsout
695   >1342=>0224 >0008       	ai		4,8
696   >1346=>06C5             	swpb	5
697   >1348=>06A0 >134E       	bl		@vbitcharstrip
698   >134C                   vbcsout:
700   >134C=>0380             	rtwp
702                           	
712   >134E                   vbitcharstrip
713                               PUSH    SP, 0, 1, 3, 4, 7, 8, 9, 11, 12
*** <expansion of push>
1     >134E=>022A >FFEE           ai SP, -9*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1352=>CA80 >0010               mov  0 , @(9-0-1)*2(SP)
2     >1356=>CA81 >000E               mov  1 , @(9-1-1)*2(SP)
3     >135A=>CA83 >000C               mov  3 , @(9-2-1)*2(SP)
4     >135E=>CA84 >000A               mov  4 , @(9-3-1)*2(SP)
5     >1362=>CA87 >0008               mov  7 , @(9-4-1)*2(SP)
6     >1366=>CA88 >0006               mov  8 , @(9-5-1)*2(SP)
7     >136A=>CA89 >0004               mov  9 , @(9-6-1)*2(SP)
8     >136E=>CA8B >0002               mov  11 , @(9-7-1)*2(SP)
9     >1372=>C68C                     mov  12, @(9-8-1)*2(SP)
*** video_bit.i
714   >1374=>C240             	mov		0,9
716                           	; read video memory into RAM
717   >1376=>0202 >F7E6       	li		2,vbitbuf
719                           	; read all the current char bytes and mask off bits to modify
720   >137A=>D220 >F7A3       	movb 	@vbsize+1, 8
721   >137E=>0988             	srl		8,8
723   >1380=>A120 >F78A       	a		@vpatts,4
724   >1384=>C1C4             	mov		4,7
726   >1386=>06A0 >13FC       	bl		@vbitreadstrip
728   >138A=>06A0 >0FDC           bl      @vfetchfontchar
730   >138E=>C107             	mov		7,4
731   >1390=>C004             	mov		4,0
732   >1392=>06A0 >0458       	bl		@vwaddr				; set VDP addr for patt
734   >1396=>C009             	mov		9,0
735   >1398=>C0C8             	mov		8,3
736   >139A                   vbsblit:
737   >139A=>04CC             	clr		12
738   >139C=>D331             	movb	*1+,12
739   >139E=>0B0C             	src		12,0
740   >13A0=>F332             	socb	*2+,12
741   >13A2=>D80C >FF88       	movb	12,@VDPWD
742   >13A6=>0603             	dec		3
743   >13A8=>130A             	jeq 	vbsblit_0
744   >13AA=>0584             	inc		4
745   >13AC=>2520 >032A       	czc		@h07,4
746   >13B0=>16F4             	jne		vbsblit
747   >13B2=>0604             	dec		4
748   >13B4=>06A0 >13DE       	bl		@vbsnextblock
749   >13B8=>0458             	data	vwaddr
750   >13BA=>C009             	mov		9,0
751   >13BC=>10EE             	jmp		vbsblit
753   >13BE                   vbsblit_0:
754   >13BE=>06A0 >039C           bl      @vgetcolorbyte
755   >13C2=>D040                 movb    0,1
756   >13C4=>C107             	mov		7,4
757   >13C6=>06A0 >1440       	bl		@vbitsetcolorstrip
759                               POP     SP, 0, 1, 3, 4, 7, 8, 9, 11, 12
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >13CA=>C33A                     mov *SP+,  12
2     >13CC=>C2FA                     mov *SP+,  11 
3     >13CE=>C27A                     mov *SP+,  9 
4     >13D0=>C23A                     mov *SP+,  8 
5     >13D2=>C1FA                     mov *SP+,  7 
6     >13D4=>C13A                     mov *SP+,  4 
7     >13D6=>C0FA                     mov *SP+,  3 
8     >13D8=>C07A                     mov *SP+,  1 
9     >13DA=>C03A                     mov *SP+,  0 
*** video_bit.i
760   >13DC=>045B             	rt
768   >13DE                   vbsnextblock ; PUSH   SP, 1, 11
769   >13DE=>022A >FFFC       	ai 		SP,-4
770   >13E2=>CA81 >0002       	mov		1,@2(SP)
771   >13E6=>C07B             	mov		*11+,1
772   >13E8=>C68B             	mov 	11,*SP
773   >13EA=>0224 >0100       	ai		4,>100
774   >13EE=>0244 >3FF8       	andi	4,>3ff8
775   >13F2=>C004             	mov		4,0
776   >13F4=>0691             	bl		*1
777   >13F6=>C2FA             	mov 	*SP+, 11
778   >13F8=>C07A             	mov 	*SP+, 1
779   >13FA=>045B             	rt
792   >13FC                   vbitreadstrip PUSH  SP,4, 6, 9, 11
*** <expansion of push>
1     >13FC=>022A >FFF8           ai SP, -4*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1400=>CA84 >0006               mov  4 , @(4-0-1)*2(SP)
2     >1404=>CA86 >0004               mov  6 , @(4-1-1)*2(SP)
3     >1408=>CA89 >0002               mov  9 , @(4-2-1)*2(SP)
4     >140C=>C68B                     mov  11, @(4-3-1)*2(SP)
*** video_bit.i
793   >140E=>C004             	mov		4,0
794   >1410=>06A0 >045C       	bl		@vraddr				; set VDP addr for patt
796                           	; read video memory into RAM
798                           	; read all the current char bytes and mask off bits to modify
800   >1414=>C248             	mov 	8,9
801   >1416                   vbrsrd:
802   >1416=>D1A0 >FF80       	movb 	@VDPRD,6
803   >141A=>5185             	szcb 	5, 6
804   >141C=>DC86             	movb 	6,*2+
805   >141E=>0609             	dec 	9
806   >1420=>1309             	jeq 	vbrsrd_1
807   >1422=>0580             	inc		0
808   >1424=>2420 >032A       	czc		@h07,0
809   >1428=>16F6             	jne		vbrsrd
810   >142A=>0600             	dec		0
811   >142C=>06A0 >13DE       	bl		@vbsnextblock
812   >1430=>045C             	data	vraddr
813   >1432=>10F1             	jmp		vbrsrd
814   >1434                   vbrsrd_1:
815                           	
816   >1434=>6088             	s 		8, 2			; reset buf ptr
818                               POP     SP, 4, 6, 9, 11 
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1436=>C2FA                     mov *SP+,  11
2     >1438=>C27A                     mov *SP+,  9 
3     >143A=>C1BA                     mov *SP+,  6 
4     >143C=>C13A                     mov *SP+,  4 
*** video_bit.i
819   >143E=>045B             	rt
829   >1440                   vbitsetcolorstrip
830                               PUSH    SP, 4, 8, 11
*** <expansion of push>
1     >1440=>022A >FFFA           ai SP, -3*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1444=>CA84 >0004               mov  4 , @(3-0-1)*2(SP)
2     >1448=>CA88 >0002               mov  8 , @(3-1-1)*2(SP)
3     >144C=>C68B                     mov  11, @(3-2-1)*2(SP)
*** video_bit.i
832   >144E=>D820 >F7CC >F7CC 	movb	@vmono,@vmono
833   >1454=>1614             	jne	vbcsnocol
835   >1456=>6120 >F78A       	s		@vpatts,4
836   >145A=>A120 >F78E       	a		@vcolors,4
838   >145E=>C004             	mov		4,0				; draw color
839   >1460=>06A0 >0458       	bl		@vwaddr
841   >1464                   vbsclr:
842   >1464=>D801 >FF88       	movb	1,@VDPWD
843   >1468=>0608             	dec		8
844   >146A=>1309             	jeq		vbcsnocol
845   >146C=>0580             	inc		0
846   >146E=>2420 >032A       	czc		@h07,0
847   >1472=>16F8             	jne		vbsclr
848   >1474=>0600             	dec		0
849   >1476=>06A0 >13DE       	bl		@vbsnextblock
850   >147A=>0458             	data	vwaddr
851   >147C=>10F3             	jmp		vbsclr
853   >147E                   vbcsnocol:
854                               POP     SP, 4, 8, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >147E=>C2FA                     mov *SP+,  11
2     >1480=>C23A                     mov *SP+,  8 
3     >1482=>C13A                     mov *SP+,  4 
*** video_bit.i
855   >1484=>045B             	rt
865   >1486                   vbitfillrect
866                               PUSH    SP,11
*** <expansion of push>
1     >1486=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1488=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_bit.i
868                           	; check for a work in the right part of an 8x8 column
870   >148A=>C041             	mov		1,1			; any shift?
871   >148C=>1317             	jeq		vbfr_mid
873   >148E                   vbfr_left:
874                           	; calc the shift right (for left side)
875   >148E=>0205 >FF00       	li		5,>FF00
877   >1492=>0282 >0008       	ci		2,8
878   >1496=>1405             	jhe		vbfr_fulltoleft
880                           	; not full to the left of the next 8x8 block
881   >1498=>C002             	mov    	2,0
882   >149A=>0240 >0007       	andi	0,7
883   >149E=>0A05             	sla		5,0
885   >14A0=>6082             	s		2,2				; full width taken care of
887   >14A2                   vbfr_fulltoleft:
889   >14A2=>C001             	mov		1,0
890   >14A4=>0240 >0007       	andi	0,7
891   >14A8=>0905             	srl		5,0				; bitmask
893   >14AA=>06A0 >14EC       	bl		@vbitunalignedfill
895   >14AE=>0224 >0008       	ai		4,8				; skip that partial column
897   >14B2=>C082             	mov    	2,2				; already done?
898   >14B4=>1319             	jeq		vbfr_out
900   >14B6=>0222 >0008       	ai		2,8
901   >14BA=>6081             	s		1,2				; remove lhs strip from width to use
905   >14BC                   vbfr_mid:
906   >14BC=>0282 >0008       	ci		2,8
907   >14C0=>1A07             	jl		vbfr_right
909                           	; fill a column of 8xR8 blocks
910   >14C2=>06A0 >154E       	bl		@vbitalignedfill
911   >14C6=>0224 >0008       	ai		4,8
912   >14CA=>0222 >FFF8       	ai		2,-8
913   >14CE=>10F6             	jmp		vbfr_mid
917   >14D0                   vbfr_right:
918   >14D0=>C042             	mov		2,1           	; # pixels remaining
919   >14D2=>0241 >0007       	andi	1,7				; # pixels on right
920   >14D6=>1308             	jeq		vbfr_out
922   >14D8=>0705             	seto	5
924   >14DA=>0200 >0007       	li		0,7
925   >14DE=>6001             	s		1,0
926   >14E0=>1301             	jeq		vbfr_r1
927   >14E2=>0905             	srl		5,0				; bitmask
928   >14E4                   vbfr_r1:
930                           	; adjust patt addr
931                           	
932   >14E4=>06A0 >14EC       	bl		@vbitunalignedfill
934   >14E8                   vbfr_out:
936                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >14E8=>C2FA                     mov *SP+,  11
*** video_bit.i
937   >14EA=>045B             	rt
949   >14EC                   vbitunalignedfill
950                               PUSH    SP, 1, 2, 7, 9, 11, 12
*** <expansion of push>
1     >14EC=>022A >FFF4           ai SP, -6*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >14F0=>CA81 >000A               mov  1 , @(6-0-1)*2(SP)
2     >14F4=>CA82 >0008               mov  2 , @(6-1-1)*2(SP)
3     >14F8=>CA87 >0006               mov  7 , @(6-2-1)*2(SP)
4     >14FC=>CA89 >0004               mov  9 , @(6-3-1)*2(SP)
5     >1500=>CA8B >0002               mov  11 , @(6-4-1)*2(SP)
6     >1504=>C68C                     mov  12, @(6-5-1)*2(SP)
*** video_bit.i
952   >1506=>C1C4             	mov		4,7
953                           	; read video memory into RAM
954   >1508=>0202 >F7E6       	li		2,vbitbuf
956   >150C=>06A0 >13FC       	bl		@vbitreadstrip
958   >1510=>C107             	mov		7,4
959   >1512=>C004             	mov		4,0
960   >1514=>06A0 >0458       	bl		@vwaddr				; set VDP addr for patt
962   >1518=>C248             	mov		8,9
963   >151A                   vbufblit:
964   >151A=>F48C             	socb	12,*2
965   >151C=>D832 >FF88       	movb	*2+,@VDPWD
966   >1520=>0609             	dec		9
967   >1522=>1309             	jeq 	vbufblit_0
968   >1524=>0584             	inc		4
969   >1526=>2520 >032A       	czc		@h07,4
970   >152A=>16F7             	jne		vbufblit
971   >152C=>0604             	dec		4
972   >152E=>06A0 >13DE       	bl		@vbsnextblock
973   >1532=>0458             	data	vwaddr
974   >1534=>10F2             	jmp		vbufblit
976   >1536                   vbufblit_0:
977   >1536=>C04C             	mov		12,1
978   >1538=>06C1             	swpb	1
979   >153A=>C107             	mov		7,4
980   >153C=>06A0 >1440       	bl		@vbitsetcolorstrip
982                               POP     SP, 1, 2, 7, 9, 11, 12
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1540=>C33A                     mov *SP+,  12
2     >1542=>C2FA                     mov *SP+,  11 
3     >1544=>C27A                     mov *SP+,  9 
4     >1546=>C1FA                     mov *SP+,  7 
5     >1548=>C0BA                     mov *SP+,  2 
6     >154A=>C07A                     mov *SP+,  1 
*** video_bit.i
983   >154C=>045B             	rt
994   >154E                   vbitalignedfill
995                               PUSH    SP, 1, 2, 7, 9, 11    
*** <expansion of push>
1     >154E=>022A >FFF6           ai SP, -5*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1552=>CA81 >0008               mov  1 , @(5-0-1)*2(SP)
2     >1556=>CA82 >0006               mov  2 , @(5-1-1)*2(SP)
3     >155A=>CA87 >0004               mov  7 , @(5-2-1)*2(SP)
4     >155E=>CA89 >0002               mov  9 , @(5-3-1)*2(SP)
5     >1562=>C68B                     mov  11, @(5-4-1)*2(SP)
*** video_bit.i
997   >1564=>C1C4             	mov		4,7
998   >1566=>C004             	mov		4,0
999   >1568=>06A0 >0458       	bl		@vwaddr				; set VDP addr for patt
1001  >156C=>C248             	mov		8,9
1002  >156E=>0201 >0007       	li		1,7
1003  >1572                   vbafblit:
1004  >1572=>D80C >FF88       	movb	12,@VDPWD
1005  >1576=>0609             	dec		9
1006  >1578=>1307             	jeq 	vbafblit_0
1007  >157A=>0580             	inc		0
1008  >157C=>2401             	czc		1,0
1009  >157E=>16F9             	jne		vbafblit
1010  >1580=>06A0 >13DE       	bl		@vbsnextblock
1011  >1584=>0458             	data	vwaddr
1012  >1586=>10F5             	jmp		vbafblit
1014  >1588                   vbafblit_0:
1015  >1588=>C04C             	mov		12,1
1016  >158A=>06C1             	swpb	1
1017  >158C=>C107             	mov		7,4
1018  >158E=>06A0 >1440       	bl		@vbitsetcolorstrip
1020                              POP     SP, 1, 2, 7, 9, 11    
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1592=>C2FA                     mov *SP+,  11
2     >1594=>C27A                     mov *SP+,  9 
3     >1596=>C1FA                     mov *SP+,  7 
4     >1598=>C0BA                     mov *SP+,  2 
5     >159A=>C07A                     mov *SP+,  1 
*** video_bit.i
1021  >159C=>045B             	rt
*** nforth.tsm
510                           	incl	video_bit4.i
*** video_bit4.i
26    >159E                   vstdpalette
27    >159E=>0000                 db >00, >00 ;0
28    >15A0=>0000                 db >00, >00 ;1
29    >15A2=>1106                 db >11, >06 ;2
30    >15A4=>3307                 db >33, >07 ;3
31    >15A6=>1701                 db >17, >01 ;4
32    >15A8=>2703                 db >27, >03 ;5
33    >15AA=>5101                 db >51, >01 ;6
34    >15AC=>2706                 db >27, >06 ;7
35    >15AE=>7101                 db >71, >01 ;8
36    >15B0=>7303                 db >73, >03 ;9
37    >15B2=>6106                 db >61, >06 ;A
38    >15B4=>6406                 db >64, >06 ;B
39    >15B6=>1104                 db >11, >04 ;C
40    >15B8=>6502                 db >65, >02 ;D
41    >15BA=>5505                 db >55, >05 ;E
42    >15BC=>7707                 db >77, >07 ;F
43                                
45    >15BE                   venhregs    
46    >15BE=>0808                 dw  >808        ; 64 kvideo RAM
47    >15C0=>0E00                 dw  >e00        ; set bank 0, page 0, etc
48    >15C2=>0980                 dw  >980        ; 212-line mode, color, etc
49    >15C4=>0C00                 dw  >c00        ; turn off alt colors
50    >15C6=>0D00                 dw  >d00        ; turn off blink/pageswap
51    >15C8=>0F00                 dw  >f00        ; point to sr0
52    >15CA=>0000                 dw  0
53                                         
56    >15CC                   venhmode
57                                push SP,R0,R1,R11
*** <expansion of push>
1     >15CC=>022A >FFFA           ai SP, -3*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >15D0=>CA80 >0004               mov  R0 , @(3-0-1)*2(SP)
2     >15D4=>CA81 >0002               mov  R1 , @(3-1-1)*2(SP)
3     >15D8=>C68B                     mov  R11, @(3-2-1)*2(SP)
*** video_bit4.i
58                                
59    >15DA=>0201 >15BE           li      1, venhregs
60    >15DE                   venhmode0:  mov *1+, 0
      >15DE=>C031             
61    >15E0=>1303                 jeq     venhmode1
62    >15E2=>06A0 >046E           bl      @vwreg
63    >15E6=>10FB                 jmp     venhmode0
64    >15E8                   venhmode1:    
65                                pop     SP,R0,R1,R11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >15E8=>C2FA                     mov *SP+,  R11
2     >15EA=>C07A                     mov *SP+,  R1 
3     >15EC=>C03A                     mov *SP+,  R0 
*** video_bit4.i
66    >15EE=>045B                 rt
70    >15F0                   vstatus0
71    >15F0=>0200 >0F00           li      0, >f00
72    >15F4=>0460 >046E           b       @vwreg
73                                
74    >15F8                   vsetpalette
75                                push    SP,R0,R11
*** <expansion of push>
1     >15F8=>022A >FFFC           ai SP, -2*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >15FC=>CA80 >0002               mov  R0 , @(2-0-1)*2(SP)
2     >1600=>C68B                     mov  R11, @(2-1-1)*2(SP)
*** video_bit4.i
76                                ; set std palette
77    >1602=>06A0 >0498           bl      @vwregnext
78    >1606=>1000                 data    >1000
79    >1608=>0200 >159E           li      0, vstdpalette
80    >160C                   vsetpal1 movb *0+, @VDPCL
      >160C=>D830 >FF8C       
81    >1610=>0280 >15BE           ci      0, vstdpalette + 16*2
82    >1614=>16FB                 jne     vsetpal1
83                                pop     SP,R0,R11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1616=>C2FA                     mov *SP+,  R11
2     >1618=>C03A                     mov *SP+,  R0 
*** video_bit4.i
84    >161A=>045B                 rt
89    >161C                   vbitmap4setup
90    >161C=>0201 >05D6           li  1, vbit4
91    >1620                   vbit4sentr:
92                                PUSH    SP,11
*** <expansion of push>
1     >1620=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1622=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_bit4.i
93    >1624=>D820 >0014 >F7CD     movb    #M_bit4,@vidmode
95    >162A=>06A0 >076A           bl  @vsetupregs
96    >162E=>06A0 >079E           bl  @vsetupaddrs
97    >1632=>06A0 >15CC           bl  @venhmode
98                                
99    >1636=>C831 >F7B6           mov *1+,@vbit4stride
100   >163A=>C831 >F7B8           mov *1+,@vbit4shift
101   >163E=>C831 >F7BA           mov *1+,@vbit4mask
103   >1642=>C801 >F7C8           mov 1,@vtermptr
104   >1646=>06A0 >15F8           bl  @vsetpalette
105                               
106                               POP SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >164A=>C2FA                     mov *SP+,  11
*** video_bit4.i
107   >164C=>045B                 rt
109   >164E                   vbitmap5setup
110   >164E=>0201 >060A           li  1, vbit5
111   >1652=>10E6                 jmp vbit4sentr
113   >1654                   vbitmap6setup
114   >1654=>0201 >0640           li  1, vbit6
115   >1658=>10E3                 jmp vbit4sentr
117   >165A                   vbitmap7setup
118   >165A=>0201 >0674           li  1, vbit7
119   >165E=>10E0                 jmp vbit4sentr
131   >1660                   vbit4xaddr 
132                               PUSH    SP,2
*** <expansion of push>
1     >1660=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1662=>C682                     mov  2, @(1-0-1)*2(SP)
*** video_bit4.i
134   >1664=>A020 >F7C2           a       @vwx, 0
135                               
136                               ; scale Y by vbsize
137   >1668=>C040                 mov     0,1
138   >166A=>7041                 sb      1,1
139   >166C=>D0A0 >F7A3           movb    @vbsize+1,2
140   >1670=>0982                 srl     2,8
141   >1672=>3881                 mpy     1,2             ; 2=xxx, 3=row#
142                               
143   >1674=>C043                 mov     3,1
144   >1676=>3860 >F7B6           mpy     @vbit4stride, 1 ; 2=addr
145                               
146                               ; scale X by vbsize
147   >167A=>0980                 srl     0,8
148   >167C=>D060 >F7A2           movb    @vbsize,1
149   >1680=>0981                 srl     1,8    
150   >1682=>3801                 mpy     1,0             ; 0=xxx, 1=X scaled 
151                               
152   >1684=>C0C1                 mov     1,3
153   >1686=>C020 >F7B8           mov     @vbit4shift,0
154   >168A=>1301                 jeq     vb4xnoshift
155   >168C=>0901                 srl     1,0             ; R1=offset
156   >168E                   vb4xnoshift:
157   >168E=>A081                 a       1,2             ; R2=full addr
158   >1690=>C002                 mov     2,0             ; R0=full addr
159                               
160   >1692=>C043                 mov     3,1             ; preshifted X
161   >1694=>4060 >F7BA           szc     @vbit4mask,1    ; R1=portion
162                               
163                               POP     SP,2
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1698=>C0BA                     mov *SP+,  2
*** video_bit4.i
164   >169A=>045B                 rt
172   >169C                   vcoordsend:
173   >169C=>06C0             	swpb	0
174   >169E=>D500             	movb	0, *4
175   >16A0=>06C0             	swpb	0
176   >16A2=>D500             	movb	0, *4
177   >16A4=>045B             	rt
183   >16A6                   vcmdsetup
184   >16A6=>C03B                 mov     *11+, 0  
185                               PUSH    SP, 11
*** <expansion of push>
1     >16A8=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >16AA=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_bit4.i
186                               
187   >16AC=>0260 >1100           ori     0,>1100
188   >16B0=>06A0 >046E           bl      @vwreg
189                               
190   >16B4=>0204 >FF8E           li      4, VDPWI
191                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >16B8=>C2FA                     mov *SP+,  11
*** video_bit4.i
192   >16BA=>045B                 rt
201   >16BC                   vbit4xsetupcursorDXDY
202                               PUSH    SP, 11
*** <expansion of push>
1     >16BC=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >16BE=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_bit4.i
203   >16C0=>A020 >F7C2           a       @vwx, 0
204                               
205                               ; scale Y by vbsize
206   >16C4=>C040                 mov     0,1
207   >16C6=>7041                 sb      1,1
208   >16C8=>D0A0 >F7A3           movb    @vbsize+1,2
209   >16CC=>0982                 srl     2,8
210   >16CE=>3881                 mpy     1,2             ; 2=xxx, 3=row#
211                               
212                               ; account for the "big page"
213   >16D0=>A0E0 >FF6E           a       @vpgrow, 3
214                               
215   >16D4=>0980                 srl     0,8
216   >16D6=>D060 >F7A2           movb    @vbsize,1
217   >16DA=>0981                 srl     1,8    
218   >16DC=>3801                 mpy     1,0             ; 0=xxx, 1=X scaled 
220   >16DE=>06A0 >16A6           bl      @vcmdsetup
221   >16E2=>0024                 data    >24
222                               
223   >16E4=>C001                 mov     1, 0
224   >16E6=>06A0 >169C           bl      @vcoordsend     ; send DX
225   >16EA=>C003                 mov     3, 0
226   >16EC=>06A0 >169C           bl      @vcoordsend     ; send DY
227                               
228                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >16F0=>C2FA                     mov *SP+,  11
*** video_bit4.i
229   >16F2=>045B                 rt
230                               
237   >16F4                   vbit4xsetupwindowlineNXNY
238                               push    SP, 11
*** <expansion of push>
1     >16F4=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >16F6=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_bit4.i
239                               
240   >16F8=>04C1                 clr     1
241   >16FA=>D060 >F7A2           movb    @vbsize,1       ; X size (hi)
242   >16FE=>04C2                 clr     2
243   >1700=>D0A0 >F7C4           movb    @vwxs,2         ; X (hi)
244   >1704=>3881                 mpy     1,2             ; 2=col #  (3 = 0)
245   >1706=>C002                 mov     2, 0
246   >1708=>0600                 dec     0
247   >170A=>06A0 >169C           bl      @vcoordsend     ; NX
248                               
249                               ; height is vbsize
250   >170E=>D020 >F7A3           movb    @vbsize+1,0
251   >1712=>0980                 srl     0,8
252   >1714=>0600                 dec     0      
253   >1716=>06A0 >169C           bl      @vcoordsend     ; NY
254                               
255                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >171A=>C2FA                     mov *SP+,  11
*** video_bit4.i
256   >171C=>045B                 rt
265   >171E                   vbit4xsetupwindowcharNXNY
266                               push    SP, 11
*** <expansion of push>
1     >171E=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1720=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_bit4.i
267                               
268   >1722=>D0A0 >F7A2           movb    @vbsize,2      
269   >1726=>0982                 srl     2,8
270   >1728=>C002                 mov     2,0
271   >172A=>0600                 dec     0
272   >172C=>06A0 >169C           bl      @vcoordsend     ; NX
273                               
274   >1730=>D0E0 >F7A3           movb    @vbsize+1,3
275   >1734=>0983                 srl     3,8
276   >1736=>C003                 mov     3,0
277   >1738=>0600                 dec     0
278   >173A=>06A0 >169C           bl      @vcoordsend     ; NY
279                               
280                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >173E=>C2FA                     mov *SP+,  11
*** video_bit4.i
281   >1740=>045B                 rt
282                               
296   >1742                   vbit4xsetupMMMcommand
297                               push    SP,11
*** <expansion of push>
1     >1742=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1744=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_bit4.i
298                               
299   >1746=>06A0 >0498           bl      @vwregnext
300   >174A=>0F02                 data    >0f02        ; set status reg for testing command finished & transfer ready
301                               
302                               ; wait for ready
303   >174C                   vb4xclr:
304   >174C=>D020 >FF82           movb    @VDPST,0
305   >1750=>0240 >0100           andi    0, >0100
306   >1754=>16FB                 jne     vb4xclr
308                               ; write the command
309   >1756=>D509                 movb    9, *4 
310                               
311                               ; back to the CLR reg, no autoincrement
312   >1758=>06A0 >0498           bl      @vwregnext
313   >175C=>11AC                 data    >11AC
314                               
315                               pop     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >175E=>C2FA                     mov *SP+,  11
*** video_bit4.i
316   >1760=>045B                 rt
317                               
318                               
330   >1762                   vbit4xclearline
331                               PUSH    SP,0,3,11
*** <expansion of push>
1     >1762=>022A >FFFA           ai SP, -3*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1766=>CA80 >0004               mov  0 , @(3-0-1)*2(SP)
2     >176A=>CA83 >0002               mov  3 , @(3-1-1)*2(SP)
3     >176E=>C68B                     mov  11, @(3-2-1)*2(SP)
*** video_bit4.i
333   >1770=>06A0 >16BC           bl      @vbit4xsetupcursorDXDY
334   >1774=>06A0 >16F4           bl      @vbit4xsetupwindowlineNXNY
336   >1778=>D520 >F7BF           movb    @vfgbg+1, *4    ; CLR
338   >177C=>D520 >0019           movb    #>00, *4        ; ARG (dix=0, diy=0, mxc=0)
340   >1780=>0209 >8000           li      9, >8000        ; HMMV  (terminal is usually aligned)
341   >1784=>06A0 >1742           bl      @vbit4xsetupMMMcommand
342                               
343                               ; don't wait :)
344                               ;li      2, >0100
345                               ;li      3, VDPST
347                           	; see if done
348                           	;movb	*3,0
349                           	;coc		2, 0
350                           	;jeq		vb4xcl
352   >1788                   vb4xclout:			
353                               POP		SP,0,3,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1788=>C2FA                     mov *SP+,  11
2     >178A=>C0FA                     mov *SP+,  3 
3     >178C=>C03A                     mov *SP+,  0 
*** video_bit4.i
354   >178E=>045B             	rt
355                           	
363   >1790                   vsetbank
364   >1790=>064A                 dect    SP
365   >1792=>C680                 mov     0,*SP
366   >1794=>0960                 srl     0, 6
367   >1796=>B020 >FF6C           ab      @vpob, 0
368   >179A=>D800 >FF8A           movb    0, @VDPWA
369   >179E=>C03A                 mov     *SP+,0
370   >17A0=>D820 >0C27 >FF8A     movb    #>8e,@VDPWA
371   >17A6=>0240 >3FFF           andi    0,>3fff
372   >17AA=>045B                 rt
377                               
378   >17AC                   vbit4xsendcharpixel
379   >17AC=>0A17                 sla     7,1
380   >17AE=>1703                 jnc     vbit4xscpon
381   >17B0=>D520 >FC79           movb    @vidws+25, *4       ; CLR
382   >17B4=>045B                 rt
383   >17B6                   vbit4xscpon:    
384   >17B6=>D50C                 movb    12, *4              ; CLR
385   >17B8=>045B                 rt
386                               
394                            Vector vbit4xchar, vidws
*** <expansion of vector>
1     >17BA                   vbit4xchar  data vidws, vbit4xchar_entry
      >17BA=>FC60 >17BE       
2     >17BE                   vbit4xchar_entry:    
*** video_bit4.i
395   >17BE=>0300 >0000           limi    0
396   >17C2=>020A >F740           li      SP,vstack + vstacksize
398   >17C6=>C020 >F7CA           mov     @vx, 0
399   >17CA=>06A0 >16BC           bl      @vbit4xsetupcursorDXDY
400                               ; R4 = VDPWI
401                               
402   >17CE=>06A0 >171E           bl      @vbit4xsetupwindowcharNXNY
403                               ; R2 = X size, R3 = Y size
404                               
405   >17D2=>06A0 >0FDC           bl      @vfetchfontchar
407   >17D6=>C320 >F7BE           mov     @vfgbg,12
408   >17DA=>06CC                 swpb    12
409   >17DC=>D1F1                 movb    *1+, 7               ; fetch first row
410   >17DE=>06A0 >17AC           bl      @vbit4xsendcharpixel  ; send first CLR
412   >17E2=>D520 >0019           movb    #0, *4              ; ARG (dix=0, diy=0, mxc=0)
413                               
414   >17E6=>0209 >B800           li      9, >B800            ; LMMC + TINP
415   >17EA=>06A0 >1742           bl      @vbit4xsetupMMMcommand
417   >17EE=>C202                 mov     2, 8                ; R8 = ctr for column
418   >17F0=>0608                 dec     8                   ; from first pixel above
419                               
420   >17F2                   vbit4xchar_row
421                               ; R7 holds char, R8 is column ctr
422                               
423   >17F2                   vb4xchp:
424                               ; see if ready
425   >17F2=>D020 >FF82           movb    @VDPST,0
426   >17F6=>1101                 jlt     vbit4xchar_pixel
427   >17F8=>10FC                 jmp     vb4xchp
429   >17FA                   vbit4xchar_pixel:    
430   >17FA=>06A0 >17AC           bl      @vbit4xsendcharpixel
431                               
432   >17FE=>0608                 dec     8
433   >1800=>15F8                 jgt     vb4xchp
434                               
435   >1802=>C202                 mov     2, 8
436   >1804=>D1F1                 movb    *1+, 7
437   >1806=>0603                 dec     3
438   >1808=>15F4                 jgt     vbit4xchar_row
439                                   
440   >180A=>06A0 >15F0           bl      @vstatus0
441   >180E=>0380                 rtwp
449                            Vector vbit4xcursor, vidws
*** <expansion of vector>
1     >1810                   vbit4xcursor  data vidws, vbit4xcursor_entry
      >1810=>FC60 >1814       
2     >1814                   vbit4xcursor_entry:    
*** video_bit4.i
451   >1814=>0300 >0000           limi   0
452   >1818=>020A >F740           li     SP,vstack + vstacksize
454   >181C=>C020 >F7CA           mov     @vx, 0
455   >1820=>06A0 >16BC           bl      @vbit4xsetupcursorDXDY
456                               ; R4 = VDPWI
457                               
458   >1824=>0200 >0001           li      0, 1            ; two cols
459   >1828=>06A0 >169C           bl      @vcoordsend         ; NX
460                               
461   >182C=>D020 >F7A3           movb    @vbsize+1, 0
462   >1830=>0980                 srl     0,8
463   >1832=>0600                 dec     0
464   >1834=>06A0 >169C           bl      @vcoordsend         ; NY
466   >1838=>D520 >046B           movb    #>ff, *4            ; CLR
468   >183C=>D520 >0019           movb    #0, *4              ; ARG (dix=0, diy=0, mxc=0)
469                               
470   >1840=>0209 >8300           li      9, >8300            ; LMMV + EOR
471   >1844=>06A0 >1742           bl      @vbit4xsetupMMMcommand
473   >1848=>B820 >005F >F7AA     ab  #>80,@vcurs
475   >184E=>06A0 >15F0           bl      @vstatus0
476                               ; no need to wait!
477                               
478   >1852=>0380                 rtwp
498   >1854                   vbitsetupDXDYNXNYsigned
499                               PUSH    SP,11
*** <expansion of push>
1     >1854=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1856=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_bit4.i
500                               
501                               ; R2 is original ARG byte, but has $8000 mask for LINE
502                               
503                               ; adjust dx and dix
504   >1858=>C021 >0002           mov @2(1) , r0   ; nx
505   >185C=>1503                 jgt vbsdns0
506                               
507   >185E=>0262 >0004           ori R2 , 4     ; DIX
508   >1862=>0740                 abs r0
509   >1864                   vbsdns0:
510                               
511                               ; adjust dy and diy
512                               
513   >1864=>C0D1                 mov *1 , r3     ; ny
514   >1866=>1503                 jgt vbsdns1
515                               
516   >1868=>0262 >0008           ori R2 , 8     ; DIY
517   >186C=>0743                 abs r3
518   >186E                   vbsdns1:
519                               
520                               ; -------------
521                               
522   >186E=>C082                 mov R2 , R2       ; is this a LINE command?
523   >1870=>1508                 jgt vbsdns2
524   >1872=>1307                 jeq vbsdns2
525                               
526   >1874=>80C0                 c r0 , r3           ; compare X and Y lengths
527   >1876=>1B05                 jh vbsdns2
528   >1878=>0262 >0001           ori R2 , 1          ; Y is major
529                               
530   >187C=>C2C3                 mov r3 , 11         ; swap DX / DY
531   >187E=>C0C0                 mov r0 , r3
532   >1880=>C00B                 mov 11 , r0
533                               
534                               ; -------------
536   >1882                   vbsdns2:    
537   >1882=>C840 >0002           mov r0 , @2(1)
538   >1886=>C443                 mov r3 , *1
540   >1888=>1002                 jmp vbsdn0
554   >188A                   vbitsetupDXDYNXNY:
555                               PUSH    SP, 11
*** <expansion of push>
1     >188A=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >188C=>C68B                     mov  11, @(1-0-1)*2(SP)
*** video_bit4.i
556                               
557   >188E                   vbsdn0:
558   >188E=>0203 >169C           li      3, vcoordsend
559                               
560   >1892=>C021 >0006           mov     @6(1) , 0
561   >1896=>0693                 bl      *3        ; DX
563   >1898=>C021 >0004           mov     @4(1) , 0
564   >189C=>A020 >FF6E           a       @vpgrow , 0
565   >18A0=>0693                 bl      *3         ; DY
567   >18A2=>C021 >0002           mov     @2(1) , 0
568   >18A6=>0693                 bl      *3         ; NX
570   >18A8=>C011                 mov     *1 , 0
571   >18AA=>0693                 bl      *3        ; NY
573   >18AC=>06C2                 swpb    2
574                               
575                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >18AE=>C2FA                     mov *SP+,  11
*** video_bit4.i
576   >18B0=>045B                 rt
*** nforth.tsm
511                           	incl	kbd.i
*** kbd.i
24    >18B2                   kinit
25                                ;   reset clears all memory
27    >18B2=>C820 >29BA >F90C     mov    #>1e03,@kbdlimit  ; 1/2 s before repeat, 1/20 s delay between repeat
28                            	
29    >18B8=>045B             	rt
45    >18BA                   scankbd	mov	11,10
      >18BA=>C28B             
47    >18BC=>04CC             	clr		12
48    >18BE=>1D15             	sbo		21		 	; clear alpha lock line
50    >18C0=>04C1             	clr		1		 	; read char
52    >18C2=>020C >0024       	li		12,>24	 	; kbd select
53    >18C6=>04C3             	clr		3			; row * >100
54    >18C8=>30C3             	ldcr	3,3		 	; set
56    >18CA=>020C >0006       	li		12,>6	 	; kbd matrix
57    >18CE=>3604             	stcr	4,8		 	; get row 0
58    >18D0=>0544             	inv		4			; 0=off 1=on
59                            	
60    >18D2=>04C5             	clr     5
61    >18D4=>9120 >03CD       	cb      #>72, 4     ; ctrl+fctn+shift+space (abort)?
62    >18D8=>1601             	jne     sknobreak
63                            	
64    >18DA=>0705             	seto    5           ; remember for later
65                            	
66    >18DC                   sknobreak:	
67    >18DC=>C084             	mov		4,2			; copy to R2=shifts
68    >18DE=>0242 >7000       	andi	2,>7000		; save 0=off 1=on (shifts)
69    >18E2=>D802 >F8E9       	movb	2,@kbdshft	; save shift
70    >18E6=>0244 >0700       	andi	4,>0700		; mask =, space, enter
71    >18EA=>1003             	jmp		skloop0
73    >18EC                   skloop:
74    >18EC=>0704             	seto	4		 	; set low bits too	
75    >18EE=>3604             	stcr	4,8		 	; read 8 bits
76    >18F0=>0544               	inv		4		 	; 0=off 1=on
77    >18F2                   skloop0:
78    >18F2=>160B             	jne		skgotsome	; any bits set?
79    >18F4=>0223 >0100       	ai		3,>100
80    >18F8=>0283 >0600       	ci		3,>600		; stop at joystick
81    >18FC=>130C             	jeq		skblank
83    >18FE=>020C >0024       	li		12,>24		; point to kbd select
84    >1902=>30C3             	ldcr	3,3		 	; set new row #
85    >1904=>020C >0006       	li		12,>6	 	; point to matrix
86    >1908=>10F1             	jmp		skloop
88    >190A                   skgotsome:
89    >190A=>0953             	srl		3,5		 	; entry into table
90    >190C=>06C4             	swpb	4		 	; move to low byte so we can
91    >190E                   skwhich:
92    >190E=>0914             	srl		4,1			; roll down
93    >1910=>1808             	joc		skdone	 	; this bit?
94    >1912=>0583             	inc		3			; next
95    >1914=>10FC             	jmp		skwhich
97    >1916                   skblank:
98    >1916=>D801 >F8E8       	movb	1,@kbdscan	; no key whatsoever
100   >191A=>D0E0 >F8E9       	movb	@kbdshft,3	; shifts?
101   >191E=>130A             	jeq		sknone
103   >1920=>1002             	jmp		sknone0
105   >1922                   skdone:	
106   >1922=>06A0 >193E       	bl		@kbdhandle
107   >1926                   sknone0:
108   >1926=>A820 >F784 >F910     a       @timeout,@randnoise
109   >192C=>04E0 >F784           clr     @timeout
110   >1930=>06A0 >04EC       	bl     	@vscreenon
112   >1934                   sknone:
113   >1934=>D801 >F8E6       	movb	1,@kbdlast	   	; update last char
114   >1938=>A801 >F910       	a		1,@randnoise
116   >193C=>045A             	b		*10
120   >193E                   kbdhandle
131   >193E=>09B2             	srl		2,11		 	; get shift state
132                           	ai		2,grom_kbdlist	
134   >1940=>0209 >FF92           li      9,GPLRA
135   >1944=>D219             	movb	*9,8	      ; save GROM addr in R8
136   >1946=>06C8             	swpb    8
137   >1948=>D219             	movb	*9,8
138   >194A=>06C8             	swpb    8
139   >194C=>0608             	dec		8
141   >194E=>020C >FF96       	li		12,GPLWA
142   >1952=>D702             	movb	2,*12			; point to grom kbd list
143   >1954=>06C2             	swpb	2
144   >1956=>D702             	movb	2,*12
146   >1958=>0649                 dect    9
147   >195A=>D099             	movb	*9,2		   ; get table entry
148   >195C=>06C2             	swpb	2
149   >195E=>D099             	movb	*9,2		   ; it's flipped in GROM
150   >1960=>06C2             	swpb	2				
152   >1962=>A083             	a		3,2		 		; get offset
154   >1964=>D702             	movb	2,*12			; point to char
155   >1966=>06C2             	swpb	2
156   >1968=>D702             	movb	2,*12
157                           	
158   >196A=>D059             	movb	*9,1      	 	; R1=key code, 0-255
160   >196C=>D708             	movb	8,*12	    	; restore GROM addr
161   >196E=>06C8             	swpb    8
162   >1970=>D708             	movb	8,*12
164   >1972=>04CC             	clr		12
165   >1974=>1E15             	sbz		21		 	; turn on alpha lock line
166   >1976=>1F07             	tb		7
167   >1978=>1308             	jeq		khnoalpha
168                           		
169   >197A=>0281 >6100       	ci		1,>6100		; alpha lock on; 
170   >197E=>1A05             	jl		khnoalpha	; test 'a'-'z'
171   >1980=>0281 >7B00       	ci		1,>7b00
172   >1984=>1402             	jhe		khnoalpha
173   >1986=>0221 >E000       	ai		1,->2000	; uppercase
175   >198A                   khnoalpha:
176   >198A=>1D15             	sbo		21
177   >198C=>0583             	inc     3
178   >198E=>06C3             	swpb	3			; put scancode in hi byte
180   >1990                   khtestbuffer:
181   >1990=>0A14             	sla		4,1		 	; kbd_poll set?
182   >1992=>183E             	joc		khnone
184                           	; HACK!  Fctn-Shift-S is treated as Ctrl-H
185   >1994=>9060 >0B34       	cb		#211, 1
186   >1998=>1606             	jne		$0+
187   >199A=>9820 >03FD >F8E9 	cb		#>30, @kbdshft
188   >19A0=>1602             	jne		$0
189                           	
190   >19A2=>0201 >0800       	li		1,>0800
191                           	
192   >19A6                   $0:
193   >19A6=>F041             	socb	1,1
194   >19A8=>1601             	jne		khbuffer   	; got something
196   >19AA=>1032             	jmp		khnone
202   >19AC                   khbuffer:	
203   >19AC=>9803 >F8E8       	cb		3,@kbdscan 	       ; scancode the same?
204   >19B0=>1611             	jne		khnew
206   >19B2=>D0A0 >F90E       	movb	@kbdflag, 2      	; get flags
207   >19B6=>B082             	ab      2,2
208   >19B8=>1705             	jnc		khb4repeat          ; repeating yet?
210   >19BA=>9820 >F8E7 >F90D 	cb		@kbdtimer,@kbddelay ; time for new repeat?
211   >19C0=>1A27             	jl		khnone
212   >19C2=>100D             	jmp		khstuff
214   >19C4                   khb4repeat:
215   >19C4=>9820 >F8E7 >F90C 	cb		@kbdtimer,@kbdlimit ; repeated long enough yet?
216   >19CA=>1A22             	jl		khnone		     	; no
217                           	
218   >19CC=>F820 >005F >F90E     socb    #>80,@kbdflag       ; set repeat flag
219                           	
220   >19D2=>1005             	jmp		khstuff
222   >19D4                   khnew:
223   >19D4=>5820 >005F >F90E 	szcb	#>80,@kbdflag	    ; clear repeat flag
224   >19DA=>D803 >F8E8       	movb	3,@kbdscan			; save new scancode
226   >19DE                   khstuff:
227   >19DE=>7820 >F8E7 >F8E7 	sb		@kbdtimer,@kbdtimer ; restart timer
229   >19E4=>C145                 mov     5,5                 ; check abort flag
230   >19E6=>1306                 jeq     khstuffit
231                               
232   >19E8=>04E0 >F8EA           clr     @kbdhead
233   >19EC=>04E0 >F90E           clr     @kbdflag
234   >19F0=>0460 >0070           b       @ABORT
236   >19F4                   khstuffit:
237   >19F4=>D0A0 >F8EB       	movb	@kbdtail,2	       	; get current pos in ring
238   >19F8=>0982                 srl     2,8
239   >19FA=>D881 >F8EC       	movb	1,@kbdbuf(2)	    ; buffer it
240   >19FE=>0582             	inc		2		     		; inc...
241   >1A00=>0242 >001F       	andi	2,kbdbufsize-1	    ; roll over if necc
242   >1A04=>06C2             	swpb	2
243   >1A06=>9802 >F8EA       	cb		2,@kbdhead	     	; overflow if equal!
244   >1A0A=>1302             	jeq		khnone		     	; eeeer... don't update ptrs
246   >1A0C=>D802 >F8EB       	movb	2,@kbdtail	     	; update
248   >1A10                   khnone:
250   >1A10                   khout:
251   >1A10=>045B             	rt
263   >1A12                   kbdavail 
272   >1A12=>9820 >F8EA >F8EB 	cb		@kbdhead,@kbdtail	; EQ=1 means none
273   >1A18=>045B             	rt
285   >1A1A                   kbdread	   
295   >1A1A=>04C1             	clr		1
296   >1A1C=>9820 >F8EA >F8EB 	cb		@kbdhead,@kbdtail
297   >1A22=>130C             	jeq		krbempty
298   >1A24=>D060 >F8EA       	movb	@kbdhead,1			; get head ptr
299   >1A28=>B820 >01BB >F8EA 	ab		#1,@kbdhead		; and inc...
300   >1A2E=>5820 >0079 >F8EA 	szcb	#-kbdbufsize,@kbdhead	; mask...
301   >1A34=>06C1             	swpb	1					; and make offset
302   >1A36=>D021 >F8EC       	movb	@kbdbuf(1),0		; and retrieve!
303   >1A3A=>0980             	srl		0,8
304   >1A3C                   krbempty:
305   >1A3C=>045B             	rt
*** nforth.tsm
512                           	
513                           	incl	term.i
*** term.i
30    >1A3E                   treset  	
31    >1A3E=>04E0 >F7CA       	clr	   @vx			    ; upper-left corner
32    >1A42=>04E0 >F7C2       	clr	   @vwx			    ; window starts upper-left
33    >1A46=>D820 >F7B5 >F7C4 	movb   @vwidth+1,@vwxs	; set dims to screen size
34    >1A4C=>D820 >F7B3 >F7C5 	movb   @vheight,@vwys	; set dims to screen size
35    >1A52=>045B             	rt
55    >1A54                   window	PUSH    SP,11
*** <expansion of push>
1     >1A54=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1A56=>C68B                     mov  11, @(1-0-1)*2(SP)
*** term.i
57    >1A58=>06A0 >0A5C       	bl	    @vcursoroff			; clear cursor stuff
59    >1A5C=>D0A0 >F7B5       	movb   @vwidth+1,2
60    >1A60=>9080             	cb     0,2				; check left coord
61    >1A62=>1A01             	jl     wxlookay			; lower, okay
62    >1A64=>7000             	sb     0,0				; fix to edge
63    >1A66                   wxlookay:
64    >1A66=>D800 >F7C2       	movb   0,@vwx			; save 
65    >1A6A=>B001             	ab	   1,0				; get right coord
66    >1A6C=>1802             	jc	   wxxover
67    >1A6E=>9080             	cb	   0,2				; lower or equal, okay
68    >1A70=>1203             	jle    wxhiokay			
69    >1A72                   wxxover:
70    >1A72=>D042             	movb	2,1
71    >1A74=>7060 >F7C2       	sb	    @vwx,1			; fix R1 to that width
72    >1A78                   wxhiokay:
73    >1A78=>D801 >F7C4       	movb	1,@vwxs
75    >1A7C=>06C0             	swpb	0				; point to Y 
76    >1A7E=>06C1             	swpb	1				; coordinates
77    >1A80=>D0A0 >F7B3       	movb   @vheight, 2
79    >1A84=>9080             	cb     0,2				; check top coord
80    >1A86=>1201             	jle    wylookay			; lower, okay
81    >1A88=>7000             	sb     0,0				; fix to edge
82    >1A8A                   wylookay:
83    >1A8A=>D800 >F7C3       	movb   0,@vwy		    ; save 
84    >1A8E=>B001             	ab     1,0				; get bottom coord
85    >1A90=>1802             	jc     wyyover
86    >1A92=>9080             	cb     0,2				; lower or equal, okay
87    >1A94=>1203             	jle    wyhiokay			
88    >1A96                   wyyover:
89    >1A96=>D042             	movb   2,1
90    >1A98=>7060 >F7C3       	sb     @vwy,1				; fix R1 to that height
91    >1A9C                   wyhiokay:
92    >1A9C=>D801 >F7C5       	movb   1,@vwys
94    >1AA0=>04E0 >F7CA       	clr	   @vx				; clear coords
96                                POP    SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1AA4=>C2FA                     mov *SP+,  11
*** term.i
97    >1AA6=>045B             	rt
106   >1AA8                   printchar PUSH  SP, 11
*** <expansion of push>
1     >1AA8=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1AAA=>C68B                     mov  11, @(1-0-1)*2(SP)
*** term.i
107   >1AAC=>06A0 >0A5C       	bl	    @vcursoroff			; we're movin', buddy!
109   >1AB0=>D801 >F7C0       	movb	1,@vch
110   >1AB4=>C060 >F79C       	mov	    @vdrawchar,1
111   >1AB8=>0411             	blwp	*1  				; print char
113   >1ABA=>B820 >01BB >F7CA 	ab	    #1,@vx	     		; add a space
114   >1AC0=>1804             	jc	    prchwr				; carried, thus wrapped
115   >1AC2=>9820 >F7CA >F7C4 	cb	    @vx,@vwxs			; edge of window?
116   >1AC8=>1A02             	jl	    prchout				; no, we're okay
117   >1ACA                   prchwr:
118   >1ACA=>06A0 >1BBC       	bl	    @crlf
120   >1ACE                   prchout:
121                               POP SP, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1ACE=>C2FA                     mov *SP+,  11
*** term.i
122   >1AD0=>045B             	rt
132   >1AD2                   gotoxy	PUSH SP, 11
*** <expansion of push>
1     >1AD2=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1AD4=>C68B                     mov  11, @(1-0-1)*2(SP)
*** term.i
134   >1AD6=>06A0 >0A5C       	bl	    @vcursoroff			; we're moving it!
136   >1ADA=>9800 >F7C4       	cb	    0,@vwxs
137   >1ADE=>1A04             	jl	    gxyokayx
138   >1AE0=>D020 >F7C4       	movb	@vwxs,0
139   >1AE4=>7020 >01BB       	sb 	    #1,0
140   >1AE8                   gxyokayx:
141   >1AE8=>06C0             	swpb	0
142   >1AEA=>9800 >F7C5       	cb	    0,@vwys
143   >1AEE=>1A04             	jl	    gxyokayy
144   >1AF0=>D020 >F7C5       	movb	@vwys,0
145   >1AF4=>7020 >01BB       	sb	    #1,0
146   >1AF8                   gxyokayy:
147   >1AF8=>06C0             	swpb	0
148   >1AFA=>C800 >F7CA       	mov	    0,@vx
150                               POP     SP, 11    
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1AFE=>C2FA                     mov *SP+,  11
*** term.i
151   >1B00=>045B             	rt
164   >1B02                   termscroll
165                               PUSH    SP,11
*** <expansion of push>
1     >1B02=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1B04=>C68B                     mov  11, @(1-0-1)*2(SP)
*** term.i
166                               
167   >1B06=>C0E0 >F7A0           mov     @vclearline, 3
169   >1B0A=>D0A0 >F7C4           movb    @vwxs,2             ; length
170   >1B0E=>0982                 srl     2,8
172   >1B10=>C020 >F7CA           mov     @vx,0
173   >1B14=>7000                 sb      0,0                 ; get coord for lower-left
174                               
175   >1B16=>064A                 dect    SP
176   >1B18=>C682                 mov     2,*SP
177   >1B1A=>0693                 bl      *3
178                               
179   >1B1C=>0580                 inc     0
180   >1B1E=>06C0                 swpb    0
181   >1B20=>9800 >F7C5           cb      0,@vwys
182   >1B24=>1A01                 jl      termscroll1
183   >1B26=>7000                 sb      0,0
184   >1B28                   termscroll1
185   >1B28=>06C0                 swpb    0
186   >1B2A=>C0BA                 mov     *SP+,2     
187   >1B2C=>0693                 bl      *3
189                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1B2E=>C2FA                     mov *SP+,  11
*** term.i
190   >1B30=>045B                 rt
193   >1B32                   termclear
194                               PUSH    SP,0,2,3,11
*** <expansion of push>
1     >1B32=>022A >FFF8           ai SP, -4*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1B36=>CA80 >0006               mov  0 , @(4-0-1)*2(SP)
2     >1B3A=>CA82 >0004               mov  2 , @(4-1-1)*2(SP)
3     >1B3E=>CA83 >0002               mov  3 , @(4-2-1)*2(SP)
4     >1B42=>C68B                     mov  11, @(4-3-1)*2(SP)
*** term.i
195   >1B44=>04C0                 clr     0
196   >1B46=>C0E0 >F7A0           mov     @vclearline,3
197   >1B4A=>064A                 dect    SP
198   >1B4C=>D0A0 >F7C4           movb    @vwxs,2             ; length
199   >1B50=>0982                 srl     2,8
200   >1B52                   termclear0
201   >1B52=>C682                 mov     2,*SP
202   >1B54=>0693                 bl      *3
203   >1B56=>C09A                 mov     *SP,2
204   >1B58=>0580                 inc     0
205   >1B5A=>06C0                 swpb    0
206   >1B5C=>9800 >F7C5           cb      0,@vwys
207   >1B60=>1302                 jeq     termclear1
208   >1B62=>06C0                 swpb    0
209   >1B64=>10F6                 jmp     termclear0
210   >1B66                   termclear1
211   >1B66=>04E0 >F7CA           clr     @vx
212   >1B6A=>05CA                 inct    SP
213                               POP     SP,0,2,3,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1B6C=>C2FA                     mov *SP+,  11
2     >1B6E=>C0FA                     mov *SP+,  3 
3     >1B70=>C0BA                     mov *SP+,  2 
4     >1B72=>C03A                     mov *SP+,  0 
*** term.i
214   >1B74=>045B                 rt        
215                               
221   >1B76                   bksp	PUSH   SP, 1, 2, 11
*** <expansion of push>
1     >1B76=>022A >FFFA           ai SP, -3*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1B7A=>CA81 >0004               mov  1 , @(3-0-1)*2(SP)
2     >1B7E=>CA82 >0002               mov  2 , @(3-1-1)*2(SP)
3     >1B82=>C68B                     mov  11, @(3-2-1)*2(SP)
*** term.i
223   >1B84=>06A0 >0A5C       	bl	@vcursoroff
225   >1B88=>D060 >F7CA       	movb	@vx,1				; get x
226   >1B8C=>7060 >01BB       	sb	    #1,1				; decrement
227   >1B90=>180F             	jc	    bksp0				; 0 -> -1?
229   >1B92=>D060 >F7C4       	movb	@vwxs,1				; yup, move to other edge
230   >1B96=>7060 >01BB       	sb	    #1,1			
231   >1B9A=>D0A0 >F7CB       	movb	@vy,2				; and decrement
232   >1B9E=>70A0 >01BB       	sb	    #1,2				; Y
233   >1BA2=>1804             	jc	    bksp1				; 0 -> -1?
234   >1BA4=>D0A0 >F7C5       	movb	@vwys,2				; move to bottom
235   >1BA8=>70A0 >01BB       	sb	    #1,2
236   >1BAC                   bksp1	movb	2,@vy				; save
      >1BAC=>D802 >F7CB       
237   >1BB0                   bksp0	movb	1,@vx				; save
      >1BB0=>D801 >F7CA       
239                               POP SP, 1, 2, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1BB4=>C2FA                     mov *SP+,  11
2     >1BB6=>C0BA                     mov *SP+,  2 
3     >1BB8=>C07A                     mov *SP+,  1 
*** term.i
240   >1BBA=>045B             	rt
247   >1BBC                   crlf    PUSH    SP, 1, 11
*** <expansion of push>
1     >1BBC=>022A >FFFC           ai SP, -2*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1BC0=>CA81 >0002               mov  1 , @(2-0-1)*2(SP)
2     >1BC4=>C68B                     mov  11, @(2-1-1)*2(SP)
*** term.i
249   >1BC6=>06A0 >0A5C           bl      @vcursoroff         ; we're moving cursor
251   >1BCA=>7820 >F7CA >F7CA     sb      @vx,@vx             ; reset X coord
252   >1BD0=>B820 >01BB >F7CB     ab      #1,@vy               ; next line
253   >1BD6=>1804                 jc      crlfc               ; wrapped?
254   >1BD8=>9820 >F7CB >F7C5     cb      @vy,@vwys           ; bottom of window?
255   >1BDE=>1A03                 jl      crlf0
256   >1BE0                   crlfc:
257   >1BE0=>7820 >F7CB >F7CB     sb      @vy,@vy
259   >1BE6                   crlf0:
261   >1BE6=>9820 >F7CB >F7C6     cb      @vy,@vwcy
262   >1BEC=>1305                 je      crlf1
263   >1BEE=>D820 >F7CB >F7C6     movb    @vy,@vwcy
264   >1BF4=>06A0 >1B02           bl      @termscroll
266   >1BF8                   crlf1:
267                               POP     SP, 1, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1BF8=>C2FA                     mov *SP+,  11
2     >1BFA=>C07A                     mov *SP+,  1 
*** term.i
268   >1BFC=>045B                 rt
276   >1BFE                   tab	PUSH    SP, 1, 11
*** <expansion of push>
1     >1BFE=>022A >FFFC           ai SP, -2*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1C02=>CA81 >0002               mov  1 , @(2-0-1)*2(SP)
2     >1C06=>C68B                     mov  11, @(2-1-1)*2(SP)
*** term.i
277   >1C08=>CA81 >0002       	mov	1,@2(SP)
278   >1C0C=>C68B             	mov	11,*SP
280   >1C0E                   tab0	li	1,>2000
      >1C0E=>0201 >2000       
281   >1C12=>06A0 >1AA8       	bl	@printchar  			; print a space
282   >1C16=>D060 >F7CA       	movb	@vx,1
283   >1C1A=>0241 >0700       	andi	1,>0700				; if not on 8-char boundary
284   >1C1E=>16F7             	jne	tab0				; repeat
286                               POP     SP, 1, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1C20=>C2FA                     mov *SP+,  11
2     >1C22=>C07A                     mov *SP+,  1 
*** term.i
287   >1C24=>045B             	rt
290   >1C26                   clreol  PUSH    SP, 0, 2, 3, 11
*** <expansion of push>
1     >1C26=>022A >FFF8           ai SP, -4*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1C2A=>CA80 >0006               mov  0 , @(4-0-1)*2(SP)
2     >1C2E=>CA82 >0004               mov  2 , @(4-1-1)*2(SP)
3     >1C32=>CA83 >0002               mov  3 , @(4-2-1)*2(SP)
4     >1C36=>C68B                     mov  11, @(4-3-1)*2(SP)
*** term.i
292   >1C38=>C0E0 >F7A0           mov     @vclearline, 3
294   >1C3C=>D0A0 >F7C4           movb    @vwxs,2             ; length
295   >1C40=>0982                 srl     2,8
297   >1C42=>C020 >F7CA           mov     @vx,0
298   >1C46=>7000                 sb      0,0                 ; get coord for lower-left
299                               
300   >1C48=>0693                 bl      *3
301                               
302                               POP     SP, 0, 2, 3, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1C4A=>C2FA                     mov *SP+,  11
2     >1C4C=>C0FA                     mov *SP+,  3 
3     >1C4E=>C0BA                     mov *SP+,  2 
4     >1C50=>C03A                     mov *SP+,  0 
*** term.i
303   >1C52=>045B                 rt
304                               
311   >1C54                   emit
312   >1C54=>9801 >1163           cb      1,#>0d           ; enter?
313   >1C58=>13B1                 jeq     crlf
315   >1C5A                   $1:  cb     1,#>07          ; bell?
      >1C5A=>9801 >004E       
316   >1C5E=>130B                 jeq     bell
318   >1C60                   $1:  cb     1,#>08          ; backspace?
      >1C60=>9801 >0A18       
319   >1C64=>1388                 jeq     bksp
321   >1C66                   $1:  cb     1,#>09          ; tab?
      >1C66=>9801 >0220       
322   >1C6A=>13C9                 jeq     tab
323                               
324   >1C6C                   $1: cb      1,#>0B          ; vertical tab ( == clear to end of line )
      >1C6C=>9801 >002D       
325   >1C70=>13DA                 jeq     clreol
326                                   
327   >1C72=>0460 >1AA8           b       @printchar
328                               
330   >1C76                   bell:    
331   >1C76=>045B                 rt
340   >1C78                   type PUSH    SP,11
*** <expansion of push>
1     >1C78=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >1C7A=>C68B                     mov  11, @(1-0-1)*2(SP)
*** term.i
341   >1C7C=>022A >FFFC           ai      SP,-4
342   >1C80                   $1: mov     3,3
      >1C80=>C0C3             
343   >1C82=>130B                 jeq     $2+
344   >1C84=>D072                 movb    *2+,1
345   >1C86=>C682                 mov     2, *SP
346   >1C88=>CA83 >0002           mov     3, @2(SP)
347   >1C8C=>06A0 >1C54           bl      @emit
348   >1C90=>C0EA >0002           mov     @2(SP), 3
349   >1C94=>C09A                 mov     *SP, 2
350   >1C96=>0603                 dec     3
351   >1C98=>10F3                 jmp     $1-
352   >1C9A                   $2: ai      SP,4
      >1C9A=>022A >0004       
353                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >1C9E=>C2FA                     mov *SP+,  11
*** term.i
354   >1CA0=>045B                 rt
355                           	
*** nforth.tsm
515                           	incl	dev.i
*** dev.i
29    >1CA2                   haa	byte	>aa
      >1CA2=>AA             
30    >1CA3=>00             	byte	0
32    >1CA4                   dinit	li	0,>3ffe        ; steal an extra byte to avoid having DSRs wraparound
      >1CA4=>0200 >3FFE       
33    >1CA8=>C800 >FB70       	mov	0,@vdplimit			; set up 16k VDP RAM
35    >1CAC=>02E0 >FBE0       	lwpi	cpurambase + >e0  				; be standard
36    >1CB0=>020D >FF90       	li	13,GPLRD
37    >1CB4=>020E >0100       	li	14,>100
38    >1CB8=>020F >FF8A       	li	15,VDPWA
40    >1CBC=>020C >0F00       	li	12,>0f00			; start below first DSR
41    >1CC0                   di00	sbz	0
      >1CC0=>1E00             
42    >1CC2=>B320 >01BB       	ab	#1,12				; point to next DSR
43    >1CC6=>028C >2000       	ci	12,>2000
44    >1CCA=>1410             	jhe	diout				; done
46    >1CCC=>1D00             	sbo	0					; turn on ROM
47    >1CCE=>9820 >4000 >1CA2 	cb	@>4000,@haa			; legal rom?
48    >1CD4=>16F5             	jne	di00				; nope
50    >1CD6=>C060 >4004       	mov	@>4004,1			; get init ptr
51    >1CDA=>13F2             	jeq	di00				; none
52    >1CDC                   di01	mov	@2(1),11			; get addr for init
      >1CDC=>C2E1 >0002       
53    >1CE0=>C80C >FBD0       	mov	12,@cpurambase + >d0
54    >1CE4=>069B             	bl	*11				; call powerup routine
55    >1CE6=>C051             	mov	*1,1				; get next powerup
56    >1CE8=>16F9             	jne	di01				; if it exists
57    >1CEA=>10EA             	jmp	di00
59    >1CEC                   diout	lwpi	mainws				; restore WP
      >1CEC=>02E0 >FC00       
60    >1CF0=>045B             	rt
74    >1CF2                   noemuerr db	"No emulated disk DSR found!",>ff
      >1CF2=>4E6F >2065 >6D75 
      >1CF8=>6C61 >7465 >6420 
      >1CFE=>6469 >736B >2044 
      >1D04=>5352 >2066 >6F75 
      >1D0A=>6E64 >21FF       
75    >1D0E=>506C >6561 >7365 	db	"Please install the emulated disk DSR",>ff
      >1D14=>2069 >6E73 >7461 
      >1D1A=>6C6C >2074 >6865 
      >1D20=>2065 >6D75 >6C61 
      >1D26=>7465 >6420 >6469 
      >1D2C=>736B >2044 >5352 
      >1D32=>FF             
76    >1D33=  >62 >7920 >6164 	db	"by adding 'EmuDisk' to the DSRCombo",>ff
      >1D38=>6469 >6E67 >2027 
      >1D3E=>456D >7544 >6973 
      >1D44=>6B27 >2074 >6F20 
      >1D4A=>7468 >6520 >4453 
      >1D50=>5243 >6F6D >626F 
      >1D56=>FF             
77    >1D57=  >76 >6172 >6961 	db	"variable in FORTH.CNF.",>ff,>ff
      >1D5C=>626C >6520 >696E 
      >1D62=>2046 >4F52 >5448 
      >1D68=>2E43 >4E46 >2EFF 
      >1D6E=>FF             
78    >1D6F=  >28 >5365 >6520 	db	"(See DISKS.TXT for info.)",>ff,>ff
      >1D74=>4449 >534B >532E 
      >1D7A=>5458 >5420 >666F 
      >1D80=>7220 >696E >666F 
      >1D86=>2E29 >FFFF       
79    >1D8A=>5072 >6573 >7320 	db	"Press Ctrl+Break to halt."
      >1D90=>4374 >726C >2B42 
      >1D96=>7265 >616B >2074 
      >1D9C=>6F20 >6861 >6C74 
      >1DA2=>2E             
80    >1DA3=>00             	db	0
82    >1DA4                   forthdskdef db	"FORTHDSK  "
      >1DA4=>464F >5254 >4844 
      >1DAA=>534B >2020       
83    >1DAE                   	even
85    >1DAE                   diskinit dect	SP
      >1DAE=>064A             
86    >1DB0=>C68B             	mov	11,*SP
88    >1DB2=>02E0 >FBE0           lwpi    cpurambase + >E0           ; be standard and avoid having the ROM clobber our workspace ;)
89                                
90    >1DB6=>020C >1000       	li	12,>1000			; DSR base for emulated DSR
91    >1DBA=>1D00             	sbo	0				; turn on
92    >1DBC=>9820 >1CA2 >4000 	cb	@haa,@>4000			; installed?
93    >1DC2=>1301             	jeq	dskiokay
95                            	;li	2,noemuerr			; print error message
96                            	;b	@dieerr
97    >1DC4=>100C             	jmp dskiignore
99    >1DC6                   dskiokay:
100   >1DC6=>1E00             	sbz	0
102   >1DC8=>02E0 >FC00           lwpi    mainws          
103                               
104   >1DCC=>0200 >1DA4       	li	0,forthdskdef
105   >1DD0=>0201 >F936       	li	1,forthdsk
106   >1DD4=>0202 >000A       	li	2,10
107   >1DD8                   dskifn	movb	*0+,*1+
      >1DD8=>DC70             
108   >1DDA=>0602             	dec	2
109   >1DDC=>15FD             	jgt	dskifn
111   >1DDE                   dskiignore:
112   >1DDE=>C2FA             	mov	*SP+,11
113   >1DE0=>045B             	rt
115   >1DE2                   vsbw	dect	SP
      >1DE2=>064A             
116   >1DE4=>C68B             	mov	11,*SP
117   >1DE6=>06A0 >0458       	bl	@vwaddr
118   >1DEA=>D801 >FF88       	movb	1,@VDPWD
119   >1DEE=>C2FA             	mov	*SP+,11
120   >1DF0=>045B             	rt
123   >1DF2                   vsbr	dect	SP
      >1DF2=>064A             
124   >1DF4=>C68B             	mov	11,*SP
125   >1DF6=>06A0 >045C       	bl	@vraddr
126   >1DFA=>D060 >FF80       	movb	@VDPRD,1
127   >1DFE=>C2FA             	mov	*SP+,11
128   >1E00=>045B             	rt
131   >1E02                   equals	db	>20
      >1E02=>20             
132   >1E03                   period	db	"."
      >1E03=>2E             
145   >C000                   DSRVBASE equ >C000
147   >1E04                   dsrlnk	data	dskws,dsrlnk+4
      >1E04=>FC20 >1E08       
148   >1E08=>0300 >0000       	limi   0
149   >1E0C=>C2A0 >FC14       	mov    @mainws + 20, SP    ; use same stack as main
151   >1E10=>0200 >C000           li      0, DSRVBASE
152   >1E14=>D0A0 >FF6C           movb    @vpob, 2
153   >1E18=>7802 >FF6C           sb      2, @vpob
154   >1E1C=>06A0 >1790           bl      @vsetbank          ; set VDP bank for DSR operations
155                               
156   >1E20=>0208 >FB00           li      8,cpurambase         ; cpuram base
157                               
158   >1E24=>C16D >0002       	mov	   @2(13),5			; get offset
159   >1E28=>53E0 >1E02       	szcb   @equals,15			; no error
160   >1E2C=>C028 >0056       	mov	   @>56(8),0			; get ptr to name
161   >1E30=>C240             	mov	   0,9				
162   >1E32=>0229 >FFF8       	ai     9,-8				; point to error code
164   >1E36=>06A0 >1DF2       	bl     @vsbr				; get len
165   >1E3A=>D0C1             	movb   1,3				; save
166   >1E3C=>0983             	srl    3,8				
167   >1E3E=>0704             	seto   4				; # chars
169   >1E40=>0202 >FB4A       	li     2,cpurambase + >4a				; buffer
170   >1E44                   dsr00	
171   >1E44=>0580                 inc     0    				; move device name
172   >1E46=>0584             	inc    4
173   >1E48=>80C4             	c      4,3
174   >1E4A=>1306             	jeq    dsr01
175   >1E4C=>06A0 >1DF2       	bl     @vsbr
176   >1E50=>DC81             	movb   1,*2+
177   >1E52=>9801 >1E03       	cb	   1,@period
178   >1E56=>16F6             	jne	   dsr00
179   >1E58                   dsr01	
180   >1E58=>C104                 mov	   4,4				; any chars read?
181   >1E5A=>1344             	jeq	   dsr09
182   >1E5C=>0284 >0007       	ci	   4,7
183   >1E60=>1541             	jgt	   dsr09				; too many?
184   >1E62=>04E8 >00D0       	clr	   @>d0(8)
185   >1E66=>CA04 >0054       	mov    4,@>54(8)			; # chars in device name
186   >1E6A=>0584             	inc	   4
187   >1E6C=>AA04 >0056       	a      4,@>56(8)			; point to '.' in name
188   >1E70=>02E0 >FBE0       	lwpi   cpurambase + >e0				; GPLWS
189   >1E74=>04C1             	clr    1				; init card counter
190   >1E76=>020C >0F00       	li     12,>f00
191   >1E7A                   dsr03	
192   >1E7A=>1E00                 sbz     0
193   >1E7C=>022C >0100       	ai     12,>100				; start scan at >1000
194   >1E80=>04E8 >00D0       	clr    @>d0(8)
195   >1E84=>028C >2000       	ci     12,>2000			; last base?
196   >1E88=>132B             	jeq    dsr08
197   >1E8A=>CA0C >00D0       	mov    12,@>d0(8)			; store CRU
198   >1E8E=>1D00             	sbo    0				; turn on rom
199   >1E90=>0202 >4000       	li     2,>4000
200   >1E94=>9812 >1CA2       	cb     *2,@haa				; legal rom?
201   >1E98=>16F0             	jne    dsr03
202   >1E9A=>A0A0 >FC2A       	a      @dskws+10,2			; add offset
203   >1E9E=>1003             	jmp    dsr05
204   >1EA0                   dsr04	
205   >1EA0=>C0A8 >00D2           mov     @>d2(8),2
206   >1EA4=>1D00             	sbo    0
207   >1EA6                   dsr05	
208   >1EA6=>C092                 mov	    *2,2				; any devices?
209   >1EA8=>13E8             	jeq	   dsr03		    		; nope... next rom pleez
210   >1EAA=>CA02 >00D2       	mov    2,@>d2(8)			; save next link
211   >1EAE=>05C2             	inct   2
212   >1EB0=>C272             	mov    *2+,9				; get routine addr
213   >1EB2=>D168 >0055       	movb   @>55(8),5			; get len of caller
214   >1EB6=>1309             	jeq    dsr07				; ??? no length?
215   >1EB8=>9C85             	cb     5,*2+				; match name
216   >1EBA=>16F2             	jne    dsr04
217   >1EBC=>0985             	srl    5,8
218   >1EBE=>0206 >FB4A       	li     6,>4a + cpurambase
219   >1EC2                   dsr06	
220   >1EC2=>9CB6                 cb      *6+,*2+
221   >1EC4=>16ED             	jne    dsr04
222   >1EC6=>0605             	dec    5
223   >1EC8=>16FC             	jne    dsr06
224   >1ECA                   dsr07	
225   >1ECA=>0581                 inc     1	    			; increment card #
226   >1ECC=>0699             	bl     *9				; run it
227   >1ECE=>10E8             	jmp    dsr04				; if no error, skip this word
228   >1ED0=>1E00             	sbz    0				; turn off rom
229   >1ED2=>02E0 >FC20       	lwpi   dskws				
230   >1ED6=>C009             	mov    9,0				; get error code (cpurambase + >F2)
231   >1ED8=>06A0 >1DF2       	bl     @vsbr
232   >1EDC=>09D1             	srl    1,13				; any error?
233   >1EDE=>1003             	jmp	   dsr10
234   >1EE0                   dsr08	
235   >1EE0=>02E0 >FC20           lwpi   dskws
236   >1EE4                   dsr09
237   >1EE4=>04C1             	clr	   1
238   >1EE6                   dsr10	
239                               ;swpb   1
240   >1EE6=>C741             	mov	    1,*13
241   >1EE8=>F3E0 >1E02       	socb	@equals,15
242                           	
243   >1EEC=>04C0                 clr     0
244   >1EEE=>06A0 >1790           bl      @vsetbank       ; back to bank 0 for std modes
245                           	
246   >1EF2=>D802 >FF6C       	movb 2, @vpob
247   >1EF6=>0380             	rtwp
250   >1EF8                   vmbw    
251   >1EF8=>064A                 dect    SP
252   >1EFA=>C68B                 mov     11,*SP
253   >1EFC=>06A0 >0458           bl      @vwaddr
254   >1F00                   vmbw0   
255   >1F00=>D831 >FF88           movb    *1+,@VDPWD
256   >1F04=>0602                 dec     2
257   >1F06=>15FC                 jgt     vmbw0
258   >1F08=>C2FA                 mov     *SP+,11
259   >1F0A=>045B                 rt
262   >1F0C                   vmbr    
263   >1F0C=>064A                 dect    SP
264   >1F0E=>C68B                 mov     11,*SP
265   >1F10=>06A0 >045C           bl      @vraddr
266   >1F14                   vmbr0   
267   >1F14=>DC60 >FF80           movb    @VDPRD,*1+
268   >1F18=>0602                 dec     2
269   >1F1A=>15FC                 jgt     vmbr0
270   >1F1C=>C2FA                 mov     *SP+,11
271   >1F1E=>045B                 rt
288   >1F20                   rblockpab db    >01,>14
      >1F20=>0114             
289   >1F22                   wblockpab db    >01,>15
      >1F22=>0115             
291   >1F24                   rwblock  data    dskws,rwblock + 4
      >1F24=>FC20 >1F28       
292   >1F28=>0300 >0000           limi    0
293   >1F2C=>020A >F936           li      SP,dskstack + dskstacksize
295   >1F30=>064A                 dect    SP
296   >1F32=>D6A0 >FF6C           movb    @vpob, *SP
297                               
298   >1F36=>781A >FF6C           sb      *SP, @vpob
299   >1F3A=>0200 >C000           li      0, DSRVBASE
300   >1F3E=>06A0 >1790           bl      @vsetbank          ; set VDP bank for DSR operations
302   >1F42=>0208 >FB00           li      8, cpurambase            ; CPU RAM base
303                               
304   >1F46=>C32D >0018           mov     @24(13), 12
305                               
306   >1F4A=>C028 >0070           mov     @>70(8), 0
307   >1F4E=>0220 >FC00           ai      0,-1024
308   >1F52=>C060 >F79A           mov     @vfree, 1
309   >1F56=>0241 >3FFF           andi    1, >3FFF
310   >1F5A=>8040                 c       0, 1
311   >1F5C=>1403                 jhe     $0+
312                               
313   >1F5E=>D760 >0014           movb    #4, *13             ; not enough memory!
314   >1F62=>103D                 jmp     $1+
315                                
316   >1F64                   $0:
317   >1F64=>C1C0                 mov     0, 7
318                               
319   >1F66=>0220 >FFF0           ai      0,->10
320   >1F6A=>0201 >F936           li      1,forthdsk
321   >1F6E=>0202 >000A           li      2,10
322   >1F72=>06A0 >1EF8           bl      @vmbw               ; set filename
323   >1F76=>CA00 >004E           mov     0,@>4e(8)
325   >1F7A=>0203 >0004           li      3,4                 ; # secs to read/write
326   >1F7E=>C06C >0004           mov     @4(12),1            ; CPU addr
327                               
328   >1F82=>C16C >0002           mov     @2(12),5            ; block #
329   >1F86=>0A25                 sla     5,2                 ; sector #
330                               
331   >1F88=>04C4                 clr     4
332   >1F8A=>3D20 >29BC           div     #360, 4             ; sector -> disk
333   >1F8E=>0584                 inc     4                   ; 0-based to 1-based
334   >1F90=>06C4                 swpb    4
335   >1F92=>DA04 >004C           movb    4, @>4C(8)          ; disk #
336                               
337   >1F96=>0206 >1F22           li      6,wblockpab
338   >1F9A=>C11C                 mov     *12,4
339   >1F9C=>1302                 jeq     rblks
340   >1F9E=>0206 >1F20           li      6,rblockpab
341                               
342   >1FA2                   rblks 
343   >1FA2=>DA20 >0014 >004D     movb    #4, @>4D(8)         ; four sectors
344   >1FA8=>04E8 >0050           clr     @>50(8)              ; parms @>00 + rambase
346   >1FAC=>C607                 mov     7,*8             ; VDP buff addr 
347   >1FAE=>CA05 >0002           mov     5,@2(8)          ; sector #
349   >1FB2=>0202 >0400           li      2,1024
350                               
351   >1FB6=>C104                 mov     4,4
352   >1FB8=>1603                 jne     rblks0
354   >1FBA=>C007                 mov     7,0
355   >1FBC=>06A0 >1EF8           bl      @vmbw               ; move block to VDP for write
356                               
357   >1FC0                   rblks0:
358   >1FC0=>06A0 >1FEA           bl      @dodsr              ; do op
359                               
360   >1FC4=>04DC                 clr     *12
361   >1FC6=>DB28 >0050 >0001     movb    @>50(8),@1(12)
362   >1FCC=>1606                 jne     rwblkerr
364   >1FCE=>C104                 mov     4,4
365   >1FD0=>1303                 jeq     wblks0
366                               
367   >1FD2=>C007                 mov     7,0
368   >1FD4=>06A0 >1F0C           bl      @vmbr               ; copy block from VDP for read
370   >1FD8                   wblks0:
371   >1FD8=>1002                 jmp     $1+
373   >1FDA                   rwblkerr movb @>50(8),*13
      >1FDA=>D768 >0050       
374   >1FDE                   $1:
375   >1FDE=>04C0                 clr     0
376   >1FE0=>06A0 >1790           bl      @vsetbank       ; back to bank 0 for std modes
377   >1FE4=>D83A >FF6C           movb    *SP+, @vpob
378                               
379   >1FE8=>0380                 rtwp
391   >1FEA                   dodsr   mov 6,@>e0+12(8) 
      >1FEA=>CA06 >00EC       
392   >1FEE=>02E0 >FBE0           lwpi    cpurambase + >e0               ; be standard
393   >1FF2=>020D >FF90           li      13,GPLRD
394   >1FF6=>020E >0100           li      14,>100
395   >1FFA=>020F >FF8A           li      15,VDPWA
397   >1FFE=>0208 >FB00           li      8,cpurambase             ; CPU RAM base
398   >2002=>020C >1000           li      12,>1000            ; our CRU base
399   >2006=>1D00                 sbo     0               ; turn it on
401   >2008=>0201 >400A           li      1,>400A             ; subprograms
402   >200C=>C051                 mov     *1,1
403   >200E=>1306                 jeq     dodsrerr
404   >2010                   dodsrfnd 
405   >2010=>C0A1 >0004           mov     @4(1),2             ; complete name
406   >2014=>8582                 c       2,*6                ; same name?
407   >2016=>1306                 jeq     dodsrrun
408   >2018=>C051                 mov     *1,1                ; get next
409   >201A=>16FA                 jne     dodsrfnd
411   >201C                   dodsrerr 
412   >201C=>DA20 >046B >0050     movb    #>ff,@>50(8)         ; fake error
413   >2022=>1006                 jmp     dodsrout
415   >2024                   dodsrrun 
416   >2024=>C2E1 >0002           mov     @2(1),11                ; get addr
417   >2028=>CA0C >00D0           mov     12,@>d0(8)           ; save CRU addr
418   >202C=>069B                 bl      *11             ; call routine
419   >202E=>1000                 nop                 ; error 
421   >2030                   dodsrout 
422   >2030=>020C >1000           li      12,>1000 
423   >2034=>1E00                 sbz     0               ; turn off ROM
424                               
425   >2036=>02E0 >FC20           lwpi    dskws
426   >203A=>045B                 rt
427                           	
*** nforth.tsm
516                               incl    sound.i
*** sound.i
22    >203C                   sndinit
23                                PUSH    SP, 11
*** <expansion of push>
1     >203C=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >203E=>C68B                     mov  11, @(1-0-1)*2(SP)
*** sound.i
24    >2040=>0200 >9FBF           li     0, >9FBF
25    >2044=>0202 >000A           li     2, 10
26    >2048=>0201 >FFA0           li     1, SOUND
27                                
28                                ; first iter: clear out console chip;
29                                ; next four iters: clear out extra chips
30                                ;
31                                ; on each iter, send the volume off and effect off commands for each voice 
32    >204C                   $0:    
33    >204C=>D440                 movb   0, *1
34    >204E=>D840 >0002           movb   0, @2(1)
35    >2052=>06C0                 swpb   0
36    >2054=>D440                 movb   0, *1
37    >2056=>D840 >0002           movb   0, @2(1)
38    >205A=>0200 >DFFF           li     0, >DFFF
39    >205E=>D440                 movb   0, *1
40    >2060=>D840 >0002           movb   0, @2(1)
41    >2064=>06C0                 swpb   0
42    >2066=>D440                 movb   0, *1
43    >2068=>D840 >0002           movb   0, @2(1)
44    >206C=>0642                 dect   2
45    >206E=>1703                 jnc	   $1+
46    >2070=>C062 >22D2       	mov    @snd_voice_ports(2), 1
47    >2074=>10EB             	jmp    $0    
48    >2076                   $1:    
49    >2076=>04E0 >FF68           clr     @sndlist
50    >207A=>06A0 >24E4           bl      @snd_seq_init
51                                POP     SP, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >207E=>C2FA                     mov *SP+,  11
*** sound.i
52                                
53    >2080=>045B                 rt
59    >2082                   sndfetch1
60    >2082=>D0F0                 movb    *0+, 3
61    >2084=>045B                 rt
62    >2086                   sndfetchv
63    >2086=>0580                 inc     0
64    >2088=>D0D4                 movb    *4, 3
65    >208A=>045B                 rt
66                                
67                             Vector soundlist, vidws
*** <expansion of vector>
1     >208C                   soundlist  data vidws, soundlist_entry
      >208C=>FC60 >2090       
2     >2090                   soundlist_entry:    
*** sound.i
68                             
69                                ; check active duration
70    >2090=>D020 >FF6A           movb    @snddur, 0
71    >2094=>1304                 jeq     $0+
72                               
73    >2096=>7820 >01BB >FF6A     sb      #1, @snddur
74    >209C=>1623                 jne     $3+
75                                 
76    >209E                   $0:    
77                             
78    >209E=>C020 >FF68           mov     @sndlist, 0
79    >20A2=>1320                 jeq     $3+
80                                
81    >20A4=>0202 >2082           li      2, sndfetch1
82                                
83    >20A8=>D060 >FF67           movb    @sndflags, 1
84    >20AC=>0A11                 sla     1, 1
85    >20AE=>1706                 jnc     $1+
86                                
87    >20B0=>06A0 >045C           bl      @vraddr
88    >20B4=>0204 >FF80           li      4, VDPRD
89    >20B8=>0202 >2086           li      2, sndfetchv
90                                 
91    >20BC                   $1: 
92    >20BC=>0692                 bl      *2
93    >20BE=>1310                 jeq     $5+         ; end of song?
94                                
95                                ; duration first
96    >20C0=>D803 >FF6A           movb    3, @snddur
98    >20C4                   $4:
99                                ; then a set of volumes or tones (noise must have a dummy $ff byte)
100   >20C4=>0692                 bl      *2
101   >20C6=>1309                 jeq     $2+         ; end of group?
102                                   
103   >20C8=>D803 >FFA0           movb    3, @SOUND
104   >20CC=>20E0 >1DB8           coc     #>1000, 3    ; volume?
105   >20D0=>13F9                 jeq     $4-         ; yup 
106                               
107   >20D2=>0692                 bl      *2          ; else it was the first byte of a two-byte tone; fetch next
108   >20D4=>D803 >FFA0           movb    3, @SOUND   
109   >20D8=>10F5                 jmp     $4-
110                               
111   >20DA                   $2:
112   >20DA=>C800 >FF68           mov     0, @sndlist
113   >20DE=>0380                 rtwp
114                               
115   >20E0                   $5:    
116   >20E0=>04E0 >FF68           clr     @sndlist
117   >20E4                   $3:
118   >20E4=>0380                 rtwp
125   >20E6                   snd_tracks_init
126                               PUSH    SP, 11
*** <expansion of push>
1     >20E6=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >20E8=>C68B                     mov  11, @(1-0-1)*2(SP)
*** sound.i
128   >20EA=>0200 >1E00           li      r0, 30 * 256
129   >20EE=>06A0 >2132           bl      @snd_track_tempo_to_incr
130                               
131   >20F2=>0204 >FA00           li      r4, tracks
132   >20F6=>04C2                 clr     r2
133   >20F8                   $0:
134   >20F8=>06A0 >2106           bl      @snd_track_init
135   >20FC=>0284 >FA80           ci      r4, TRACKS_END
136   >2100=>1AFB                 jl      $0
137                               
138                               POP     SP, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >2102=>C2FA                     mov *SP+,  11
*** sound.i
139   >2104=>045B                 rt
149   >2106                   snd_track_init
150   >2106=>CD02                 mov     r2, *r4+    ; lt_cmdptr
151   >2108=>04F4                 clr     *r4+        ; lt_clock
152   >210A=>0734                 seto    *r4+        ; lt_incr
153   >210C=>CD00                 mov     r0,*r4+     ; lt_tempoincr
154   >210E=>04F4                 clr     *r4+        ; lt_a_d, lt_s_r
155   >2110=>CD20 >0480           mov     #>0f00,*r4+     ; lt_volume, lt_sustain
156   >2114=>04F4                 clr     *r4+        ; lt_vibrato, lt_tremolo
157   >2116=>04F4                 clr     *r4+        ; lt_waveform, lt_balance
158   >2118=>045B                 rt
159                                   
164   >211A                   snd_track_reset
165   >211A=>04E4 >0008           clr     @lt_a_d(r4)  ; + s_r
166   >211E=>04C0                 clr     r0
167   >2120=>D900 >000B           movb    r0, @lt_sustain(r4)
168   >2124=>04E4 >000C           clr     @lt_vibrato(r4)  ; + lt_tremolo
169   >2128=>C900 >000E           mov     r0, @lt_waveform(r4) ; + lt_balance
170   >212C=>045B                 rt
179   >212E                   snd_track_isDone
180   >212E=>C014                 mov     @lt_cmdptr(r4), r0
181   >2130=>045B                 rt
193   >2132                   snd_track_tempo_to_incr
194   >2132=>0980                 srl     r0, 8
195   >2134=>0A20                 sla     r0, 2
196   >2136=>04C1                 clr     r1
197   >2138=>3C20 >29BE           div     #3600, r0
198   >213C=>1901                 jno     $0+
199   >213E=>0700                 seto    r0 
200   >2140                   $0:    
201   >2140=>045B                 rt    
202                               
213   >2142                   snd_track_length_to_incr
214   >2142=>C0A4 >0006           mov     @lt_tempoincr(r4), r2
215   >2146=>C042                 mov     r2, r1
216   >2148=>09C1                 srl     r1, 12
217   >214A=>0A42                 sla     r2, 4    
218   >214C=>0980                 srl     r0, 8
219   >214E=>3C40                 div     r0, r1
220   >2150=>045B                 rt
231   >2152                   snd_track_note_to_hertz_16
232   >2152=>D040                 movb    r0, r1
233   >2154=>0241 >0F00           andi    r1, >0f00
234   >2158=>0971                 srl     r1, 7           ; note offset
235   >215A=>C061 >216C           mov     @snd_scale_12_tone_octave_11(r1), r1
236                               
237   >215E=>09C0                 srl     r0, 12          ; octave
238   >2160=>0500                 neg     r0
239   >2162=>0220 >0007           ai      r0, 11 - 4      ; shift
240   >2166=>1301                 jeq     $0+
241   >2168=>0901                 srl     r1, r0    
242   >216A                   $0:    
243   >216A=>045B                 rt
244                               
248   >216C                   snd_scale_12_tone_octave_11:
249   >216C=>82D0 >8A97 >92D5     dw  33488, 35479, 37589, 39824
      >2172=>9B90             
250   >2174=>A4D0 >AE9D >B8FF     dw  42192, 44701, 47359, 50175 
      >217A=>C3FF             
251   >217C=>CFA7 >DC00 >E915     dw  53159, 56320, 59669, 63217 
      >2182=>F6F1             
252   >2184=>0000 >0000 >0000     dw  0, 0, 0, 0
      >218A=>0000             
258   >218C                   snd_tracks_tick
259                                  PUSH SP, 11
*** <expansion of push>
1     >218C=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >218E=>C68B                     mov  11, @(1-0-1)*2(SP)
*** sound.i
260                                  
261   >2190=>0204 >FA00              li   r4, tracks
262   >2194                   $0:
263   >2194=>C014                    mov  @lt_cmdptr(r4), r0
264   >2196=>1302                    jeq  $1+
265                                  
266   >2198=>06A0 >21AA              bl   @snd_track_tick
267   >219C                   $1:
268   >219C=>0224 >0010              ai   r4, lt_size       
269   >21A0=>0284 >FA80              ci   r4, TRACKS_END
270   >21A4=>1AF7                    jl   $0-
271                                  
272                                  POP  SP, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >21A6=>C2FA                     mov *SP+,  11
*** sound.i
273   >21A8=>045B                    rt
274                               
282   >21AA                   snd_track_tick
283   >21AA=>A924 >0004 >0002     a       @lt_incr(r4), @lt_clock(r4)
284   >21B0=>1801                 joc     $3+
285                               ;   not end of lump, continue
286   >21B2=>045B                 rt
287                                   
288   >21B4                   $3:
289                               PUSH    SP, 5, 11
*** <expansion of push>
1     >21B4=>022A >FFFC           ai SP, -2*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >21B8=>CA85 >0002               mov  5 , @(2-0-1)*2(SP)
2     >21BC=>C68B                     mov  11, @(2-1-1)*2(SP)
*** sound.i
290   >21BE=>1004                 jmp     $1+
291                               
292   >21C0                   $2:
293                               ; end of track
294   >21C0=>04D4                 clr     @lt_cmdptr(r4)
295                               
296                               ; one last tick
297   >21C2=>06A0 >242C           bl      @snd_voices_tick
298   >21C6=>1014                 jmp     $0+
299                                   
300   >21C8                   $1:
301   >21C8=>C154                 mov     @lt_cmdptr(r4), r5
302   >21CA=>1312                 jeq     $0+
303                               
304   >21CC=>D035                 movb    *r5+, r0
305   >21CE=>1625                 jne     $9+            ; assertion error, should be at lump
306                               
307   >21D0=>D035                 movb    *r5+, r0        ; get lump length
308   >21D2=>13F6                 jeq     $2-             ; end of track?
309                               
310   >21D4=>06A0 >2142           bl      @snd_track_length_to_incr
311                               
312                               ; length includes this tick
313   >21D8=>C901 >0004           mov     r1, @lt_incr(r4)
314   >21DC=>C901 >0002           mov     r1, @lt_clock(r4)
315                               
316   >21E0                   $2:
317   >21E0=>D035                 movb    *r5+, r0        ; next command
318   >21E2=>D040                 movb    r0, r1          ; keep R0 in case low nybble is used
319   >21E4=>09B1                 srl     r1, 11          ; hi nybble -> word offset
320   >21E6=>C061 >21F6           mov     @snd_track_commands(r1), r1
321   >21EA=>13FA                 jeq     $2-
322   >21EC=>0691                 bl      *r1
323   >21EE=>10F8                 jmp     $2-
325   >21F0                   $0: 
326                               POP     SP, 5, 11   
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >21F0=>C2FA                     mov *SP+,  11
2     >21F2=>C17A                     mov *SP+,  5 
*** sound.i
327   >21F4=>045B                 rt
328                               
329   >21F6                   snd_track_commands
330   >21F6=>2218                 dw      snd_track_cmd_lump     ; 0
331   >21F8=>221E                 dw      snd_track_cmd_note     ; 1
332   >21FA=>2276                 dw      snd_track_cmd_volume   ; 2
333   >21FC=>229A                 dw      snd_track_cmd_adhsr    ; 3
334   >21FE=>2288                 dw      snd_track_cmd_tempo    ; 4
335   >2200=>22B2                 dw      snd_track_cmd_vibrato  ; 5
336   >2202=>22B8                 dw      snd_track_cmd_tremolo  ; 6
337   >2204=>22BE                 dw      snd_track_cmd_waveform  ; 7
338                               ;dw      snd_track_cmd_sweep     ; 8
339   >2206=>0000                 dw      0
340   >2208=>22C8                 dw      snd_track_cmd_balance   ; 9 
341   >220A=>0000 >0000 >0000     dw      0, 0, 0, 0, 0        ; A,B,C, D
      >2210=>0000 >0000       
342   >2214=>2280                 dw      snd_track_cmd_jump      ; E
343   >2216=>22CE                 dw      snd_track_cmd_stop      ; F
345   >2218                   snd_track_cmd_lump:
346                               ; done (reached the next lump)
347   >2218=>0605                 dec     r5
348   >221A                   $9:    
349   >221A=>C505                 mov     r5, @lt_cmdptr(r4)
350                               
351                               ;   update the voices for this tick
352                              ; bl      @snd_voices_tick
353   >221C=>10E9                 jmp     $0-
354                               
355   >221E                   snd_track_cmd_note:
356                               PUSH    SP, 11
*** <expansion of push>
1     >221E=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >2220=>C68B                     mov  11, @(1-0-1)*2(SP)
*** sound.i
357                               
358   >2222=>0240 >0F00           andi    r0, >0F00
359   >2226=>D1C0                 movb    r0, r7              ; save flags
360                               
361   >2228=>D035                 movb    *r5+, r0
362                               
363   >222A=>06A0 >2152           bl      @snd_track_note_to_hertz_16
364   >222E=>C181                 mov     r1, r6              ; save hertz
365                               
366   >2230=>D035                 movb    *r5+, r0
367   >2232=>06A0 >2142           bl      @snd_track_length_to_incr
368   >2236=>C006                 mov     r6, r0
369                               
370                               PUSH    SP, 5
*** <expansion of push>
1     >2238=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >223A=>C685                     mov  5, @(1-0-1)*2(SP)
*** sound.i
371                                   
372   >223C=>D1C7                 movb    r7, r7
373   >223E=>1605                 jne     $3+                ; force noise? 
374                               
375   >2240=>0280 >0360           ci      r0, 54 * 16        ; too low?  (Note: enhanced chip!)
376   >2244=>1410                 jhe     $0+
378   >2246=>0207 >0400           li      r7, >0400           ; variable periodic noise (+1)
379   >224A                   $3:
380   >224A                   snd_track_note_noise:    
381   >224A=>0227 >FF00           ai      r7, ->0100
382                               
383   >224E=>21E0 >0018           coc     #>0300, r7
384   >2252=>1603                 jne     $1+
385                               
386                               ; variable pitch: need two voices
387   >2254=>06A0 >2480           bl      @snd_seq_alloc_noise_voices
388   >2258=>100B                 jmp     $2+
389                               
390   >225A                   $1:
391                               ; simple single noise channel    
392   >225A=>D007                 movb    r7, r0
393   >225C=>0202 >8888           li      r2, >8888          ; only a noise
394   >2260=>06A0 >245A           bl      @snd_seq_alloc_note  
396   >2264=>1005                 jmp     $2+
398   >2266                   $0:    
399   >2266=>0202 >7777           li      r2, >7777          ; any melodic voice  
400   >226A=>0940                 srl     r0, 4               ; scale to normal hertz
401   >226C=>06A0 >245A           bl      @snd_seq_alloc_note
403   >2270                   $2:    
404                               POP     SP, 5
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >2270=>C17A                     mov *SP+,  5
*** sound.i
405                               
406                               POP     SP, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >2272=>C2FA                     mov *SP+,  11
*** sound.i
407   >2274=>045B                 rt
409   >2276                   snd_track_cmd_volume:
410   >2276=>0240 >0F00           andi    r0, >f00
411   >227A=>D900 >000A           movb    r0, @lt_volume(r4)
412   >227E=>045B                 rt
413                               
414   >2280                   snd_track_cmd_jump:
415   >2280=>D035                 movb    *r5+, r0
416   >2282=>0880                 sra     r0, 8
417   >2284=>A140                 a       r0, r5
418   >2286=>045B                 rt
419                               
420   >2288                   snd_track_cmd_tempo:
421                               PUSH    SP, 11
*** <expansion of push>
1     >2288=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >228A=>C68B                     mov  11, @(1-0-1)*2(SP)
*** sound.i
422   >228C=>D035                 movb    *r5+, r0
423   >228E=>06A0 >2132           bl      @snd_track_tempo_to_incr
424   >2292=>C900 >0006           mov     r0, @lt_tempoincr(r4) 
425                               POP     SP, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >2296=>C2FA                     mov *SP+,  11
*** sound.i
426   >2298=>045B                 rt
428   >229A                   snd_track_cmd_adhsr:
429                               PUSH    SP, 11
*** <expansion of push>
1     >229A=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >229C=>C68B                     mov  11, @(1-0-1)*2(SP)
*** sound.i
430                               
431   >229E=>0240 >0F00           andi    r0, >F00
432   >22A2=>D900 >000B           movb    r0, @lt_sustain(r4)
433                               
434   >22A6=>D935 >0008           movb    *r5+, @lt_a_d(r4)
435   >22AA=>D935 >0009           movb    *r5+, @lt_h_r(r4)
436                               
437                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >22AE=>C2FA                     mov *SP+,  11
*** sound.i
438   >22B0=>045B                 rt
439                               
440   >22B2                   snd_track_cmd_vibrato:
441   >22B2=>D935 >000C           movb    *r5+, @lt_vibrato(r4)
442   >22B6=>045B                 rt
443                                   
444   >22B8                   snd_track_cmd_tremolo:
445   >22B8=>D935 >000D           movb    *r5+, @lt_tremolo(r4)
446   >22BC=>045B                 rt
447                                   
448   >22BE                   snd_track_cmd_waveform:
449   >22BE=>0240 >0F00           andi    r0, >0f00
450   >22C2=>D900 >000E           movb    r0, @lt_waveform(r4)
451   >22C6=>045B                 rt
452                               
453   >22C8                   snd_track_cmd_balance:
454   >22C8=>D935 >000F           movb    *r5+,@lt_balance(r4)
455   >22CC=>045B                 rt    
456                               
457   >22CE                   snd_track_cmd_stop:
458   >22CE=>0460 >211A           b       @snd_track_reset
460   >22D2                   snd_voice_ports
461   >22D2=>FFA2 >FFA8 >FFAE     dw      SOUND+>2, SOUND+>8, SOUND+>E, SOUND+>14
      >22D8=>FFB4             
462                               
466   >22DA                   snd_voices_init
467   >22DA=>0201 >F940           li      r1, voices
468   >22DE=>0202 >22D2           li      r2, snd_voice_ports
469   >22E2                   $0:    
470   >22E2=>0203 >8090           li      r3, >8090
471   >22E6                   $1:
472   >22E6=>04F1                 clr     *r1+        ; pv_clock
473   >22E8=>04F1                 clr     *r1+        ; pv_incr
474   >22EA=>04F1                 clr     *r1+        ; pv_hertz
475   >22EC=>04F1                 clr     *r1+        ; pv_track
476   >22EE=>CC52                 mov     *r2, *r1+   ; pv_port
477   >22F0=>CC43                 mov     r3, *r1+    ; pv_freqmask, pv_volmask
478   >22F2=>0223 >2020           ai      r3, >2020   
479   >22F6=>17F7                 jnc     $1          ; >E0F0 -> 0110
480                               
481   >22F8=>05C2                 inct    r2          ; next port
482   >22FA=>0281 >FA00           ci      r1, VOICES_END
483   >22FE=>1AF1                 jl      $0
484                               
485   >2300=>045B                 rt
486                               
498   >2302                   snd_voice_alloc
499                               PUSH    SP, 11
*** <expansion of push>
1     >2302=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >2304=>C68B                     mov  11, @(1-0-1)*2(SP)
*** sound.i
500                               
501   >2306=>C944 >0006           mov     r4, @pv_track(r5)
502   >230A=>C940 >0004           mov     r0, @pv_hertz(r5)
503   >230E=>04D5                 clr     @pv_clock(r5)
504   >2310=>C941 >0002           mov     r1, @pv_incr(r5)
506                               ; set the effects
507   >2314=>C0E5 >0008           mov     @pv_port(r5), r3
508   >2318=>D0A5 >000B           movb    @pv_volmask(r5), r2
509                               
510   >231C=>05C3                 inct    r3                  ; point to command port
511                               
512   >231E=>D4C2                 movb    r2, *r3    ; reset
513                               
514   >2320=>D064 >000B           movb    @lt_sustain(r4), r1     ; envelope on?
515   >2324=>1314                 jeq     $0+
516                               
517   >2326=>D002                 movb    r2, r0
518   >2328=>0260 >0100           ori     r0, >0100           ; envelope/sustain command
519   >232C=>D4C0                 movb    r0, *r3
521   >232E=>D8C1 >0002           movb    r1, @2(r3)          ; sustain amount
522                                   
523   >2332=>D002                 movb    r2, r0
524   >2334=>0260 >0200           ori     r0, >0200           ; envelope attack/decay command
525   >2338=>D4C0                 movb    r0, *r3
527   >233A=>D8E4 >0008 >0002     movb    @lt_a_d(r4), @2(r3) ; values
529   >2340=>D002                 movb    r2, r0
530   >2342=>0260 >0300           ori     r0, >0300           ; envelope hold/release command
531   >2346=>D4C0                 movb    r0, *r3
533   >2348=>D8E4 >0009 >0002     movb    @lt_h_r(r4), @2(r3) ; values
535   >234E                   $0:    
536   >234E=>D024 >000C           movb    @lt_vibrato(r4), r0     ; vibrato on?
537   >2352=>1306                 jeq     $0+
538                              
539   >2354=>D042                 movb    r2, r1
540   >2356=>0261 >0400           ori     r1, >0400           ; vibrato command
541   >235A=>D4C1                 movb    r1, *r3
542                               
543   >235C=>D8C0 >0002           movb    r0, @2(r3) ; values
544                                
545   >2360                   $0:    
546   >2360=>D024 >000D           movb    @lt_tremolo(r4), r0     ; tremolo on?
547   >2364=>1306                 jeq     $0+
548                              
549   >2366=>D042                 movb    r2, r1
550   >2368=>0261 >0500           ori     r1, >0500           ; tremolo command
551   >236C=>D4C1                 movb    r1, *r3
552                               
553   >236E=>D8C0 >0002           movb    r0, @2(r3) ; values
554                                
555   >2372                   $0:    
556   >2372=>D024 >000E           movb    @lt_waveform(r4), r0     ; custom waveform
557   >2376=>1306                 jeq     $0+
558                              
559   >2378=>D042                 movb    r2, r1
560   >237A=>0261 >0600           ori     r1, >0600           ; waveform command
561   >237E=>D4C1                 movb    r1, *r3
562                               
563   >2380=>D8C0 >0002           movb    r0, @2(r3) ; values
565   >2384                   $0:    
566   >2384=>D024 >000F           movb    @lt_balance(r4), r0     ; balance
567                               
568   >2388=>D042                 movb    r2, r1
569   >238A=>0261 >0900           ori     r1, >0900
570   >238E=>D4C1                 movb    r1, *r3
571                               
572   >2390=>D8C0 >0002           movb    r0, @2(r3)  ; value
573                               
574   >2394=>06A0 >23A0           bl      @snd_voice_apply2
575                               
576                               POP     SP,11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >2398=>C2FA                     mov *SP+,  11
*** sound.i
577   >239A=>045B                 rt
578                                
586   >239C                   snd_voice_apply
587   >239C=>C125 >0006           mov     @pv_track(r5), r4
588   >23A0                   snd_voice_apply2
589   >23A0=>D0A5 >000A           movb    @pv_freqmask(r5), r2
590   >23A4=>90A0 >0079           cb      #>E0, r2
591   >23A8=>1606                 jne     $0+
592                              
593                               ; noise
594   >23AA=>F0A5 >0004           socb    @pv_hertz(r5), r2
595   >23AE=>C065 >0008           mov     @pv_port(r5), r1
596   >23B2=>D442                 movb    r2, *r1
597   >23B4=>1010                 jmp     $1+
598                                 
599   >23B6                   $0:    
600   >23B6=>0200 >0001           li      r0, >1
601   >23BA=>0201 >B4F4           li      r1, >B4F4
602   >23BE=>3C25 >0004           div     @pv_hertz(r5), r0
603   >23C2=>C065 >0008           mov     @pv_port(r5), r1
604                               
605                               ; R0 is, say >3F9.  We write >89 >3F
606   >23C6=>C0C0                 mov     r0, r3
607   >23C8=>0A43                 sla     r3, 4       ; get lo byte
608   >23CA=>06C0                 swpb    r0
609   >23CC=>0240 >0F00           andi    r0, >0f00
610   >23D0=>F002                 socb    r2, r0
611   >23D2=>D440                 movb    r0, *r1
612   >23D4=>D443                 movb    r3, *r1
613   >23D6                   $1:    
614   >23D6=>D024 >000A           movb    @lt_volume(r4), r0
615                               
616   >23DA=>C0A5 >0002           mov     @pv_incr(r5), r2      ; tone voices for noise are silent
617   >23DE=>1609                 jne     $1+
618                               
619                               ; write pan for noise too
620   >23E0=>D024 >000F           movb    @lt_balance(r4), r0
621   >23E4=>D860 >29C0 >0002     movb    #>f9, @2(r1)
622   >23EA=>D840 >0004           movb    r0, @4(r1)
623                               
624   >23EE=>0200 >0F00           li      r0, >F00
625                               
626   >23F2                   $1:  
627   >23F2=>F025 >000B           socb    @pv_volmask(r5), r0
628   >23F6=>D440                 movb    r0, *r1
629   >23F8=>045B                 rt
637   >23FA                   snd_voice_tick:
638   >23FA=>C0A5 >0002           mov     @pv_incr(r5), r2      ; do nothing if inactive (or claimed by noise)
639   >23FE=>1315                 jeq     $0+
640                               
641   >2400=>A542                 a       r2, @pv_clock(r5)
642   >2402=>1713                 jnc     $1+
643                               
644                               ; end of note
645                               ; write "volume off" or key release to command port
646   >2404=>0200 >0F00           li      r0, >0F00
647   >2408=>F025 >000B           socb    @pv_volmask(r5), r0
648   >240C=>C065 >0008           mov     @pv_port(r5), r1
649   >2410=>D0A4 >000B           movb    @lt_sustain(r4), r2
650   >2414=>1301                 jeq     $2+
651                               
652   >2416=>05C1                 inct    r1          ; send key off command rather than volume off
653                               
654   >2418                   $2: 
655   >2418=>D440                 movb    r0, *r1
657   >241A=>04E5 >0006           clr     @pv_track(r5)
658                               
659                               ; was it a noise?
660   >241E=>9960 >0079 >000A     cb      #>E0, @pv_freqmask(r5)
661   >2424=>1602                 jne     $0+
662                               
663                               ; if so, the previous was ours too
664   >2426=>04E5 >FFFA           clr     @pv_track - pv_size(r5)
666   >242A                   $0:
667   >242A                   $1:
668   >242A=>045B                 rt
674   >242C                   snd_voices_tick:
675                               PUSH    SP, 4, 5, 11
*** <expansion of push>
1     >242C=>022A >FFFA           ai SP, -3*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >2430=>CA84 >0004               mov  4 , @(3-0-1)*2(SP)
2     >2434=>CA85 >0002               mov  5 , @(3-1-1)*2(SP)
3     >2438=>C68B                     mov  11, @(3-2-1)*2(SP)
*** sound.i
676   >243A=>0205 >F940           li      r5, voices
677   >243E                   $0:
678   >243E=>C125 >0006           mov     @pv_track(r5), r4
679   >2442=>1302                 jeq     $1+
680   >2444=>06A0 >23FA           bl      @snd_voice_tick
681   >2448                   $1:    
682   >2448=>0225 >000C           ai      r5, pv_size
683   >244C=>0285 >FA00           ci      r5, VOICES_END
684   >2450=>1AF6                 jl      $0
685                               POP     SP, 4, 5, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >2452=>C2FA                     mov *SP+,  11
2     >2454=>C17A                     mov *SP+,  5 
3     >2456=>C13A                     mov *SP+,  4 
*** sound.i
686   >2458=>045B                 rt
700   >245A                   snd_seq_alloc_note
701                               PUSH    SP, 11
*** <expansion of push>
1     >245A=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >245C=>C68B                     mov  11, @(1-0-1)*2(SP)
*** sound.i
702   >245E=>0205 >F940           li      r5, voices
703   >2462                   $0:
704   >2462=>0912                 srl     r2, 1           ; allowed voice?
705   >2464=>1706                 jnc     $2+
706                               
707   >2466=>C2E5 >0006           mov     @pv_track(r5), r11   ; already in use?
708   >246A=>1603                 jne     $2+
710   >246C=>06A0 >2302           bl      @snd_voice_alloc
711   >2470=>1005                 jmp     $1+
712                               
713   >2472                   $2:
714   >2472=>0225 >000C           ai      r5, pv_size
715   >2476=>0285 >FA00           ci      r5, VOICES_END
716   >247A=>1AF3                 jl      $0-
717                               
718                               ; no voice allocated
719                               
720   >247C                   $1:
721                               POP     SP, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >247C=>C2FA                     mov *SP+,  11
*** sound.i
722   >247E=>045B                 rt
735   >2480                   snd_seq_alloc_noise_voices
736                               PUSH    SP, 11
*** <expansion of push>
1     >2480=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >2482=>C68B                     mov  11, @(1-0-1)*2(SP)
*** sound.i
737                               
738   >2484=>C080                 mov     r0, r2
739   >2486=>0942                 srl     r2, 4              ; get pitch*15/16
740   >2488=>6002                 s       r2, r0
741   >248A=>0202 >4444           li      r2, >4444          ; only a voice 2
742   >248E=>C181                 mov     r1, r6             ; save length
743   >2490=>04C1                 clr     r1                 ; not a real note
744   >2492=>06A0 >245A           bl      @snd_seq_alloc_note  
746                               ; take the next voice for noise
747   >2496=>0225 >000C           ai      r5, pv_size
748                               
749   >249A=>D007                 movb    r7, r0
750   >249C=>C046                 mov     r6, r1             ; restore length
751   >249E=>0202 >8888           li      r2, >8888          ; only a noise 
752                               
753   >24A2=>06A0 >2302           bl      @snd_voice_alloc
754                               POP     SP, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >24A6=>C2FA                     mov *SP+,  11
*** sound.i
755   >24A8=>045B                 rt
756                               
763   >24AA                   snd_song_tick:
764   >24AA=>C156                 mov     @ls_phrase(6), 5
765   >24AC=>1606                 jne     $0+
766                               
767                               ; moving to next phrase
768   >24AE=>C1E6 >0002           mov     @ls_phrases(6), 7
769   >24B2=>C177                 mov     *7+, 5
770   >24B4=>C585                 mov     5, @ls_phrase(6)
771   >24B6=>C987 >0002           mov     7, @ls_phrases(6)
773                               ;...
775   >24BA                   $0:
776   >24BA=>045B                  rt   
777                               
781   >24BC                   snd_seq_tick    
782                               ;dbg
783                               PUSH    SP, 11
*** <expansion of push>
1     >24BC=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >24BE=>C68B                     mov  11, @(1-0-1)*2(SP)
*** sound.i
784                               
785   >24C0=>06A0 >242C           bl      @snd_voices_tick
786                               
787                               ; for now
788   >24C4=>06A0 >218C           bl      @snd_tracks_tick
790                               POP     SP, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >24C8=>C2FA                     mov *SP+,  11
*** sound.i
791                               ;dbgf     
792                               
793   >24CA=>045B                 rt
796                               ; step through songs and tick them
797   >24CC=>0206 >FA80           li      6, songs
798   >24D0                   $0:
799   >24D0=>C056                 mov     *6, 1
800   >24D2=>1302                 jeq     $1+
801                               
802   >24D4=>06A0 >24AA           bl      @snd_song_tick
803   >24D8                   $1:  
804   >24D8=>05C6                 inct    6
805   >24DA=>0286 >FAA0           ci      6, SONGS_END
806   >24DE=>16F8                 jne     $0-
807                               
808                               POP     SP, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >24E0=>C2FA                     mov *SP+,  11
*** sound.i
809                               ;dbgf     
810                               
811   >24E2=>045B                 rt
813   >24E4                   snd_seq_init
814                               ;dbg
815                               PUSH    SP, 11
*** <expansion of push>
1     >24E4=>064A                 ai SP, -1*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >24E6=>C68B                     mov  11, @(1-0-1)*2(SP)
*** sound.i
816   >24E8=>06A0 >20E6           bl      @snd_tracks_init
817   >24EC=>06A0 >22DA           bl      @snd_voices_init
818                                   
819   >24F0=>0200 >2644           li      r0, test_track
820                               ;mov     r0, @tracks + lt_cmdptr         ;;; auto start
821                               
822                               POP     SP, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >24F4=>C2FA                     mov *SP+,  11
*** sound.i
823                               ;dbgf
824   >24F6=>045B                 rt
826                            Vector sound_sequencer, vidws
*** <expansion of vector>
1     >24F8                   sound_sequencer  data vidws, sound_sequencer_entry
      >24F8=>FC60 >24FC       
2     >24FC                   sound_sequencer_entry:    
*** sound.i
827   >24FC=>020A >F740           li      SP, vstack + vstacksize
828   >2500=>06A0 >24BC           bl      @snd_seq_tick
829   >2504=>0380                 rtwp    
835   >2506                   xsnd_queue_track:
836                               PUSH    SP, 4, 11
*** <expansion of push>
1     >2506=>022A >FFFC           ai SP, -2*2
2                                 foreach REG, IDX {
*** <expansion of foreach>
1     >250A=>CA84 >0002               mov  4 , @(2-0-1)*2(SP)
2     >250E=>C68B                     mov  11, @(2-1-1)*2(SP)
*** sound.i
837   >2510=>0204 >FA00           li      4, tracks
838   >2514                   $0:
839   >2514=>C514                 mov     @lt_cmdptr(4), @lt_cmdptr(4)
840   >2516=>1308                 jeq     $1+
842   >2518=>0224 >0010           ai      4, lt_size
843   >251C=>0284 >FA80           ci      4, TRACKS_END
844   >2520=>1AF9                 jl      $0
845   >2522                   $2:
846                               POP     SP, 4, 11
*** <expansion of pop>
1                                 foreach - REG, IDX {
*** <expansion of foreach>
1     >2522=>C2FA                     mov *SP+,  11
2     >2524=>C13A                     mov *SP+,  4 
*** sound.i
847   >2526=>045B                 rt
848   >2528                   $1:
849                               ; assign
850   >2528=>0200 >1E00           li      r0, 30 * 256
851   >252C=>06A0 >2132           bl      @snd_track_tempo_to_incr
852                               
853   >2530=>06A0 >2106           bl      @snd_track_init    
854   >2534=>10F6                 jmp     $2-
855                              
856                               
857   >2536                   test_track0:
858   >2536=>0010 >28           db      >00, 16,  >28
859   >2539=  >00 >1010 >400A     db      >00, 16,  >10, >40, 10
860   >253E=>0010 >1044 >0A     db      >00, 16,  >10, >44, 10
861   >2543=  >00 >1010 >470A     db      >00, 16,  >10, >47, 10
862   >2548=>0040 >1040 >3C10     db      >00, 64,  >10, >40, 60,  >10, >44, 60,  >10, >47, 60,  >10, >50, 60
      >254E=>443C >1047 >3C10 
      >2554=>503C             
863   >2556=>0010                 db      >00, 16
864   >2558=>0001 >4028           db      >00, 1,   >40, 40
865   >255C=>000F >1000 >0F10     db      >00, 15,  >10, >00, 15,     >10, >10, 15
      >2562=>100F             
866   >2564=>000F >1003 >0F10     db      >00, 15,  >10, >03, 15,     >10, >13, 15
      >256A=>130F             
867   >256C=>000F >1005 >0F10     db      >00, 15,  >10, >05, 15,     >10, >15, 15
      >2572=>150F             
868   >2574=>000F >1007 >0F10     db      >00, 15,  >10, >07, 15,     >10, >17, 15
      >257A=>170F             
869   >257C=>000F >1009 >0F10     db      >00, 15,  >10, >09, 15,     >10, >19, 15
      >2582=>190F             
870   >2584=>000F >100B >0F10     db      >00, 15,  >10, >0B, 15,     >10, >1B, 15
      >258A=>1B0F             
871   >258C=>000F >1011 >0F10     db      >00, 15,  >10, >11, 15,     >10, >21, 15
      >2592=>210F             
872   >2594=>000F >1014 >0F10     db      >00, 15,  >10, >14, 15,     >10, >24, 15
      >259A=>240F             
873   >259C=>000F >1017 >0F10     db      >00, 15,  >10, >17, 15,     >10, >27, 15
      >25A2=>270F             
874   >25A4=>000F >101A >0F10     db      >00, 15,  >10, >1A, 15,     >10, >2A, 15
      >25AA=>2A0F             
875   >25AC=>000F >1022 >0F10     db      >00, 15,  >10, >22, 15,     >10, >32, 15
      >25B2=>320F             
876   >25B4=>000F >1025 >0F10     db      >00, 15,  >10, >25, 15,     >10, >35, 15
      >25BA=>350F             
877   >25BC=>000F >1028 >0F10     db      >00, 15,  >10, >28, 15,     >10, >38, 15
      >25C2=>380F             
878   >25C4=>000F >1030 >0F10     db      >00, 15,  >10, >30, 15,     >10, >40, 15
      >25CA=>400F             
879   >25CC=>000F >1033 >0F10     db      >00, 15,  >10, >33, 15,     >10, >43, 15
      >25D2=>430F             
880   >25D4=>0000                 db      >00, 0
882   >25D6                   test_track1:
883   >25D6=>0010 >2F40 >FF     db      >00, 16, >2F, >40, 255
884   >25DB                   tt0:    
885   >25DB=  >00 >0110 >4020     db      >00, 1, >10, >40, 32,  >10, >50, 32,  >10, >60, 32 
      >25E0=>1050 >2010 >6020 
886   >25E6=>0001 >2E           db      >00, 1, >2E
887   >25E9=  >00 >012D           db      >00, 1, >2D
888   >25EC=>0001 >2C           db      >00, 1, >2C
889   >25EF=  >00 >012B           db      >00, 1, >2B
890   >25F2=>0001 >2A           db      >00, 1, >2A
891   >25F5=  >00 >0129           db      >00, 1, >29
892   >25F8=>0001 >28           db      >00, 1, >28
893   >25FB=  >00 >0127           db      >00, 1, >27
894   >25FE=>0001 >26           db      >00, 1, >26
895   >2601=  >00 >0125           db      >00, 1, >25
896   >2604=>0001 >24           db      >00, 1, >24
897   >2607=  >00 >0123           db      >00, 1, >23
898   >260A=>0001 >22           db      >00, 1, >22
899   >260D=  >00 >0121           db      >00, 1, >21
900   >2610=>0001 >20           db      >00, 1, >20
901   >2613=  >00 >0121           db      >00, 1, >21
902   >2616=>0001 >22           db      >00, 1, >22
903   >2619=  >00 >0123           db      >00, 1, >23
904   >261C=>0001 >24           db      >00, 1, >24
905   >261F=  >00 >0125           db      >00, 1, >25
906   >2622=>0001 >26           db      >00, 1, >26
907   >2625=  >00 >0127           db      >00, 1, >27
908   >2628=>0001 >28           db      >00, 1, >28
909   >262B=  >00 >0129           db      >00, 1, >29
910   >262E=>0001 >2A           db      >00, 1, >2A
911   >2631=  >00 >012B           db      >00, 1, >2B
912   >2634=>0001 >2C           db      >00, 1, >2C
913   >2637=  >00 >012D           db      >00, 1, >2D
914   >263A=>0001 >2E           db      >00, 1, >2E
915   >263D=  >00 >012F           db      >00, 1, >2F
916   >2640=>0001 >E0           db      >00, 1, >E0
917   >2643=>99                 db      tt0 - $ + 1
918                               
919   >2644                   test_track:
920                               ; track volume = 8, ADSR = ...
921   >2644=>0010 >2840 >20     db      >00, 16 ,  >28 ,  >40, 32
922   >2649=  >38 >332D >5044     db		  	>38,  >33, >2D ,  >50, >44 , >60, >44 ;
      >264E=>6044             
923   >2650=>7110 >2004           db			>71, >10, >20, 4
924   >2654=>0010                 db      >00, 16 
925   >2656=>0010 >1030 >08     db      >00, 16, >10, >30, 8
926   >265B=  >00 >10           db      >00, 16 
927   >265D=  >00 >1010 >4010     db      >00, 16, >10, >40, 16
928   >2662=>0010                 db      >00, 16 
929   >2664=>0020 >1051 >20     db      >00, 32, >10, >51, 32
930   >2669=  >00 >10           db      >00, 16
931   >266B=  >00 >4010 >6240     db      >00, 64, >10, >62, 64
932   >2670=>0010 >9080           db      >00, 16,   >90, >80
933   >2674=>0019 >1000 >0F10     db      >00, 25,  >10, >00, 15,     >10, >10, 15,   >90, >98
      >267A=>100F >9098       
934   >267E=>0019 >1003 >0F10     db      >00, 25,  >10, >03, 15,     >10, >13, 15
      >2684=>130F             
935   >2686=>0019 >1005 >0F10     db      >00, 25,  >10, >05, 15,     >10, >15, 15,   >90, >b0
      >268C=>150F >90B0       
936   >2690=>0019 >1007 >0F10     db      >00, 25,  >10, >07, 15,     >10, >17, 15,    >40, 40
      >2696=>170F >4028       
937   >269A=>0019 >1009 >0F10     db      >00, 25,  >10, >09, 15,     >10, >19, 15,   >90, >c0
      >26A0=>190F >90C0       
938   >26A4=>0019 >100B >0F10     db      >00, 25,  >10, >0B, 15,     >10, >1B, 15
      >26AA=>1B0F             
939   >26AC=>0019 >1011 >0F10     db      >00, 25,  >10, >11, 15,     >10, >21, 15,     >40, 48,   >90, >f0
      >26B2=>210F >4030 >90F0 
940   >26B8=>0019 >1014 >0F10     db      >00, 25,  >10, >14, 15,     >10, >24, 15
      >26BE=>240F             
941   >26C0=>0019 >1017 >0F10     db      >00, 25,  >10, >17, 15,     >10, >27, 15,   >90, >00
      >26C6=>270F >9000       
942   >26CA=>0019 >101A >0F10     db      >00, 25,  >10, >1A, 15,     >10, >2A, 15,    >40, 52    
      >26D0=>2A0F >4034       
943   >26D4=>0019 >1022 >0F10     db      >00, 25,  >10, >22, 15,     >10, >32, 15,   >90, >20
      >26DA=>320F >9020       
944   >26DE=>0019 >1025 >0F10     db      >00, 25,  >10, >25, 15,     >10, >35, 15
      >26E4=>350F             
945   >26E6=>0019 >1028 >0F10     db      >00, 25,  >10, >28, 15,     >10, >38, 15,    >40, 60,   >90, >30
      >26EC=>380F >403C >9030 
946   >26F2=>0019 >1030 >0F10     db      >00, 25,  >10, >30, 15,     >10, >40, 15,   >90, >40
      >26F8=>400F >9040       
947   >26FC=>0019 >1033 >0F10     db      >00, 25,  >10, >33, 15,     >10, >43, 15
      >2702=>430F             
948   >2704=>0019 >1036 >0F10     db      >00, 25,  >10, >36, 15,     >10, >46, 15,    >40, 64,   >90, >50
      >270A=>460F >4040 >9050 
949   >2710=>0019 >1039 >0F10     db      >00, 25,  >10, >39, 15,     >10, >49, 15
      >2716=>490F             
950   >2718=>0019 >103B >0F10     db      >00, 25,  >10, >3B, 15,     >10, >4B, 15,   >90, >60
      >271E=>4B0F >9060       
951   >2722=>0019 >1042 >0F10     db      >00, 25,  >10, >42, 15,     >10, >52, 15,    >40, 68,   >90, >70
      >2728=>520F >4044 >9070 
952   >272E=>0019 >1045 >0F10     db      >00, 25,  >10, >45, 15,     >10, >55, 15,   >90, >7f
      >2734=>550F >907F       
953   >2738=>0019 >1048 >0F10     db      >00, 25,  >10, >48, 15,     >10, >58, 15
      >273E=>580F             
954   >2740=>0000                 db      >00, >00
955                               
956   >2742                   test_track4:
957                               ; track volume = 8, ADSR = ...
958   >2742=>0010 >2040 >20     db      >00, 16,  >20,  >40, 32  
959   >2747=  >38 >D42C           db       >38, >D4, >2C  
960   >274A=>5044 >6044           db       >50, >44 , >60, >44 ;
961   >274E                   tt1:    
962                              
963   >274E=>000A >7010 >350F     db      >00, 10,  >70,  >10, >35, 15  ;,     >10, >45, 15
964   >2754=>000A >1043 >0F10     db      >00, 10,  >10, >43, 15,     >10, >33, 15
      >275A=>330F             
965   >275C=>000F >1048 >0F       db      >00, 15,  >10, >48, 15
966   >2761=  >00 >0F10 >530F     db      >00, 15,  >10, >53, 15
967   >2766=>000F >1058 >0F     db      >00, 15,  >10, >58, 15
968   >276B=  >00 >0F10 >630F     db      >00, 15,  >10, >63, 15
969   >2770=>000F >1068 >0F     db      >00, 15,  >10, >68, 15
970   >2775=  >00 >0F10 >730F     db      >00, 15,  >10, >73, 15
971   >277A=>0014                 db      >00, 20
973   >277C=>000A >7410 >350F      db      >00, 10,  >74,  >10, >35, 15  ;,     >10, >45, 15
974   >2782=>000A >1043 >0F10     db      >00, 10,  >10, >43, 15,     >10, >53, 15
      >2788=>530F             
975   >278A=>000F >1048 >0F       db      >00, 15,  >10, >48, 15
976   >278F=  >00 >0F10 >530F     db      >00, 15,  >10, >53, 15
977   >2794=>000F >1058 >0F     db      >00, 15,  >10, >58, 15
978   >2799=  >00 >0F10 >630F     db      >00, 15,  >10, >63, 15
979   >279E=>000F >1068 >0F     db      >00, 15,  >10, >68, 15
980   >27A3=  >00 >0F10 >730F     db      >00, 15,  >10, >73, 15
981   >27A8=>0014                 db      >00, 20
982                               
983                               
984                            
985   >27AA=>000A >7110 >350F       db      >00, 10,  >71,  >10, >35, 15  ;,     >10, >45, 15
986   >27B0=>000A >1043 >0F10     db      >00, 10,  >10, >43, 15,     >10, >53, 15
      >27B6=>530F             
987   >27B8=>000F >1048 >0F       db      >00, 15,  >10, >48, 15
988   >27BD=  >00 >0F10 >530F     db      >00, 15,  >10, >53, 15
989   >27C2=>000F >1058 >0F     db      >00, 15,  >10, >58, 15
990   >27C7=  >00 >0F10 >630F     db      >00, 15,  >10, >63, 15
991   >27CC=>000F >1068 >0F     db      >00, 15,  >10, >68, 15
992   >27D1=  >00 >0F10 >730F     db      >00, 15,  >10, >73, 15
993   >27D6=>0014                 db      >00, 20
994                               
995                               
996                            
997   >27D8=>000A >7610 >350F    db      >00, 10,  >76,  >10, >35, 15  ;,     >10, >45, 15
998   >27DE=>000A >1043 >0F10     db      >00, 10,  >10, >43, 15,     >10, >33, 15
      >27E4=>330F             
999   >27E6=>000F >1048 >0F       db      >00, 15,  >10, >48, 15
1000  >27EB=  >00 >0F10 >530F     db      >00, 15,  >10, >53, 15
1001  >27F0=>000F >1058 >0F     db      >00, 15,  >10, >58, 15
1002  >27F5=  >00 >0F10 >630F     db      >00, 15,  >10, >63, 15
1003  >27FA=>000F >1068 >0F     db      >00, 15,  >10, >68, 15
1004  >27FF=  >00 >0F10 >730F     db      >00, 15,  >10, >73, 15
1005  >2804=>0014                 db      >00, 20
1006                              
1007  >2806=>000A >7210 >350F   db      >00, 10,  >72,  >10, >35, 15  ;,     >10, >45, 15
1008  >280C=>000A >1043 >0F10     db      >00, 10,  >10, >43, 15,     >10, >33, 15
      >2812=>330F             
1009  >2814=>000F >1048 >0F       db      >00, 15,  >10, >48, 15
1010  >2819=  >00 >0F10 >530F     db      >00, 15,  >10, >53, 15
1011  >281E=>000F >1058 >0F     db      >00, 15,  >10, >58, 15
1012  >2823=  >00 >0F10 >630F     db      >00, 15,  >10, >63, 15
1013  >2828=>000F >1068 >0F     db      >00, 15,  >10, >68, 15
1014  >282D=  >00 >0F10 >730F     db      >00, 15,  >10, >73, 15
1015  >2832=>0014                 db      >00, 20    
1017                           
1018                              
1019  >2834=>000A >7310 >350F     db      >00, 10,  >73,  >10, >35, 15  ;,     >10, >45, 15
1020  >283A=>000A >1043 >0F10     db      >00, 10,  >10, >43, 15,     >10, >53, 15
      >2840=>530F             
1021  >2842=>000F >1048 >0F       db      >00, 15,  >10, >48, 15
1022  >2847=  >00 >0F10 >530F     db      >00, 15,  >10, >53, 15
1023  >284C=>000F >1058 >0F     db      >00, 15,  >10, >58, 15
1024  >2851=  >00 >0F10 >630F     db      >00, 15,  >10, >63, 15
1025  >2856=>000F >1068 >0F     db      >00, 15,  >10, >68, 15
1026  >285B=  >00 >0F10 >730F     db      >00, 15,  >10, >73, 15
1027  >2860=>0014                 db      >00, 20    
1028                            
1029  >2862=>000A >7510 >350F     db      >00, 10,  >75,  >10, >35, 15  ;,     >10, >45, 15
1030  >2868=>000A >1043 >0F10     db      >00, 10,  >10, >43, 15,     >10, >53, 15
      >286E=>530F             
1031  >2870=>000F >1048 >0F       db      >00, 15,  >10, >48, 15
1032  >2875=  >00 >0F10 >530F     db      >00, 15,  >10, >53, 15
1033  >287A=>000F >1058 >0F     db      >00, 15,  >10, >58, 15
1034  >287F=  >00 >0F10 >630F     db      >00, 15,  >10, >63, 15
1035  >2884=>000F >1068 >0F     db      >00, 15,  >10, >68, 15
1036  >2889=  >00 >0F10 >730F     db      >00, 15,  >10, >73, 15
1037  >288E=>0014                 db      >00, 20
1038                              
1039  >2890=>000A >7710 >350F     db      >00, 10,  >77,  >10, >35, 15  ;,     >10, >45, 15
1040  >2896=>000A >1043 >0F10     db      >00, 10,  >10, >43, 15,     >10, >33, 15
      >289C=>330F             
1041  >289E=>000F >1048 >0F       db      >00, 15,  >10, >48, 15
1042  >28A3=  >00 >0F10 >530F     db      >00, 15,  >10, >53, 15
1043  >28A8=>000F >1058 >0F     db      >00, 15,  >10, >58, 15
1044  >28AD=  >00 >0F10 >630F     db      >00, 15,  >10, >63, 15
1045  >28B2=>000F >1068 >0F     db      >00, 15,  >10, >68, 15
1046  >28B7=  >00 >0F10 >730F     db      >00, 15,  >10, >73, 15
1047  >28BC=>0014                 db      >00, 20
1048                              
1049  >28BE=>0001 >E0           db      >00, 01, >E0
1050  >28C1=>8C                 db      tt1 - $ - 1
1051  >28C2=>0000                 db      >00, >00
1052  >28C4                       even
1053                                  
1054  >28C4                   test_track5:
1055  >28C4=>0010 >2840 >20     db      >00, 16,  >28,  >40, 32
1056                              ;db      >00, 25,  >10, >00, 15
1057                              ;db      >00, 25,  >10, >04, 15
1058                              ;db      >00, 25,  >10, >08, 15
1059                              
1060                              ;db       >60, >44
1061  >28C9=  >38 >233A           db       >38, >23, >3A
1062                              
1063  >28CC=>0008 >1413 >01     db      >00, 8,  >14, >13, 1
1064                              ;db      >00, 8,  >14, >13, 1
1065                              ;db      >00, 8,  >14, >13, 1
1066                              ;db      >00, 8,  >14, >13, 1
1067  >28D1=  >00 >0814 >2501     db      >00, 8,  >14, >25, 1
1068                              ;db      >00, 8,  >14, >25, 1
1069                              ;db      >00, 8,  >14, >25, 1
1070                              ;db      >00, 8,  >14, >25, 1
1071  >28D6=>0008 >1435 >01     db      >00, 8,  >14, >35, 1
1072                              ;db      >00, 8,  >14, >35, 1
1073                              ;db      >00, 8,  >14, >35, 1
1074                              ;db      >00, 8,  >14, >35, 1
1075  >28DB=  >00 >19           db      >00, 25
1076  >28DD=  >00 >0815 >5305     db      >00, 8,  >15, >53, 5
1077  >28E2=>0008 >1643 >05     db      >00, 8,  >16, >43, 5
1078  >28E7=  >00 >0817 >3305     db      >00, 8,  >17, >33, 5
1079                              
1080  >28EC=>0008 >1853 >01     db      >00, 8,  >18, >53, 1
1081  >28F1=  >00 >0818 >5302     db      >00, 8,  >18, >53, 2
1082  >28F6=>0008 >1853 >03     db      >00, 8,  >18, >53, 3
1083  >28FB=  >00 >0818 >5304     db      >00, 8,  >18, >53, 4
1084  >2900=>0008 >1863 >01     db      >00, 8,  >18, >63, 1
1085  >2905=  >00 >0818 >6302     db      >00, 8,  >18, >63, 2
1086  >290A=>0008 >1863 >03     db      >00, 8,  >18, >63, 3
1087  >290F=  >00 >0818 >6304     db      >00, 8,  >18, >63, 4
1088  >2914=>0008 >1873 >01     db      >00, 8,  >18, >73, 1
1089  >2919=  >00 >0818 >7302     db      >00, 8,  >18, >73, 2
1090  >291E=>0008 >1873 >03     db      >00, 8,  >18, >73, 3
1091  >2923=  >00 >0818 >7304     db      >00, 8,  >18, >73, 4
1092  >2928=>0019                 db      >00, 25
1093  >292A=>0000                 db      >00, >00
1094  >292C                              even
1095                               
1096                               ; good snareish      
1097                              ;db       >34, >14, >88
1098                              ; db      >00, 8,  >18, >83, 2
1101                                  
*** nforth.tsm
518   >292C                   reset:   limi	0
      >292C=>0300 >0000       
519                               ;   clear memory
520   >2930=>06A0 >0250           bl      @clr
521   >2934=>F780 >0320           data    _RAMSTART, _RAMEND - _RAMSTART
522                            #if ENHANCED_MEMORY
523                            #else    
528   >2938=>06A0 >025C       	bl	@sinit			; system init
529   >293C=>06A0 >203C           bl  @sndinit        ; sound init
530   >2940=>06A0 >032C       	bl	@vinit			; video init
531   >2944=>06A0 >18B2       	bl	@kinit			; keyboard init
532   >2948=>06A0 >1CA4       	bl	@dinit			; device init
534   >294C=>06A0 >1DAE       	bl	@diskinit		; disk init
536   >2950                   boot:	clr	12
      >2950=>04CC             
537   >2952=>1E00             	sbz	0			; Interrupt mode
538   >2954=>1D01             	sbo	1			; Enable external interrupts
539   >2956=>1D02             	sbo	2			; Enable VDP interrupts
540   >2958=>1E03             	sbz	3			; Disable clock interrupts
542                            #if ENHANCED_MEMORY
543                            
544                            #else
559   >295A                   boot0:
560                           	; see if we have GROM extension
561   >295A=>0200 >6000       	li 0, >6000
562   >295E=>06A0 >044A       	bl @gwaddr
564   >2962=>06A0 >296A       	bl @copyram
566   >2966                   boot1:
567   >2966=>0460 >0060       	b	@FORTH_COLD
576   >296A                   copyram 
577   >296A=>0300 >0000           limi 0
578   >296E=>0203 >FF90           li  3, GPLRD
579   >2972                   cr0:    
580   >2972=>D013             	movb *3, 0
581   >2974=>06C0             	swpb 0
582   >2976=>D013             	movb *3, 0
583   >2978=>06C0             	swpb 0			; R1 = start addr in RAM
584   >297A=>0280 >AA55       	ci 0, >aa55
585   >297E=>1610             	jne cr1			; no GROM block
587   >2980=>D053             	movb *3, 1
588   >2982=>06C1             	swpb 1
589   >2984=>D053             	movb *3, 1
590   >2986=>06C1             	swpb 1			; R1 = start addr in RAM
592   >2988=>D093             	movb *3, 2
593   >298A=>06C2             	swpb 2
594   >298C=>D093             	movb *3, 2
595   >298E=>06C2             	swpb 2			; R2 = end addr in RAM
597   >2990=>0221 >0006       	ai 1, 6
598   >2994=>1002             	jmp cr3
600                           	;	copy data into RAM
601   >2996                   cr2:
602   >2996=>DC53             	movb *3, *1+
603   >2998=>DC53             	movb *3, *1+
604   >299A                   cr3:
605   >299A=>8081             	c 1, 2
606   >299C=>1AFC             	jl cr2
608   >299E=>10E9             	jmp cr0
610   >29A0                   cr1:
611   >29A0=>0300 >0001           limi 1
612   >29A4=>045B             	rt
619   >29A6                   dieerr:	bl	@type
      >29A6=>06A0 >1C78       
620   >29AA=>10FF             	jmp	$
622   >29AC=>FC40 >0070 >F786 	consttable
      >29B2=>0060 >0808 >1F00 
      >29B8=>00C0 >1E03 >0168 
      >29BE=>0E10 >F900       
624   >29C2                   the_end equ $
